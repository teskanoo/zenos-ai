# script.zen_dojotools_volume_redirector
alias: Zen DojoTools Volume Redirector
description: >
  DojoTools Volume Redirector — ZENOS Edition (v3.9.8 RC1)
  Clean switchboard redirector for canonical Ring-0 ZENOS cabinets only.
  No legacy handling. No cross-namespace routing. Strict ZENOS core volumes.

triggers:
  - trigger: event
    event_type: set_variable_legacy
    id: set
  - trigger: event
    event_type: remove_variable_legacy
    id: remove
  - trigger: event
    event_type: clear_variable_legacy
    id: clear
  - trigger: event
    event_type: dojo_volume_redirector_probe
    id: probe

conditions: []

actions:
  - variables:
      # ========================================================
      # CANONICAL RING-0 ZENOS CABINETS ONLY
      # ========================================================

      # SYSTEM (6)
      vol_system: sensor.zenos_system_cabinet
      vol_system_history: sensor.zenos_system_history_cabinet
      vol_dojo: sensor.zenos_zen_dojo_cabinet
      vol_kata: sensor.zenos_zen_kata_cabinet
      vol_history: sensor.zenos_zen_history_cabinet
      vol_scratch: sensor.zenos_zen_scratchpad_cabinet

      # DEFAULT HOUSEHOLD (2)
      vol_household: sensor.zenos_default_household_cabinet
      vol_household_history: sensor.zenos_default_household_history_cabinet

      # DEFAULT FAMILY (2)
      vol_family: sensor.zenos_default_family_cabinet
      vol_family_history: sensor.zenos_default_family_history_cabinet

      # DEFAULT USER (2)
      vol_user: sensor.zenos_default_user_cabinet
      vol_user_history: sensor.zenos_default_user_history_cabinet

      # DEFAULT AI USER (2)
      vol_ai_user: sensor.zenos_default_ai_user_cabinet
      vol_ai_user_history: sensor.zenos_default_ai_user_history_cabinet

      # RECOGNIZED RING-0 ZENOS VOLUMES
      recognized_volumes: |
        {{
          [
            vol_system,
            vol_system_history,
            vol_dojo,
            vol_kata,
            vol_history,
            vol_scratch,
            vol_household,
            vol_household_history,
            vol_family,
            vol_family_history,
            vol_user,
            vol_user_history,
            vol_ai_user,
            vol_ai_user_history
          ]
        }}

      # Manifest / metadata access
      manifest_key: zen_library_manifest
      manifest_entity: sensor.zenos_default_household_cabinet
      manifest_data: >
        {{
          (
            state_attr(manifest_entity, 'variables')
            | default({})
          ).get(manifest_key, {})
          .get('value', {})
        }}

      # Incoming event data
      event_type: "{{ trigger.event.event_type }}"
      key: "{{ trigger.event.data.key | default('') }}"
      value: "{{ trigger.event.data.value | default('') }}"
      volume_entity: "{{ trigger.event.data.volume_entity | default('') }}"
      set_timestamp: "{{ trigger.event.data.set_timestamp | default(false) }}"
      log_events: "{{ trigger.event.data.log_events | default(false) }}"

      # Manifest → volume entry
      manifest_volume_entry: >
        {% set md = manifest_data if manifest_data is mapping else {} %}
        {{ md.get(volume_entity | string, {}) }}

      manifest_metadata: "{{ manifest_volume_entry.get('metadata', {}) }}"
      manifest_flags: "{{ manifest_metadata.get('flags', {}) }}"
      manifest_guid: >
        {% if manifest_metadata.get('id') %}
          {{ manifest_metadata.get('id') }}
        {% else %}
          ''
        {% endif %}

      # Cabinet → info
      cabinet_info: >
        {% set vars = state_attr(volume_entity, 'variables') | default({}, true) %}
        {% set entry = vars.get('AI_Cabinet_VolumeInfo', {}) %}
        {{ entry if entry is mapping else {} }}

      cabinet_info_value: "{{ cabinet_info.get('value', {}) }}"
      cabinet_guid: >
        {% if cabinet_info_value.get('id') %}
          {{ cabinet_info_value.get('id') }}
        {% else %}
          ''
        {% endif %}

      guid_mismatch: "{{ manifest_guid and cabinet_guid and (manifest_guid != cabinet_guid) }}"

      # Canonical fallback-friendly name mapping
      canonical_volume_name: >
        {% set fn = (state_attr(volume_entity, 'friendly_name') | default('', true)) | string %}
        {% if fn|lower not in ['unknown','unavailable','none','null',''] %}
          {{ fn }}
        {% else %}
          {{ volume_entity | replace('sensor.','') }}
        {% endif %}

      routing_status: pending
      routing_action: none
      routed_volume: "{{ volume_entity }}"

  # -------------------------------------------------------------
  # Optional logging
  # -------------------------------------------------------------
  - alias: Log?
    if:
      - condition: template
        value_template: "{{ log_events }}"
    then:
      - action: logbook.log
        data:
          name: "{{ event_type }}"
          message: >
            {{ key | default('-') }}
            {% if event_type == 'set_variable_legacy' %}
              : {{ value | default('not defined!') }}
            {% endif %}

  # -------------------------------------------------------------
  # PROBE HANDLER
  # -------------------------------------------------------------
  - alias: Handle probe
    choose:
      - conditions:
          - condition: trigger
            id: probe
        sequence:
          - event: dojo_volume_redirector_probe_result
            event_data:
              status: >
                {% if volume_entity and volume_entity in recognized_volumes %}
                  {% if guid_mismatch %}warning{% else %}ready{% endif %}
                {% else %}
                  error
                {% endif %}
              volume_entity: "{{ volume_entity }}"
              volume_name: "{{ canonical_volume_name }}"
              key: "{{ key }}"
              manifest_entry_found: "{{ manifest_volume_entry != {} }}"
              recognized_volume: "{{ volume_entity in recognized_volumes }}"
              manifest_guid: "{{ manifest_guid }}"
              cabinet_guid: "{{ cabinet_guid }}"
              guid_mismatch: "{{ guid_mismatch }}"
              failure_reason: >
                {% if not volume_entity %}missing_volume_entity
                {% elif volume_entity not in recognized_volumes %}volume_not_recognized
                {% elif manifest_volume_entry == {} %}volume_missing_from_manifest
                {% elif guid_mismatch %}guid_mismatch
                {% else %}ok{% endif %}
          - stop: Probe Finished

  # -------------------------------------------------------------
  # VALIDATION (unchanged)
  # -------------------------------------------------------------
  - alias: Validate
    choose:
      - conditions:
          - condition: template
            value_template: "{{ volume_entity | trim == '' }}"
        sequence:
          - event: dojo_volume_redirector_result
            event_data:
              status: error
              failure: missing_volume_entity
              volume_entity: "{{ volume_entity }}"
              volume_name: "{{ canonical_volume_name }}"
              event_type: "{{ event_type }}"
              key: "{{ key }}"
          - stop: Validation Failed

      - conditions:
          - condition: template
            value_template: "{{ volume_entity not in recognized_volumes }}"
        sequence:
          - event: dojo_volume_redirector_result
            event_data:
              status: error
              failure: volume_not_recognized
              volume_entity: "{{ volume_entity }}"
              volume_name: "{{ canonical_volume_name }}"
              event_type: "{{ event_type }}"
              key: "{{ key }}"
          - stop: Validation Failed

      - conditions:
          - condition: template
            value_template: "{{ manifest_volume_entry == {} }}"
        sequence:
          - event: dojo_volume_redirector_result
            event_data:
              status: error
              failure: volume_missing_from_manifest
              volume_entity: "{{ volume_entity }}"
              volume_name: "{{ canonical_volume_name }}"
              event_type: "{{ event_type }}"
              manifest_guid: "{{ manifest_guid }}"
              key: "{{ key }}"
          - stop: Validation Failed

      - conditions:
          - condition: template
            value_template: "{{ event_type in ['set_variable_legacy','remove_variable_legacy'] }}"
          - condition: template
            value_template: "{{ key | trim == '' }}"
        sequence:
          - event: dojo_volume_redirector_result
            event_data:
              status: error
              failure: missing_key
              event_type: "{{ event_type }}"
              volume_entity: "{{ volume_entity }}"
              volume_name: "{{ canonical_volume_name }}"
          - stop: Validation Failed

  # -------------------------------------------------------------
  # ROUTING LOGIC BLOCKS FOR ALL 14 ZENOS CABINETS
  # (unchanged structure; only event names updated)
  # -------------------------------------------------------------
  - choose:
      # ============================
      # SYSTEM
      # ============================
      - conditions: "{{ volume_entity == vol_system }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_system_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_system_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_system_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      - conditions: "{{ volume_entity == vol_system_history }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_system_history_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_system_history_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_system_history_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      # ============================
      # DOJO + KATA + HISTORY + SCRATCHPAD
      # ============================
      - conditions: "{{ volume_entity == vol_dojo }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_zen_dojo_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_zen_dojo_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_zen_dojo_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      - conditions: "{{ volume_entity == vol_kata }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_zen_kata_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_zen_kata_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_zen_kata_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      - conditions: "{{ volume_entity == vol_history }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_zen_history_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_zen_history_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_zen_history_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      - conditions: "{{ volume_entity == vol_scratch }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_zen_scratchpad_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_zen_scratchpad_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_zen_scratchpad_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      # ============================
      # HOUSEHOLD (2)
      # ============================
      - conditions: "{{ volume_entity == vol_household }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_default_household_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_default_household_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_default_household_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      - conditions: "{{ volume_entity == vol_household_history }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_default_household_history_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_default_household_history_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_default_household_history_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      # ============================
      # FAMILY (2)
      # ============================
      - conditions: "{{ volume_entity == vol_family }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_default_family_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_default_family_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_default_family_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      - conditions: "{{ volume_entity == vol_family_history }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_default_family_history_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_default_family_history_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_default_family_history_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      # ============================
      # USER (2)
      # ============================
      - conditions: "{{ volume_entity == vol_user }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_default_user_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_default_user_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_default_user_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      - conditions: "{{ volume_entity == vol_user_history }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_default_user_history_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_default_user_history_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_default_user_history_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      # ============================
      # AI USER (2)
      # ============================
      - conditions: "{{ volume_entity == vol_ai_user }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_default_ai_user_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_default_ai_user_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_default_ai_user_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      - conditions: "{{ volume_entity == vol_ai_user_history }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.id == 'set' }}"
                sequence:
                  - event: set_variable_zenos_default_ai_user_history_cabinet
                    event_data:
                      key: "{{ key }}"
                      value: "{{ value }}"
                      set_timestamp: "{{ set_timestamp }}"
              - conditions: "{{ trigger.id == 'remove' }}"
                sequence:
                  - event: remove_variable_zenos_default_ai_user_history_cabinet
                    event_data:
                      key: "{{ key }}"
              - conditions: "{{ trigger.id == 'clear' }}"
                sequence:
                  - event: clear_variables_zenos_default_ai_user_history_cabinet
                    event_data:
                      key: "{{ key }}"
          - variables:
              routing_status: success
              routing_action: "{{ trigger.id }}"
              routed_volume: "{{ volume_entity }}"

      # ============================
      # DEFAULT — unmatched
      # ============================
      - default:
          - sequence:
            - event: dojo_volume_redirector_result
              event_data:
                status: error
                failure: unmatched_volume_route
                event_type: "{{ event_type }}"
                volume_entity: "{{ volume_entity }}"
                volume_name: "{{ canonical_volume_name }}"
                key: "{{ key }}"
                set_timestamp: "{{ set_timestamp }}"
            - variables:
                routing_status: error
                routing_action: none
                final_response:
                  status: error
                  message: |
                    Target volume {{ volume_entity }} not found.
            - stop: Target Volume Not Found
              response_variable: final_response

  # -------------------------------------------------------------
  # Emit success telemetry
  # -------------------------------------------------------------
  - alias: Emit Success
    if:
      - condition: template
        value_template: "{{ routing_status == 'success' }}"
    then:
      - event: dojo_volume_redirector_result
        event_data:
          status: success
          action: "{{ routing_action }}"
          event_type: "{{ event_type }}"
          volume_entity: "{{ routed_volume }}"
          volume_name: "{{ canonical_volume_name }}"
          key: "{{ key }}"
          value_length: "{{ value | string | length }}"
          set_timestamp: "{{ set_timestamp }}"
          manifest_guid: "{{ manifest_guid }}"
          cabinet_guid: "{{ cabinet_guid }}"
          guid_mismatch: "{{ guid_mismatch }}"
          manifest_flags: "{{ manifest_flags }}"
          manifest_entry_found: "{{ manifest_volume_entry != {} }}"
      - variables:
          final_response: >
            {{
              {
                "status": "success",
                "action": routing_action,
                "event_type": event_type,
                "volume_entity": routed_volume,
                "volume_name": canonical_volume_name,
                "key": key,
                "value_length": (value | string | length),
                "set_timestamp": set_timestamp,
                "manifest_guid": manifest_guid,
                "cabinet_guid": cabinet_guid,
                "guid_mismatch": guid_mismatch,
                "manifest_flags": manifest_flags,
                "manifest_entry_found": (manifest_volume_entry != {})
              } | tojson
            }}
      - stop: Redirect Complete
        response_variable: final_response

mode: parallel
max: 10
