script:
  zen_dojotools_inspect:
    alias: Zen DojoTOOLS Inspect (RC1)
    mode: parallel
    description: >-
      Inspect (3.9.0 RC1). Deep dive on one or more entities. Attributes are
      key-scanned for safety. Cabinet sensors expose header metadata only; use
      cabinet tools for full volume access.
    fields:
      entity_id:
        required: true
        selector:
          entity:
            multiple: true
      extended:
        required: false
        default: false
        selector:
          boolean:
        description: Light device/integration forensics.
      infer:
        required: false
        selector:
          boolean:
        description: Reserved for future local inference.
      timeout:
        selector:
          number:
            min: 30
            max: 300
            step: 0.25
        name: Timeout
        default: 60
        required: false
    sequence:
      - variables:
          entity_list: |-
            {% if entity_id is iterable and (entity_id is not string) %}
              {{ entity_id }}
            {% else %}
              [{{ entity_id }}]
            {% endif %}
          extended_mode: "{{ extended | default(false) }}"
          infer_mode: "{{ infer | default(false) }}"
          timeout_s: "{{ timeout | default(60) }}"
          results: []
      - repeat:
          for_each: "{{ entity_list }}"
          sequence:
            - variables:
                current_entity: "{{ repeat.item | string }}"
                state_obj: |-
                  {% set s = states[current_entity] %}
                  {{ s if s is not none else none }}
                has_state_obj: "{{ state_obj is not none }}"
                domain: |-
                  {% set dot = current_entity.find('.') %}
                  {% if dot > 0 %}
                    {{ current_entity[:dot] }}
                  {% else %}
                    unknown
                  {% endif %}
                friendly_name: |-
                  {{ state_attr(current_entity, 'friendly_name')
                     | default(current_entity) }}
                state_str: "{{ states(current_entity) if has_state_obj else 'unknown' }}"
                last_changed: |-
                  {% if has_state_obj %}
                    {{ as_timestamp(state_obj.last_changed, default=0)
                         | timestamp_local }}
                  {% else %} {{ '' }} {% endif %}
                last_updated: |-
                  {% if has_state_obj %}
                    {{ as_timestamp(state_obj.last_updated, default=0)
                         | timestamp_local }}
                  {% else %} {{ '' }} {% endif %}
                labels_raw: "{{ labels(current_entity) | default([]) }}"
                safe_labels: |-
                  {% if labels_raw is iterable and (labels_raw is not string) %}
                    {{ labels_raw | list }}
                  {% else %} [] {% endif %}
                attrs_raw: >-
                  {% set s = states[current_entity] %} {% if s is not none and
                  s.attributes is mapping %}
                    {{ s.attributes }}
                  {% else %}
                    {}
                  {% endif %}
                has_attrs: >-
                  {% set s = states[current_entity] %} {{ s is not none and
                  s.attributes is mapping }}
                attrs_is_stringified: "{{ attrs_raw is string }}"
                cabinet_header: |-
                  {% set raw = attrs_raw %}
                  {% if raw is mapping %}
                    {% set vars = raw.get('variables') %}
                    {% if vars is mapping %}
                      {% set cab = vars.get('AI_Cabinet_VolumeInfo') %}
                      {% if cab is mapping and cab.get('value') is mapping %}
                        {{ cab.get('value') }}
                      {% else %} {} {% endif %}
                    {% else %} {} {% endif %}
                  {% else %} {} {% endif %}
                cabinet_signature: |-
                  {% if cabinet_header is mapping %}
                    {{ cabinet_header.get('validation','') | string }}
                  {% else %}
                    ''
                  {% endif %}
                is_cabinet_sensor: |-
                  {{
                    domain == 'sensor'
                    and cabinet_header is mapping
                    and cabinet_signature == 'ALLYOURBASEAREBELONGTOUS'
                  }}
                cabinet_guid: |-
                  {% if is_cabinet_sensor and cabinet_header.get('id') %}
                    {{ cabinet_header.get('id') }}
                  {% else %} '' {% endif %}
                cabinet_uninitialized: "{{ is_cabinet_sensor and not cabinet_header.get('id') }}"
                volume_result: |-
                  {% if is_cabinet_sensor %}
                    {{ {
                      "is_cabinet": true,
                      "id": cabinet_header.get("id"),
                      "version": cabinet_header.get("version"),
                      "friendly_name": cabinet_header.get("friendly_name"),
                      "name": cabinet_header.get("name"),
                      "description": cabinet_header.get("description"),
                      "validation": cabinet_signature,
                      "flags": (
                        cabinet_header.get("flags")
                        if cabinet_header.get("flags") is mapping
                        else {}
                      ),
                      "uninitialized": cabinet_uninitialized
                    } }}
                  {% else %}
                    {{ {"is_cabinet": false} }}
                  {% endif %}
                stat_class: |-
                  {{ state_attr(current_entity,'state_class')
                     | default('', true) | string }}
                stat_uom: |-
                  {{ state_attr(current_entity,'unit_of_measurement')
                     | default('', true) | string }}
                stats_eligible: |-
                  {{ stat_class in ['measurement','total','total_increasing']
                     and stat_uom != '' }}
                stats_reason: |-
                  {% if not has_state_obj %}
                    Entity not found.
                  {% elif stats_eligible %}
                    Eligible based on state_class and unit_of_measurement.
                  {% elif stat_class == '' and stat_uom == '' %}
                    Missing state_class and unit_of_measurement.
                  {% elif stat_class == '' %}
                    Missing state_class.
                  {% elif stat_uom == '' %}
                    Missing unit_of_measurement.
                  {% else %}
                    Unsupported state_class for statistics.
                  {% endif %}
                statistics_result: |-
                  {{ {
                    "eligible": stats_eligible,
                    "reason": stats_reason
                  } }}
                extended_block: |-
                  {% if extended_mode %}
                    {% set dev_id = state_attr(current_entity, 'device_id') %}
                    {% set dev = dev_id if dev_id is not none else none %}
                    {% set area = dev and device_attr(dev, 'area_id') or none %}
                    {% set identifiers = dev and device_attr(dev, 'identifiers') or none %}
    
                    {{ {
                      "device_id": dev,
                      "area_id": area,
                      "identifiers": identifiers
                    } }}
                  {% else %}
                    {}
                  {% endif %}
                safe_attributes: |-
                  {% if is_cabinet_sensor %}
                    {
                      "notice": "Attributes suppressed for cabinet sensor. Use FileCabinet tools for full volume access."
                    }
                  {% else %}
                    {# --- ORIGINAL SANITIZER BLOCK (UNCHANGED) --- #}
    
                    {% if attrs_is_stringified %}
                      {# --- FALLBACK MODE: Home Assistant stringified the dict --- #}
                      {% set s = states[current_entity] %}
                      {% set ns = namespace(out={}) %}
    
                      {% if s is not none %}
                        {% for k in s.attributes.keys() %}
                          {% set v = state_attr(current_entity, k) %}
                          {% if v is string or v is number or v is boolean %}
                            {% set ns.out = ns.out | combine({k: v}, recursive=true) %}
                          {% elif v is mapping %}
                            {% set ns.out = ns.out | combine({k: v}, recursive=true) %}
                          {% elif v is sequence and (v is not string) %}
                            {% set ns.out = ns.out | combine({k: v}, recursive=true) %}
                          {% else %}
                            {% set ns.out = ns.out | combine({k: v|string}, recursive=true) %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
    
                      {{ ns.out }}
    
                    {% else %}
                      {# --- NORMAL MODE --- #}
                      {% set raw = attrs_raw %}
                      {% set ns = namespace(out={}) %}
    
                      {% if raw is mapping %}
                        {% for k, v in raw.items() %}
                          {% if v is string or v is number or v is boolean %}
                            {% set ns.out = ns.out | combine({k: v}, recursive=true) %}
                          {% elif v is mapping %}
                            {% set ns.out = ns.out | combine({k: v}, recursive=true) %}
                          {% elif v is sequence and (v is not string) %}
                            {% set ns.out = ns.out | combine({k: v}, recursive=true) %}
                          {% else %}
                            {% set ns.out = ns.out | combine({k: v|string}, recursive=true) %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
    
                      {{ ns.out }}
                    {% endif %}
                  {% endif %}
                entity_result: |-
                  {{ {
                    "entity_id": current_entity,
                    "friendly_name": friendly_name,
                    "domain": domain,
                    "state": state_str,
                    "last_changed": last_changed,
                    "last_updated": last_updated,
                    "labels": safe_labels,
                    "attributes": safe_attributes,
                    "volume": volume_result,
                    "statistics": statistics_result,
                    "extended": extended_block,
                  } }}
                results: "{{ (results + [entity_result]) | list }}"
      - variables:
          inspect_result:
            results: "{{ results }}"
            inputs:
              entity_id: "{{ entity_list }}"
              extended: "{{ extended_mode }}"
              infer: "{{ infer_mode }}"
              timeout: "{{ timeout_s }}"
            error: null
      - stop: Inspect complete
        response_variable: inspect_result
