script:
  zen_admintools_cabinetadmin:
    alias: Zen AdminTools CabinetAdmin
    description: >
      v4.0.9 RC1
    
      Zen-OS Unified Factory, Inspector & Modular Repair tool for Zen Library
      Cabinets
    
      Philip's WSOM correction edition
    
      Modes: inspect | inspect_full | initialize | repair. Adds enhanced
      NEEDS/PROPOSED diff block. Includes hardened variable templates, pseudo-UUID
      generator, safe ACL logic, schema versioning, and deterministic behavior and
      writes things in the right place.
    sequence:
      - variables:
          mode: "{{ (mode | default('inspect')) | string() | lower }}"
          confirm_action: "{{ confirm_action | default(false) }}"
          cabinet_entity: "{{ cabinet_entity | default('') }}"
          target_cab: "{{ cabinet_entity }}"
          cabinet_type: "{{ cabinet_type | default('AI Data Storage Cabinet') }}"
          now_iso: "{{ now().isoformat() }}"
          schema_version: 1
          auto_profile: "{{ auto_profile | default(true) }}"
          explicit_flag_profile: "{{ explicit_flag_profile | default('standard') }}"
          mount_scan: "{{ mount_scan | default(true) }}"
          repair_guid: "{{ repair_guid | default(none) }}"
          repair_volumeinfo: "{{ repair_volumeinfo | default(none) }}"
          repair_acls: "{{ repair_acls | default(none) }}"
          repair_flags_profile: "{{ repair_flags_profile | default(none) }}"
          repair_flags_bits: "{{ repair_flags_bits | default(none) }}"
          repair_flags_full: "{{ repair_flags_full | default(none) }}"
          repair_mounts: "{{ repair_mounts | default(none) }}"
          repair_labels: "{{ repair_labels | default(none) }}"
          flags_override: "{{ flags_override | default({}, true) }}"
          cabinet_friendly: >
            {{ state_attr(cabinet_entity,'friendly_name') | default(cabinet_entity)
            }}
          meta_raw: "{{ state_attr(cabinet_entity,'metadata') }}"
          meta: |
            {% set m = meta_raw %} {{ m if m is mapping else {} }}
          labels_from_cabinet: |
            {% set m = meta %} {{ m.get('labels', []) if m is mapping else [] }}
          drawers_raw: "{{ state_attr(cabinet_entity,'drawers') }}"
          drawers_attr: >
            {% set d = state_attr(cabinet_entity, 'drawers') %} {{ d if d is
            iterable else [] }}
          variables_raw: "{{ state_attr(cabinet_entity,'variables') }}"
          existing_variables: |
            {% set v = variables_raw %} {{ v if v is mapping else {} }}
          volumeinfo_obj: >
            {% set v = existing_variables.get('AI_Cabinet_VolumeInfo') %} {{ v if v
            is mapping else {} }}
          volumeinfo_val: >
            {% set vv = volumeinfo_obj.get('value') %} {{ vv if vv is mapping else
            {} }}
          current_flags: >
            {% set f = volumeinfo_val.get('flags') %} {{ f if f is mapping else {}
            }}
          generated_guid: >
            {% set ts = (now().timestamp() * 1000) | int %} {% set s =
            cabinet_entity | string %} {% set h = 5381 %} {% for c in s %}
              {% set h = ((h * 33) + (c | ord)) % 4294967296 %}
            {% endfor %} {{ ts ~ '-' ~ h }}
          supplied_guid: "{{ cabinet_guid | default('') }}"
          existing_guid: |
            {% if volumeinfo_val is mapping %}
              {{ volumeinfo_val.get('id','') }}
            {% else %}{{ '' }}{% endif %}
          cabinet_guid_out: |
            {% if force_new_guid %}
              {{ generated_guid }}
            {% elif supplied_guid not in ['', None] %}
              {{ supplied_guid }}
            {% elif existing_guid not in ['', None] %}
              {{ existing_guid }}
            {% else %}
              {{ generated_guid }}
            {% endif %}
          labels_lc: "{{ (labels_from_cabinet | default([])) | map('lower') | list }}"
          type_lc: "{{ cabinet_type | string | lower }}"
          flag_profile: |
            {% if not auto_profile %}
              {{ explicit_flag_profile }}
            {% else %}
              {% set L = labels_lc %}
              {% if 'household_cabinet' in L or 'system_cabinet' in L
                    or 'zen_dojo_cabinet' in L or 'zen_kata_cabinet' in L %}
                system
              {% elif 'family_cabinet' in L or 'zen_history_cabinet' in L
                    or 'zen_friday_history_cabinet' in L or 'archive_cabinet' in L
                    or type_lc == 'chat history cabinet' %}
                secure
              {% elif 'zen_user_cabinet' in L
                or 'user_cabinet' in L
                or 'zen_user' in L
                or 'zen_ai_user_cabinet' in L
                or 'ai_user_cabinet' in L
                or 'ai_user' in L
                or 'zen_ai_user' in L
                or 'zen_household_cabinet' in L
                or 'household_cabinet' in L
                or 'zen_household' in L
              %}
                public
              {% else %}
                standard
              {% endif %}
            {% endif %}
          desired_flags_from_profile: |
            {{
              (
                {"system": True, "hidden": False, "read_only": True, "secure_mode": True}
                if flag_profile == "system"
                else
                {"system": False, "hidden": True, "read_only": True, "secure_mode": True}
                if flag_profile == "secure"
                else
                {"system": False, "hidden": False, "read_only": False, "secure_mode": False}
              )
            }}
          owner_person: "{{ owner_person | default('') }}"
          partner_person: "{{ partner_person | default('') }}"
          owner_sid: >
            {% set raw = state_attr(owner_person, 'user_id') %} {% if raw in
            ['unknown', None, ''] %}
              no-sid
            {% else %}
              {{ raw }}
            {% endif %}
          partner_sid: >
            {% set raw = state_attr(partner_person, 'user_id') %} {% if raw in
            ['unknown', None, ''] %}
              no-sid
            {% else %}
              {{ raw }}
            {% endif %}
          owner_acl: |
            {% if owner_person is string
                  and owner_person|length >= 7
                  and owner_person[0:7] == 'person.'
                  and owner_sid != 'no-sid' %}
              {{ [{"entity_id": owner_person, "sid": owner_sid, "role": "owner"}] }}
            {% else %}
              []
            {% endif %}
          partner_acl: |
            {% if partner_person is string
                  and partner_person|length >= 7
                  and partner_person[0:7] == 'person.'
                  and partner_sid != 'no-sid' %}
              {{ [{"entity_id": partner_person, "sid": partner_sid, "role": "partner"}] }}
            {% else %}
              []
            {% endif %}
          acl_family: >
            {% set fam_guid = family_guid | default('default-guid') %} {{
            [{"family_guid": fam_guid, "nickname": "Family"}] }}
          mounts_out: |
            {% if mount_scan %}
              {% set ns = namespace(L=[]) %}
              {% for d in drawers_attr if '[mount:' in d %}
                {% set rel = d.split('[mount:')[0].strip() %}
                {% set tgt = d.split('mount:')[1].split(']')[0].strip() %}
                {% set ns.L = ns.L + [{"relation": rel, "target_cabinet": tgt, "scope": "root"}] %}
              {% endfor %}
              {{ ns.L }}
            {% else %}[]{% endif %}
          volumeinfo_template: |
            {{
              {
                "id": cabinet_guid_out,
                "friendly_name": cabinet_friendly,
                "type": cabinet_type,
                "schema_version": schema_version,
                "created": now_iso,
                "updated": now_iso,
                "flags": desired_flags_from_profile,
                "owner_sid": owner_sid,
                "acls": {
                  "owner": owner_acl,
                  "partner": partner_acl,
                  "family": acl_family
                },
                "entity_labels":
                  (["chat","history","secure","context","transcript","cabinet"]
                  if type_lc == "chat history cabinet"
                  else ["system","cabinet","volumeinfo"])
              }
            }}
          relationships_template: |
            {{
              {
                "schema_version": 1,
                "mounts_out": mounts_out,
                "mounts_in": [],
                "mount_policy": ("allow_all" if flag_profile == "system" else "restricted")
              }
            }}
          labelindex_template: |
            {{
              {
                "schema_version": 1,
                "labels": {}
              }
            }}
          has_volumeinfo: "{{ volumeinfo_obj.get('value') is mapping }}"
          need_guid: |
            {{ force_new_guid
               or (existing_guid in ['', None])
               or (supplied_guid not in ['', None] and supplied_guid != existing_guid)
            }}
          zr_obj: >
            {% set zr = existing_variables.get('_zen_relationships') %} {{ zr if zr
            is mapping else {} }}
          need_mounts: "{{ not (zr_obj is mapping and zr_obj.get('value') is mapping) }}"
          li_obj: |
            {% set li = existing_variables.get('_label_index') %}
            {{ li if li is mapping else {} }}
          need_labels: "{{ not (li_obj is mapping and li_obj.get('value') is mapping) }}"
          need_volumeinfo: "{{ not has_volumeinfo }}"
          owner_ok: >
            {% set a = volumeinfo_val.get('acls',{}).get('owner',[]) %} {% if
            owner_sid != 'no-sid' %}
              {{ (a | selectattr('sid','equalto',owner_sid) | list | count) > 0 }}
            {% else %}
              {{ (a | rejectattr('sid','equalto','no-sid') | list | count) > 0 }}
            {% endif %}
          partner_ok: >
            {% set a = volumeinfo_val.get('acls',{}).get('partner',[]) %} {% if
            partner_sid != 'no-sid' %}
              {{ (a | selectattr('sid','equalto',partner_sid) | list | count) > 0 }}
            {% else %}
              {{ (a | rejectattr('sid','equalto','no-sid') | list | count) > 0 }}
            {% endif %}
          need_acls: |
            {{ not owner_ok or not partner_ok }}
          desired_flags_json: "{{ desired_flags_from_profile | tojson }}"
          current_flags_json: "{{ current_flags | tojson }}"
          need_flags_profile: |
            {{
              (desired_flags_from_profile.read_only | default(false)) != (current_flags.read_only | default(false))
              or (desired_flags_from_profile.hidden | default(false)) != (current_flags.hidden | default(false))
              or (desired_flags_from_profile.secure_mode | default(false)) != (current_flags.secure_mode | default(false))
            }}
          need_flags_full: "{{ desired_flags_json != current_flags_json }}"
          new_flags_profile: |
            {{
              current_flags | combine({
                'read_only': desired_flags_from_profile.read_only | default(false),
                'hidden': desired_flags_from_profile.hidden | default(false),
                'secure_mode': desired_flags_from_profile.secure_mode | default(false)
              })
            }}
          fb: "{{ flags_override if flags_override is mapping else {} }}"
          new_flags_bits: "{{ current_flags | combine(fb) }}"
          plan_guid: >
            {% if repair_guid is none %}{{ need_guid }}{% else %}{{ repair_guid }}{%
            endif %}
          plan_volumeinfo: >
            {% if repair_volumeinfo is none %}{{ need_volumeinfo }}{% else %}{{
            repair_volumeinfo }}{% endif %}
          plan_acls: >
            {% if repair_acls is none %}{{ need_acls }}{% else %}{{ repair_acls }}{%
            endif %}
          plan_flags_profile: >
            {% if repair_flags_profile is none %}{{ need_flags_profile }}{% else
            %}{{ repair_flags_profile }}{% endif %}
          plan_flags_full: >
            {% if repair_flags_full is none %}{{ need_flags_full }}{% else %}{{
            repair_flags_full }}{% endif %}
          plan_flags_bits: >
            {% if repair_flags_bits is none %}false{% else %}{{ repair_flags_bits
            }}{% endif %}
          plan_mounts: >
            {% if repair_mounts is none %}{{ need_mounts }}{% else %}{{
            repair_mounts }}{% endif %}
          plan_labels: >
            {% if repair_labels is none %}{{ need_labels }}{% else %}{{
            repair_labels }}{% endif %}
          affect_volumeinfo: >
            {{ plan_guid or plan_volumeinfo or plan_acls or plan_flags_profile or
            plan_flags_full or plan_flags_bits }}
          affect_relationships: "{{ plan_mounts }}"
          affect_labelindex: "{{ plan_labels }}"
          affected_drawers: >
            {% set ns = namespace(L=[]) %} {% if affect_volumeinfo %}{% set ns.L =
            ns.L + ['AI_Cabinet_VolumeInfo'] %}{% endif %} {% if
            affect_relationships %}{% set ns.L = ns.L + ['_zen_relationships'] %}{%
            endif %} {% if affect_labelindex %}{% set ns.L = ns.L + ['_label_index']
            %}{% endif %} {{ ns.L }}
          needs_struct: |
            {{
              {
                "guid": {
                  "required": need_guid,
                  "proposed": cabinet_guid_out
                },
                "volumeinfo": {
                  "required": need_volumeinfo,
                  "proposed": (volumeinfo_template if need_volumeinfo else "no-change")
                },
                "acls": {
                  "required": need_acls,
                  "proposed":
                    {
                      "owner": owner_acl,
                      "partner": partner_acl,
                      "family": acl_family
                    } if need_acls else "no-change"
                },
                "flags_profile": {
                  "required": need_flags_profile,
                  "proposed": (new_flags_profile if need_flags_profile else "no-change")
                },
                "flags_full": {
                  "required": need_flags_full,
                  "proposed": (desired_flags_from_profile if need_flags_full else "no-change")
                },
                "flags_bits": {
                  "required": plan_flags_bits,
                  "proposed": (new_flags_bits if plan_flags_bits else "no-change")
                },
                "mounts": {
                  "required": need_mounts,
                  "proposed": (relationships_template if need_mounts else "no-change")
                },
                "labels": {
                  "required": need_labels,
                  "proposed": (labelindex_template if need_labels else "no-change")
                }
              }
            }}
      - choose:
          - conditions:
              - condition: template
                value_template: |
                  {{ cabinet_entity in ['', None]
                     or states(cabinet_entity) in ['unknown','unavailable','none'] }}
            sequence:
              - variables:
                  response:
                    status: error
                    message: Invalid or missing cabinet entity.
              - stop: Invalid entity
                response_variable: response
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ mode == 'inspect_full' }}"
            alias: Inspect Full
            sequence:
              - variables:
                  zen_cabs: >-
                    {% set labeled = label_entities('Zen Cabinet') %} {% set sensors
                    = states.sensor
                        | selectattr('entity_id','in', labeled)
                        | map(attribute='entity_id')
                        | list %}
                    {{ sensors | sort }}
                  vars_list: |-
                    {% set out = [] %} {% for e in zen_cabs %}
                      {% set v = state_attr(e, 'variables') %}
                      {% set out = out + [ v if v is mapping else {} ] %}
                    {% endfor %} {{ out }}
                  label_list: |-
                    {% set out = [] %} {% for e in zen_cabs %}
                      {% set m = state_attr(e, 'metadata') %}
                      {% set labels = m.get('labels', []) if m is mapping else [] %}
                      {% set out = out + [ labels ] %}
                    {% endfor %} {{ out }}
                  state_list: |-
                    {% set out = [] %} {% for e in zen_cabs %}
                      {% set out = out + [ states(e) ] %}
                    {% endfor %} {{ out }}
                  illegal_cabs: >-
                    {% set out = namespace(list=[]) %} {% for i in
                    range(zen_cabs|count) %}
                      {% if 'slot' in vars_list[i] %}
                        {% set out.list = out.list + [ zen_cabs[i] ] %}
                      {% endif %}
                    {% endfor %} {{ out.list | tojson }}
                  deep_dump: |-
                    {% set deep = namespace(list=[]) %}
                    {% for i in range(zen_cabs | count) %}
    
    
                      {% set vars = vars_list[i] | default({}) %}
                      {% set has_illegal = 'slot' in vars %}
    
                      {# Build the proposed variable cleanup #}
                      {% if has_illegal %}
                        {% set cleaned = namespace(obj={}) %}
                        {% for k, v in vars.items() %}
                          {% if k != 'slot' %}
                            {% set cleaned.obj = cleaned.obj | merge({ k: v }) %}
                          {% endif %}
                        {% endfor %}
                        {% set proposed = cleaned.obj %}
                      {% else %}
                        {% set proposed = 'no-change' %}
                      {% endif %}
    
                      {% set item = {
                        "entity_id": zen_cabs[i],
                        "state": states(zen_cabs[i]) | default(""),
                        "labels": label_list[i] | default([]),
                        "variables": vars_list[i] | default({}),
                        "has_illegal_keys": has_illegal,
                        "needs": {
                          "illegal_key_removal": {
                            "required": has_illegal,
                            "proposed": proposed
                          }
                        }
                      } %}
    
                      {% set deep.list = deep.list + [ item ] %}
    
                    {% endfor %}
                    {{ deep.list | tojson }}
                  response:
                    status: success
                    message: Deep inspection complete.
                    data:
                      cabinet_count: "{{ zen_cabs | count }}"
                      illegal_key_cabinets: "{{ illegal_cabs }}"
                      cabinets: "{{ deep_dump }}"
              - stop: Deep inspection done
                response_variable: response
          - conditions:
              - condition: template
                value_template: "{{ mode == 'inspect' }}"
            alias: Inspect Mode
            sequence:
              - variables:
                  response:
                    status: success
                    message: Inspection complete.
                    data:
                      cabinet_entity: "{{ cabinet_entity }}"
                      cabinet_friendly: "{{ cabinet_friendly }}"
                      profile: "{{ flag_profile }}"
                      guid_existing: "{{ existing_guid }}"
                      guid_proposed: "{{ cabinet_guid_out }}"
                      mounts_out: "{{ mounts_out | length }}"
                      needs: "{{ needs_struct }}"
                      plan:
                        guid: "{{ plan_guid }}"
                        volumeinfo: "{{ plan_volumeinfo }}"
                        acls: "{{ plan_acls }}"
                        flags_profile: "{{ plan_flags_profile }}"
                        flags_full: "{{ plan_flags_full }}"
                        flags_bits: "{{ plan_flags_bits }}"
                        mounts: "{{ plan_mounts }}"
                        labels: "{{ plan_labels }}"
                      affected_drawers: "{{ affected_drawers }}"
              - stop: Inspect done
                response_variable: response
          - conditions:
              - condition: template
                value_template: "{{ mode == 'initialize' }}"
            alias: Initialize Mode
            sequence:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ not confirm_action }}"
                    sequence:
                      - variables:
                          response:
                            status: error
                            message: "Confirmation required â€” set confirm_action: true"
                      - stop: Init blocked
                        response_variable: response
              - event: set_variable_legacy
                event_data:
                  key: AI_Cabinet_VolumeInfo
                  value: "{{ volumeinfo_template }}"
                  set_timestamp: true
                  volume_entity: "{{ target_cab }}"
              - event: set_variable_legacy
                event_data:
                  key: _zen_relationships
                  value: "{{ relationships_template }}"
                  set_timestamp: true
                  volume_entity: "{{ target_cab }}"
              - event: set_variable_legacy
                event_data:
                  key: _label_index
                  value: "{{ labelindex_template }}"
                  set_timestamp: true
                  volume_entity: "{{ target_cab }}"
              - variables:
                  response:
                    status: success
                    message: >-
                      Initialized '{{ target_cab }}' with GUID {{ cabinet_guid_out
                      }} (profile '{{ flag_profile }}').
              - stop: Init done
                response_variable: response
          - conditions:
              - condition: template
                value_template: "{{ mode == 'repair' }}"
            alias: Repair Mode
            sequence:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ not confirm_action }}"
                    sequence:
                      - variables:
                          response:
                            status: dry_run
                            message: "No changes applied - set confirm_action: true."
                            plan:
                              guid: "{{ plan_guid }}"
                              volumeinfo: "{{ plan_volumeinfo }}"
                              acls: "{{ plan_acls }}"
                              flags_profile: "{{ plan_flags_profile }}"
                              flags_full: "{{ plan_flags_full }}"
                              flags_bits: "{{ plan_flags_bits }}"
                              mounts: "{{ plan_mounts }}"
                              labels: "{{ plan_labels }}"
                            affected_drawers: "{{ affected_drawers }}"
                      - stop: Dry run
                        response_variable: response
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ plan_volumeinfo }}"
                    sequence:
                      - event: set_variable_legacy
                        event_data:
                          key: AI_Cabinet_VolumeInfo
                          value: "{{ volumeinfo_template | from_json }}"
                          set_timestamp: true
                          volume_entity: "{{ target_cab }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ plan_guid and not plan_volumeinfo }}"
                    sequence:
                      - variables:
                          vi_payload: |
                            {{
                              {
                                "id": cabinet_guid_out,
                                "friendly_name": cabinet_friendly,
                                "type": cabinet_type,
                                "schema_version": schema_version,
                                "created": volumeinfo_val.get('created', now_iso),
                                "updated": now_iso,
                                "flags": current_flags,
                                "owner_sid": owner_sid,
                                "acls": volumeinfo_val.get('acls',{}),
                                "entity_labels":
                                  (["chat","history","secure","context","transcript","cabinet"]
                                   if type_lc == 'chat history cabinet'
                                   else ["system","cabinet","volumeinfo"])
                              } | tojson
                            }}
                      - event: set_variable_legacy
                        event_data:
                          key: AI_Cabinet_VolumeInfo
                          value: "{{ vi_payload | from_json }}"
                          set_timestamp: true
                          volume_entity: "{{ target_cab }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ plan_acls and not plan_volumeinfo and not plan_guid }}"
                    sequence:
                      - variables:
                          vi_payload: |
                            {{
                              {
                                "id": existing_guid if existing_guid not in ['', None] else cabinet_guid_out,
                                "friendly_name": cabinet_friendly,
                                "type": cabinet_type,
                                "schema_version": schema_version,
                                "created": volumeinfo_val.get('created', now_iso),
                                "updated": now_iso,
                                "flags": current_flags,
                                "owner_sid": owner_sid,
                                "acls": {
                                  "owner": owner_acl,
                                  "partner": partner_acl,
                                  "family": acl_family
                                },
                                "entity_labels":
                                  (["chat","history","secure","context","transcript","cabinet"]
                                   if type_lc == 'chat history cabinet'
                                   else ["system","cabinet","volumeinfo"])
                              } | tojson
                            }}
                      - event: set_variable_legacy
                        event_data:
                          key: AI_Cabinet_VolumeInfo
                          value: "{{ vi_payload | from_json }}"
                          set_timestamp: true
                          volume_entity: "{{ target_cab }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ plan_flags_profile and not plan_volumeinfo and not
                          plan_guid }}
                    sequence:
                      - variables:
                          vi_payload: |
                            {{
                              {
                                "id": existing_guid if existing_guid not in ['', None] else cabinet_guid_out,
                                "friendly_name": cabinet_friendly,
                                "type": cabinet_type,
                                "schema_version": schema_version,
                                "created": volumeinfo_val.get('created', now_iso),
                                "updated": now_iso,
                                "flags": new_flags_profile,
                                "owner_sid": owner_sid,
                                "acls": volumeinfo_val.get('acls',{}),
                                "entity_labels":
                                  (["chat","history","secure","context","transcript","cabinet"]
                                   if type_lc == 'chat history cabinet'
                                   else ["system","cabinet","volumeinfo"])
                              } | tojson
                            }}
                      - event: set_variable_legacy
                        event_data:
                          key: AI_Cabinet_VolumeInfo
                          value: "{{ vi_payload | from_json }}"
                          set_timestamp: true
                          volume_entity: "{{ target_cab }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ plan_flags_bits and not plan_volumeinfo and not
                          plan_guid }}
                    sequence:
                      - variables:
                          vi_payload: |
                            {{
                              {
                                "id": existing_guid if existing_guid not in ['', None] else cabinet_guid_out,
                                "friendly_name": cabinet_friendly,
                                "type": cabinet_type,
                                "schema_version": schema_version,
                                "created": volumeinfo_val.get('created', now_iso),
                                "updated": now_iso,
                                "flags": new_flags_bits,
                                "owner_sid": owner_sid,
                                "acls": volumeinfo_val.get('acls',{}),
                                "entity_labels": volumeinfo_val.get('entity_labels', ["system","cabinet","volumeinfo"])
                              } | tojson
                            }}
                      - event: set_variable_legacy
                        event_data:
                          key: AI_Cabinet_VolumeInfo
                          value: "{{ vi_payload | from_json }}"
                          set_timestamp: true
                          volume_entity: "{{ target_cab }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ plan_flags_full and not plan_volumeinfo and not
                          plan_guid }}
                    sequence:
                      - event: set_variable_legacy
                        event_data:
                          key: AI_Cabinet_VolumeInfo
                          value: "{{ volumeinfo_template }}"
                          set_timestamp: true
                          volume_entity: "{{ target_cab }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ plan_mounts }}"
                    sequence:
                      - event: set_variable_legacy
                        event_data:
                          key: _zen_relationships
                          value: "{{ relationships_template }}"
                          set_timestamp: true
                          volume_entity: "{{ target_cab }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ plan_labels }}"
                    sequence:
                      - event: set_variable_legacy
                        event_data:
                          key: _label_index
                          value: "{{ labelindex_template }}"
                          set_timestamp: true
                          volume_entity: "{{ target_cab }}"
              - variables:
                  response:
                    status: success
                    message: Repaired '{{ target_cab }}' (profile '{{ flag_profile }}').
                    executed:
                      guid: "{{ plan_guid }}"
                      volumeinfo: "{{ plan_volumeinfo }}"
                      acls: "{{ plan_acls }}"
                      flags_profile: "{{ plan_flags_profile }}"
                      flags_full: "{{ plan_flags_full }}"
                      flags_bits: "{{ plan_flags_bits }}"
                      mounts: "{{ plan_mounts }}"
                      labels: "{{ plan_labels }}"
                    affected_drawers: "{{ affected_drawers }}"
              - stop: Repair done
                response_variable: response
        default:
          - variables:
              response:
                status: error
                message: >-
                  Unknown mode '{{ mode }}'. Use: inspect | inspect_full |
                  initialize | repair.
          - stop: Mode error
            response_variable: response
      - set_conversation_response: "{{ response }}"
    fields:
      mode:
        name: Mode
        selector:
          select:
            options:
              - inspect
              - inspect_full
              - initialize
              - repair
        default: inspect
      confirm_action:
        name: Confirm Destructive Action
        selector:
          boolean:
        default: false
      cabinet_entity:
        name: Cabinet Entity
        selector:
          entity:
            filter:
              - domain: sensor
      cabinet_type:
        name: Cabinet Type
        selector:
          select:
            options:
              - AI Data Storage Cabinet
              - Zen Dojo Cabinet
              - Zen Kata Cabinet
              - User Cabinet
              - AI User Cabinet
              - Family Cabinet
              - Household Cabinet
              - System Cabinet
              - Partner Cabinet
              - Chat History Cabinet
              - Archive Cabinet
              - Other
        default: AI Data Storage Cabinet
      cabinet_guid:
        name: Cabinet GUID (optional)
        selector:
          text:
      force_new_guid:
        name: Force New GUID
        selector:
          boolean:
        default: false
      owner_person:
        name: Owner (Person)
        selector:
          entity:
            domain: person
            multiple: false
      partner_person:
        name: Partner (Person)
        selector:
          entity:
            domain: person
            multiple: false
      auto_profile:
        name: Auto-Detect Flag Profile
        selector:
          boolean:
        default: true
      explicit_flag_profile:
        name: Manual Flag Profile
        selector:
          select:
            options:
              - system
              - secure
              - public
              - standard
        default: standard
      mount_scan:
        name: Scan Mounts for Links
        selector:
          boolean:
        default: true
      repair_guid:
        name: Repair GUID
        selector:
          boolean:
      repair_volumeinfo:
        name: Repair Volumeinfo
        selector:
          boolean:
      repair_acls:
        name: Repair ACLs
        selector:
          boolean:
      repair_flags_profile:
        name: Repair Flags (profile alignment)
        selector:
          boolean:
      repair_flags_bits:
        name: Repair Flags (bits merge)
        selector:
          boolean:
      flags_override:
        name: Flags Override (JSON Object)
        selector:
          object:
      repair_flags_full:
        name: Repair Flags (full replace)
        selector:
          boolean:
      repair_mounts:
        name: Repair Relationships
        selector:
          boolean:
      repair_labels:
        name: Repair Label Index
        selector:
          boolean:
    icon: mdi:database-cog
