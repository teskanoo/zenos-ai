script:
  zen_dojotools_identity:
    alias: Zen DojoTools Identity (RC1)
    mode: parallel
    max: 10
    description: >
      Zen DojoTools Identity 3.9.11 RC1 — Canonical identity resolver for the
      ZenOS-AI household. When called with no target, it invokes zen_cabinets(None)
      and returns the full, redacted roster of all registered users, AI constructs,
      and cabinets.
    
      When a target is provided—such as a person entity_id, cabinet entity_id,
      label, or UUID—the tool normalizes the input, preserves full person.* values,
      and uses the canonical resolver chain:
    
      1. person.*  → zen_cabinets(owner.entity_id) → user cabinet (highest
      authority) 2. GUID      → direct cabinet lookup by GUID 3. sensor.*  → direct
      cabinet lookup by entity_id 4. label     → label_entities + cabinet filter
    
      The tool returns a structured identity object plus the raw zen_cabinets
      result. All outputs are JSON-safe mappings for downstream reasoning.
    fields:
      user_label:
        name: User Label
        description: Optional, the Index label referring to a valid ZenOS-AI user.
        selector:
          text: null
      user_cabinet:
        name: User Cabinet
        description: Optional, the entity_id of a valid user cabinet sensor.
        selector:
          entity:
            domain: sensor
            multiple: false
      user_entity_id:
        name: Person
        description: Optional, the entity_id of a valid user person entity.
        required: false
        selector:
          entity:
            domain: person
            multiple: false
      user_guid:
        name: User GUID
        description: Optional, the ZenOS-AI User GUID of a valid user.
        required: false
        selector:
          text:
            multiline: false
    sequence:
      - variables:
          include_debug: "{{ debug | default(false) }}"
          user_label: "{{ user_label | default('') }}"
          user_cabinet: "{{ user_cabinet | default('') }}"
          user_entity_id: "{{ user_entity_id | default('') }}"
          user_guid: >-
            {%- set ug = user_guid | default('') | trim -%} {%- set pattern =
            "(?i)^[0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12}$"
            -%} {{ ug if ug is match(pattern) else '' }}
          target: |-
            {%- if user_label | default('') | trim != '' -%}
              {{ user_label | trim }}
            {%- elif user_cabinet | default('') | trim != '' -%}
              {{ user_cabinet | trim }}
            {%- elif user_entity_id | default('') | trim != '' -%}
              {{ user_entity_id | trim }}
            {%- elif user_guid | default('') | trim != '' -%}
              {{ user_guid | trim }}
            {%- else -%}
              ''
            {%- endif -%}
          raw_target: "{{ target | default('') | trim }}"
          normalized: >-
            {%- set rt = raw_target | string | trim -%}
    
            {# --- 0. Canonical empty/null detection --- #} {%- if rt in ['', "''",
            '""', "' '", '" "', None] -%}
              {{ None }}
    
            {# --- 1. Preserve full person entities verbatim --- #} {%- elif
            rt|length >= 7 and rt[0:7] == 'person.' -%}
              {{ rt }}
    
            {# --- 2. Preserve full cabinet sensors verbatim --- #} {%- elif
            rt|length >= 7 and rt[0:7] == 'sensor.' -%}
              {{ rt }}
    
            {# --- 3. Accept UUID formats (with/without hyphens, case-insensitive)
            --- #} {%- elif rt is
            match("(?i)^[0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12}$")
            -%}
              {{ rt }}
    
            {# --- 4. Reject ANYTHING containing a dot that isn’t person/sensor ---
            #} {%- elif '.' in rt -%}
              {{ None }}
    
            {# --- 5. Otherwise treat as a plain label --- #} {%- else -%}
              {{ rt }}
            {%- endif -%}
      - variables:
          resolved_person_identity: |
            {# -------------------------------------------------------------
               PERSON -> CABINET RESOLVER (SID free)
               Uses zen_cabinets(person.*) which already matches by ACL owner.entity_id
            ------------------------------------------------------------- #}
            {% set rt = normalized %}
            {% if rt is string and rt|length >= 7 and rt[0:7] == 'person.' %}
    
              {% import 'zenos_ai/zen_os_1rc.jinja' as zen %}
    
              {# Call zen_cabinets with the person entity as the key #}
              {% set raw = zen.zen_cabinets(rt) | trim %}
    
              {% if raw in ['', None] %}
                {{ {
                  "error": "no_matching_user_cabinet",
                  "person": rt,
                  "reason": "zen_cabinets returned empty for person input"
                } }}
              {% else %}
                {% set parsed = raw | from_json %}
    
                {# zen_cabinets returns either:
                   - a mapping with entity_id,... on success
                   - a mapping with error on failure
                #}
                {% if parsed is mapping and parsed.error is defined %}
                  {{ parsed }}
    
                {% elif parsed is mapping and parsed.entity_id is defined %}
                  {% set cab = parsed %}
                  {{ {
                    "identity_type": "user",
                    "person": rt,
                    "cabinet_entity": cab.entity_id,
                    "name": (cab.name if cab.name is defined else None),
                    "guid": (cab.guid if cab.guid is defined else None),
                    "labels": (cab.labels if cab.labels is defined else []),
                    "metadata": (cab.essence if cab.essence is defined else {}),
                    "raw_cabinet": cab
                  } }}
    
                {% else %}
                  {{ {
                    "error": "unexpected_zen_cabinets_shape",
                    "person": rt,
                    "raw": parsed
                  } }}
                {% endif %}
              {% endif %}
    
            {% else %}
              {{ None }}
            {% endif %}
      - variables:
          resolved_cabinet_identity: |
            {# ============================================================
               CABINET -> IDENTITY RESOLVER
               Trigger only when normalized is sensor.*
               Uses zen_cabinets(sensor.*) and classifies by labels, not SID
            ============================================================= #}
    
            {% set rt = normalized %}
            {% if rt is string and rt|length >= 7 and rt[0:7] == 'sensor.' %}
    
              {% import 'zenos_ai/zen_os_1rc.jinja' as zen %}
    
              {# 1. Call zen_cabinets() for this cabinet #}
              {% set raw = zen.zen_cabinets(rt) | trim %}
    
              {% if raw in ['', None] %}
                {{ {
                  "error": "cabinet_not_found",
                  "cabinet": rt
                } }}
              {% else %}
                {% set parsed = raw | from_json %}
    
                {# zen_cabinets for a specific cabinet should return a single entry, or an error #}
                {% if parsed is mapping and parsed.error is defined %}
                  {{ parsed }}
                {% elif parsed is mapping and parsed.entity_id is defined %}
                  {% set cab = parsed %}
                {% else %}
                  {{ {
                    "error": "cabinet_lookup_invalid_or_empty",
                    "cabinet": rt,
                    "parsed": parsed
                  } }}
                {% endif %}
    
                {% if cab is defined %}
                  {% set labels = cab.labels if cab.labels is defined else [] %}
                  {% set essence = cab.essence if cab.essence is defined else {} %}
                  {# classify "user" by label, not SID #}
                  {% set is_user =
                       ('user_cabinet' in labels)
                       or ('ai_user' in labels)
                  %}
                  {{ {
                    "identity_type": "user" if is_user else "cabinet",
                    "cabinet_entity": rt,
                    "name": (cab.name if cab.name is defined else None),
                    "guid": (cab.guid if cab.guid is defined else None),
                    "labels": labels,
                    "metadata": essence,
                    "raw_cabinet": cab
                  } }}
                {% endif %}
              {% endif %}
    
            {% else %}
              {{ None }}
            {% endif %}
      - variables:
          kind: |
            {% set rt = normalized %}
            {% if rt is none %}
              none
            {% elif rt is string and rt|length >= 7 and rt[0:7] == 'person.' %}
              person
            {% elif rt is string and rt|length >= 7 and rt[0:7] == 'sensor.' %}
              cabinet
            {% elif rt is string
                  and rt is match("(?i)^[0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12}$") %}
              guid
            {% else %}
              label
            {% endif %}
          cab_json: |
            {% import 'zenos_ai/zen_os_1rc.jinja' as zen %}
            {{ zen.zen_cabinets(normalized) }}
          cab_obj: |
            {% set raw = cab_json | trim %}
            {% if raw in ['', None] %}
              {{ {"result": [], "error": "empty_input"} }}
            {% else %}
              {% set parsed = raw | from_json %}
              {% if parsed is mapping and 'result' in parsed %}
                {{ parsed }}
              {% else %}
                {{ {"result": parsed, "error": None} }}
              {% endif %}
            {% endif %}
      - variables:
          resolved_person_identity: |
            {% if resolved_person_identity is mapping %}
              {{ resolved_person_identity }}
            {% else %}
              {{ {"error": "person_not_resolved"} }}
            {% endif %}
          resolved_cabinet_identity: |
            {% if resolved_cabinet_identity is mapping %}
              {{ resolved_cabinet_identity }}
            {% else %}
              {{ {"error": "cabinet_not_resolved"} }}
            {% endif %}
          cab_obj: |
            {% if cab_obj is mapping %}
              {{ cab_obj }}
            {% else %}
              {{ {"error": "invalid_cabinet_result", "result": []} }}
            {% endif %}
          final_status: |
            {% if kind == 'person' %}
              {% if resolved_person_identity is mapping and resolved_person_identity.error is not defined %}
                success
              {% else %}
                {{ (resolved_person_identity.error if resolved_person_identity is mapping and resolved_person_identity.error is defined else 'error') }}
              {% endif %}
            {% else %}
              {% if cab_obj.error is defined and cab_obj.error not in [None, '', 'empty_input'] %}
                {{ cab_obj.error }}
              {% else %}
                success
              {% endif %}
            {% endif %}
          final_identity: |
            {# =============================================================
               CANONICAL FINAL IDENTITY SELECTION
               Priority:
                 1. PERSON lookup -> resolved_person_identity
                 2. CABINET lookup -> resolved_cabinet_identity
                 3. NONE (empty target) -> full roster
                 4. LABEL / GUID lookup -> cabinet_result passthrough
            ============================================================= #}
    
            {# --- 1. PERSON → identity --- #}
            {% if kind == 'person'
                  and resolved_person_identity is mapping
                  and (resolved_person_identity.error is not defined) %}
              {{ resolved_person_identity }}
    
            {# --- 2. CABINET → identity (reverse resolver) --- #}
            {% elif kind == 'cabinet'
                  and resolved_cabinet_identity is mapping
                  and (resolved_cabinet_identity.error is not defined) %}
              {{ resolved_cabinet_identity }}
    
            {# --- 3. NONE → return full roster of cabinets --- #}
            {% elif kind == 'none' %}
              {{ {
                  "identity_type": "roster",
                  "lookup": None,
                  "cabinets": cab_obj.result
              } }}
    
            {# --- 4. LABEL or GUID → fallback cabinet structure --- #}
            {% else %}
              {{ {
                  "identity_type": kind,
                  "lookup": normalized,
                  "cabinets": cab_obj.result
              } }}
            {% endif %}
          final_result: |
            {% set base = {
                "status": final_status,
                "target_raw": raw_target,
                "target_normalized": normalized,
                "kind": kind,
                "identity": final_identity,
                "timestamp": now().isoformat()
            } %}
    
            {% set extra = {} %}
    
            {% if debug %}
              {% set extra = extra | combine({
                "person_resolution": resolved_person_identity,
                "cabinet_result": cab_obj
              }) %}
            {% endif %}
    
            {{ base | combine(extra) }}
      - stop: Return Variables
        response_variable: final_result
