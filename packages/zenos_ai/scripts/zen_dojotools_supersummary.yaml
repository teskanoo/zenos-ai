script:
  zen_dojotools_supersummary:
    alias: Zen DojoTools SuperSummary
    description: >
      SuperSummary (3.5.8 RC1). Whole-home summarizer. Canon prompt engine aligned.
      Uses Kata cabinet as runtime truth. Writes ZEN_SUMMARY drawer. Guards all JSON
      + all missing drawers.
    icon: mdi:home-circle
    mode: queued
    max: 3
    fields:
      query:
        selector:
          text:
        name: Override Query
        description: Override the default summarization query.
      post_to_kata_cabinet:
        selector:
          boolean:
        name: Post to Kata Cabinet
        description: Post to the Kata Cabinet after summarization? (default false).
      supplemental_prompt:
        selector:
          text: null
        name: Supplemental Prompt
        description: Extra instructions appended at the end of the summarization prompt.
    sequence:
      - variables:
          dojo_cabinet: sensor.zen_dojo_cabinet
          kata_cabinet: sensor.zen_kata_storage_cabinet
          monk_response: {}
          filecabinet_response: {}
      - variables:
          zen_template: |-
            {{
              (
                (state_attr(kata_cabinet, 'variables') or {})
                  .get('zen_template', {})
                  .get('value', {})
                  .get('structure', {})
              )
              | to_json
            }}
      - variables:
          prompt_context: >-
            {% import 'zenos_ai/zen_os_1rc.jinja' as zen %}
    
            {% set cab_result  = zen.zen_cabinets('Friday') %} {% set idcard_raw  =
            zen.identity_cab_to_id_card(cab_result) | from_json %}
    
            {% set manifest    = zen.manifest_loader()    | from_json %} {% set
            capsule     = zen.ai_capsule(idcard_raw) | from_json %} {% set
            overview    = states['sensor.home_overview'].attributes | default({}) %}
            {% set kata_vars   = state_attr(kata_cabinet, 'variables') or {} %} {%
            set last_sum    = kata_vars.get('ZEN_SUMMARY', {}) %}
    
            {{
              {
                "identity":     idcard_raw,
                "manifest":     manifest,
                "capsule":      capsule,
                "overview":     overview,
                "last_summary": last_sum
              }
              | to_json
            }}
      - variables:
          last_summary: |-
            {{
              (
                state_attr(kata_cabinet, 'variables') or {}
              ).get('zen_summary', {}) | to_json
            }}
      - variables:
          active_components: >-
            {% set kata = state_attr(kata_cabinet, 'variables') or {} %} {% set
            active = {} %}
    
            {% for sw in expand(label_entities('Kung Fu System Switch'))
                  | selectattr('domain','eq','input_boolean')
                  | selectattr('state','eq','on')
                  | map(attribute='entity_id')
                  | list %}
    
              {% set key = sw
                | replace('input_boolean.','')
                | replace('_master_switch','') %}
    
              {% if key in kata %}
                {% set drawer = kata[key] %}
                {% set value  = drawer.get('value', {}) %}
                {% set active = active | combine({ key: value }) %}
              {% endif %}
            {% endfor %}
    
            {{ active }}
          active_component_ids: "{{ active_components.keys() | list }}"
      - variables:
          component_data: {}
      - repeat:
          for_each: "{{ active_components.keys() | list }}"
          sequence:
            - variables:
                comp_raw: |-
                  {{
                    (
                      state_attr(kata_cabinet, 'variables') or {}
                    ).get(repeat.item, {})
                  }}
            - variables:
                comp_drawer: |-
                  {% if comp_raw is string %}
                    {{ comp_raw | from_json }}
                  {% else %}
                    {{ comp_raw }}
                  {% endif %}
            - variables:
                component_data: |-
                  {{
                    dict(
                      component_data,
                      **{ repeat.item: comp_drawer.get('value', {}) }
                    )
                  }}
      - variables:
          default_query: >-
            Given the attached context, fill out the ZEN_SUMMARY schema. Return ONLY
            valid JSON matching the schema in zen_template. No markdown. No extra
            prose. Normalize all fields. If missing, return null or {}. Include ONLY
            active components. Provide Cliff's Notes for important events,
            anomalies, and near-term focus.
          query: "{{ query | default(default_query) }}"
          review_data: |-
            {{
              {
                "kata_cabinet": kata_cabinet,
                "prompt_context": prompt_context | default({}),
                "components": component_data | default({}),
                "last_summary": last_summary | default({})
              }
            }}
          example_data: |-
            {{
              (
                state_attr(kata_cabinet,'variables') or {}
              ).get('zen_template',{})
               .get('value',{})
               .get('example',{})
            }}
          prompt: |-
            {{
              {
                "query": query,
                "structure": zen_template,
                "example_data": example_data,
                "review_data": review_data,
                "supplemental_instructions": supplemental_prompt | default({})
              }
              | to_json
            }}
      - alias: Monk Runner
        action: ai_task.generate_data
        data:
          task_name: SuperSummary Monk
          instructions: "{{ prompt }}"
          entity_id: ai_task.gpt_oss_20b_local_ai_task
        response_variable: monk_response
        enabled: true
      - variables:
          zen_summary: "{{ monk_response.data | default({}) }}"
      - if:
          - condition: template
            value_template: "{{ zen_summary and (post_to_kata_cabinet == true) }}"
        then:
          - delay:
              milliseconds: 250
          - action: script.zen_dojotools_filecabinet
            data:
              action_type: update
              set_timestamp: true
              show_hidden_volumes: false
              force_action: true
              volume_entity_id:
                - "{{ kata_cabinet }}"
              key: ZEN_SUMMARY
              value: "{{ zen_summary }}"
              label_input: Zen Summary
            response_variable: filecabinet_response
      - variables:
          component: super_summary
          final_response: |-
            {{
              {
                "active_component_ids": active_component_ids | default([]),
                "monk": monk_response | default({}),
                "post": post_to_kata_cabinet | default(false),
                "filecabinet_write": filecabinet_response | default({})
              }
            }}
      - event: script.zen_dojotools_event_emitter
        event_data:
          component: "{{ component }}"
          severity: |-
            {% if final_response.filecabinet_write
                  and final_response.filecabinet_write.status == 'error' %}
              error
            {% else %}
              info
            {% endif %}
          kind: kata_emit
          summary: >-
            Script '{{ component }}' completed. Post-to-kata={{ final_response.post
            }}, filecabinet={{ final_response.filecabinet_write.status |
            default('unknown') }}.
          metadata:
            active_components: "{{ final_response.active_component_ids }}"
            post_to_kata: "{{ final_response.post }}"
            filecabinet_status: "{{ final_response.filecabinet_write.status | default('unknown') }}"
            filecabinet_message: "{{ final_response.filecabinet_write.message | default('') }}"
          kata: |-
            {{
              (
                final_response.monk.kata_excerpt
                if final_response.monk and final_response.monk.kata_excerpt is defined
                else {}
              )
            }}
          monk: |-
            {{
              (
                final_response.monk.event_excerpt
                if final_response.monk and final_response.monk.event_excerpt is defined
                else {}
              )
            }}
      - stop: Return Response
        response_variable: final_response
