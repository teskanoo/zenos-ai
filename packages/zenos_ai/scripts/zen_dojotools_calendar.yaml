script:
  zen_dojotools_calendar:
    alias: Zen Dojotools Calendar
    description: >-
      Zen Dojotools Calendar (1.10.3) for Home Assistant. Provides create and
      read support for all calendars. Update and delete are available for calendars
      that return event_ids (see help for locating event_id on supported calendars)
      for any calendar entity. Includes a structured Help function.
    
      Use '*' or '' as calendar_name to list all calendars. 'start' and 'end'
      default to today (midnight to midnight next day) if not set. Requires
      action_type and calendar_name for most actions.
    
      Updates and deletes operate by event_id match ONLY. If you cannot determine
      event_id, offer alternate suggestions you can perform with available toolset.
    
      Note: Some calendar providers (Google, HA Local, ICS sources) do NOT expose
      event_id on create/read/inspect responses. Update/Delete will be safely
      blocked in those cases. This is expected provider behavior, not a bug.
    
      See help for tips on locating event_id. Supports targeting calendar entities
      by label.
    sequence:
      - variables:
          action_type: "{{ action_type | default('read') }}"
          calendar_name: "{{ calendar_name | default('') }}"
          calendar_query: |-
            {{ (calendar_name in ['', None, '*'] and (label_targets | length == 0))
               or action_type == 'list' }}
          calendar_entity: |-
            {% if calendar_name[0:9] == 'calendar.' %}
              {{ calendar_name | lower | replace(' ', '_') }}
            {% else %}
              calendar.{{ calendar_name | lower | replace(' ', '_') }}
            {% endif %}
          valid_calendar_entities: "{{ states.calendar | map(attribute='entity_id') | map('lower') | list }}"
          calendar_entity_resolved: |-
            {% if calendar_entity in valid_calendar_entities %}
              {{ calendar_entity }}
            {% else %}
              {%- set target = '' -%}
              {%- for cal in states.calendar -%}
                {%- set fn = (cal.attributes.friendly_name | default('')) | lower -%}
                {%- if fn == (calendar_name | lower) and calendar_name not in ['', None, '*'] -%}
                  {%- set target = cal.entity_id | lower -%}
                {%- endif -%}
              {%- endfor -%}
              {{ target }}
            {% endif %}
          calendar_entity_exists: "{{ calendar_entity_resolved in valid_calendar_entities }}"
          start: >-
            {% set raw = start if start is defined else now().replace(hour=0,
            minute=0, second=0) %} {% if raw is string %}
              {% set dt = as_datetime(raw) if 'T' in raw else strptime(raw, "%Y-%m-%d") %}
            {% else %}
              {% set dt = raw %}
            {% endif %} {{ dt | as_local | as_timestamp |
            timestamp_custom("%Y-%m-%dT%H:%M:%S%:z", false) }}
          end: >-
            {% set raw = end if end is defined else (now().replace(hour=0, minute=0,
            second=0) + timedelta(days=1)) %} {% if raw is string %}
              {% set dt = as_datetime(raw) if 'T' in raw else strptime(raw, "%Y-%m-%d") %}
            {% else %}
              {% set dt = raw %}
            {% endif %} {{ dt | as_local | as_timestamp |
            timestamp_custom("%Y-%m-%dT%H:%M:%S%:z", false) }}
          event_id: "{{ event_id | default('') }}"
          label_targets: |-
            {{
              (
                label_targets|default('')
                if label_targets is iterable and label_targets is not string
                else (label_targets|default('')).splitlines() if '\n' in (label_targets|default(''))
                else (label_targets|default('')).split(',')
              )
              | map('trim')
              | map('lower')
              | select('string')
              | reject('equalto', '')
              | list
            }}
          label_target_entities: |-
            {{
              label_targets
              | map('label_entities')
              | sum(start=[])
              | select('match', '^calendar\\.')
              | unique
              | list
            }}
          target_calendars: |-
            {% if label_target_entities %}
              {{ label_target_entities }}
            {% elif calendar_entity_exists %}
              [ "{{ calendar_entity_resolved }}" ]
            {% else %}
              []
            {% endif %}
          target_is_multi: "{{ (label_target_entities | count > 0) }}"
      - choose:
          - conditions:
              - condition: template
                value_template: >-
                  {{ action_type in ['create','update','delete'] and target_is_multi
                  }}
            sequence:
              - variables:
                  final_response: |-
                    {{
                      {
                        "status": "error",
                        "message": "Multiple calendars match the query. Please specify a single calendar for this action."
                      } | tojson
                    }}
              - stop: null
                response_variable: final_response
              - set_conversation_response: "{{ final_response }}"
            alias: multiple targets error
          - conditions:
              - condition: template
                value_template: >-
                  {{ action_type == 'read' and label_targets | length > 0 and
                  target_calendars | length == 0 }}
            sequence:
              - variables:
                  final_response: |-
                    {{
                      {
                        "status": "error",
                        "message": "No calendars found for labels: " ~ (label_targets | join(', ')) ~ "."
                      } | tojson
                    }}
              - stop: null
                response_variable: final_response
              - set_conversation_response: "{{ final_response }}"
            alias: no calendar for label error
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ action_type == 'help' }}"
            sequence:
              - variables:
                  help_data: |-
                    {{
                      {
                        "status": "info",
                        "message": "This is the Zen Dojotools Calendar Help function.",
                        "actions": {
                          "read": "Reads events from a given calendar. Requires 'calendar_name'. Optional: 'start', 'end'.",
                          "inspect": "Advanced read using the system inspect tool; shows event_id if provider supports it.",
                          "create": "Creates a new event. Requires 'calendar_name' and 'summary'.",
                          "delete": "Deletes by event_id ONLY. Provider must expose event_id.",
                          "update": "Updates by event_id ONLY. Provider must expose event_id.",
                          "help": "Returns this help response."
                        },
                        "defaults": {
                          "start": "Defaults to today at 00:00 local time.",
                          "end": "Defaults to tomorrow at 00:00 local time.",
                          "timestamp_normalization": "Calendar providers return timestamps in varying formats (UTC or local offset). Normalize externally during UAT."
                        },
                        "notes": [
                          "Use '*' or blank for 'calendar_name' to list all calendars.",
                          "Deletes/updates operate ONLY by event_id. No summary matching.",
                          "If your read does not return event_id, inspect the entity_id directly.",
                          "If multiple events match, update/delete is blocked.",
                          "Some providers (Google, HA Local, ICS) do not expose event_id; update/delete will be safely blocked.",
                          "Label targeting aggregates events across all matching entities."
                        ]
                      } | tojson
                    }}
              - stop: null
                response_variable: help_data
              - set_conversation_response: "{{ help_data }}"
            alias: Return help
          - conditions:
              - condition: template
                value_template: >-
                  {{ not calendar_entity_exists and calendar_name not in ['', None,
                  '*'] }}
            sequence:
              - variables:
                  final_response: |-
                    {{
                      {
                        "status": "error",
                        "message": "No valid calendar entity_id found for '{{ calendar_name }}'. Provide a valid entity_id or use '*' to list calendars."
                      } | tojson
                    }}
              - stop: null
                response_variable: final_response
              - set_conversation_response: "{{ final_response }}"
            alias: invalid entity_id error
          - conditions:
              - condition: template
                value_template: >-
                  {{ action_type == 'create' and (label_targets | length == 0) and
                  (calendar_name in ['', None, '*'] or not calendar_entity_exists)
                  }}
            sequence:
              - variables:
                  final_response: |-
                    {{
                      {
                        "status": "error",
                        "message": "Create requires a single explicit calendar target (entity_id or label)."
                      } | tojson
                    }}
              - stop: null
                response_variable: final_response
              - set_conversation_response: "{{ final_response }}"
            alias: create requires explicit target
          - conditions:
              - condition: template
                value_template: |
                  {{ calendar_query
                     or (action_type in ['read','update']
                         and not calendar_entity_exists
                         and (label_targets | length == 0)) }}
            sequence:
              - variables:
                  cal_list: |-
                    [
                    {%- for cal in states.calendar -%}
                      {
                        "entity_id": "{{ cal.entity_id }}",
                        "friendly_name": "{{ cal.attributes.friendly_name | default('') }}",
                        "state": "{{ cal.state }}",
                        "labels": [{% for lid in labels(cal.entity_id) %}"{{ label_name(lid) }}"{% if not loop.last %}, {% endif %}{% endfor %}],
                        "start_time": "{{ cal.attributes.start_time | default('') }}",
                        "end_time": "{{ cal.attributes.end_time | default('') }}",
                        "location": "{{ cal.attributes.location | default('') }}",
                        "description": "{{ cal.attributes.description | default('') }}"
                      }{% if not loop.last %}, {% endif %}
                    {%- endfor -%}
                    ]
                  final_response: |-
                    {{
                      {
                        "status": "success",
                        "message": "Listed all available calendars.",
                        "calendars": cal_list
                      } | tojson
                    }}
              - stop: null
                response_variable: final_response
              - set_conversation_response: "{{ final_response }}"
            alias: return available calendars
          - conditions:
              - condition: template
                value_template: "{{ action_type == 'read' and target_calendars | length > 0 }}"
            sequence:
              - variables:
                  all_event_results: []
              - repeat:
                  for_each: "{{ target_calendars }}"
                  sequence:
                    - data:
                        start_date_time: "{{ start }}"
                        end_date_time: "{{ end }}"
                      response_variable: read_events
                      action: calendar.get_events
                      target:
                        entity_id: "{{ repeat.item }}"
                    - variables:
                        events: >-
                          {{ read_events[repeat.item]['events'] if
                          read_events[repeat.item] is defined else [] }}
                        event_list: |-
                          [
                            {%- for event in events -%}
                              {
                                "summary": "{{ event.summary }}",
                                "start": "{{ event.start }}",
                                "end": "{{ event.end }}",
                                "event_id": "{{ event.event_id | default('') }}",
                                "description": "{{ event.description | default('') }}",
                                "location": "{{ event.location | default('') }}",
                                "all_day": "{{ event.all_day | default(false) }}",
                                "created": "{{ event.created | default('') }}",
                                "updated": "{{ event.updated | default('') }}"
                              }{% if not loop.last %}, {% endif %}
                            {%- endfor -%}
                          ]
                        one_result: |-
                          {
                            "calendar_entity": "{{ repeat.item }}",
                            "event_count": {{ events | length }},
                            "events": {{ event_list }}
                          }
                    - variables:
                        all_event_results: "{{ all_event_results + [one_result] }}"
              - variables:
                  final_response: |
                    {{
                      {
                        "status": "success",
                        "message": "Aggregated events from " ~ (target_calendars | length) ~ " calendars.",
                        "results": all_event_results,
                        "note": "Use 'inspect' to locate event_id(s). Providers may return timestamps in UTC or offset; normalize externally during UAT."
                      }
                    }}
              - stop: null
                response_variable: final_response
              - set_conversation_response: "{{ final_response }}"
            alias: read events from calendar
          - conditions:
              - condition: template
                value_template: |
                  {{ action_type == 'inspect'
                     and not target_is_multi
                     and (calendar_entity_exists or label_target_entities | length == 1) }}
            sequence:
              - variables:
                  calendar_entity_list: >-
                    {% set ce = calendar_entity_resolved | default(none) %} {% if ce
                    %}
                      ["{{ ce }}"]
                    {% else %}
                      []
                    {% endif %}
              - action: script.dojotools_zen_inspect
                data:
                  entity_id: "{{ calendar_entity_list }}"
                  timeout: 30
                response_variable: inspect_response
              - variables:
                  final_response: "{{ inspect_response }}"
              - stop: null
                response_variable: final_response
              - set_conversation_response: "{{ final_response }}"
            alias: inspect calendar
          - conditions:
              - condition: template
                value_template: |
                  {{ action_type == 'create'
                     and not target_is_multi
                     and (calendar_entity_exists or label_target_entities | length == 1) }}
            sequence:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ start < end }}"
                    sequence:
                      - variables:
                          create_data: >-
                            {% set is_all_day = not 'T' in start and not 'T' in end
                            %} {% set d = {
                              'entity_id': (calendar_entity_resolved if calendar_entity_exists else label_target_entities[0]),
                              'summary': summary | default("Untitled Event")
                            } %} {% if is_all_day %}
                              {% set d = dict(d,
                                start_date=start.split('T')[0],
                                end_date=end.split('T')[0]
                              ) %}
                            {% else %}
                              {% set d = dict(d,
                                start_date_time=start,
                                end_date_time=end
                              ) %}
                            {% endif %} {% if description %}
                              {% set d = dict(d, description=description) %}
                            {% endif %} {% if location %}
                              {% set d = dict(d, location=location) %}
                            {% endif %} {% if attendees %}
                              {% set attendee_list = attendees.split(',') | map('trim') | list %}
                              {% set d = dict(d, attendees=attendee_list) %}
                            {% endif %} {{ d }}
                      - data: "{{ create_data }}"
                        action: calendar.create_event
                      - variables:
                          final_response: |-
                            {{
                              {
                                "status": "success",
                                "message": "Created calendar event '" ~ create_data.summary ~ "' on calendar '" ~ (
                                  (label_target_entities[0] if (label_target_entities | length > 0) else calendar_entity_resolved)
                                ) ~ "'.",
                                "event": create_data
                              } | tojson
                            }}
                      - stop: null
                        response_variable: final_response
                      - set_conversation_response: "{{ final_response }}"
                  - conditions:
                      - condition: template
                        value_template: "{{ start >= end }}"
                    sequence:
                      - variables:
                          final_response: |-
                            {{
                              {
                                "status": "error",
                                "message": "Invalid date range: start must be before end. Got start='" ~ start ~ "', end='" ~ end ~ "'."
                              } | tojson
                            }}
                      - stop: null
                        response_variable: final_response
                      - set_conversation_response: "{{ final_response }}"
            alias: create calendar event
          - conditions:
              - condition: template
                value_template: |
                  {{ action_type == 'update'
                     and not target_is_multi
                     and (calendar_entity_exists or label_target_entities | length == 1) }}
            sequence:
              - variables:
                  delete_data: |
                    {{
                      {
                        'entity_id': (calendar_entity_resolved if calendar_entity_exists else label_target_entities[0]),
                        'summary': summary,
                        'event_id': event_id,
                        'start_date_time': start,
                        'end_date_time': end
                      }
                    }}
              - action: script.zen_dojotools_calendar
                data:
                  action_type: delete
                  event_id: "{{ event_id }}"
                  calendar_name: "{{ calendar_entity_resolved }}"
                response_variable: zen_delete_response
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ zen_delete_response.status == 'error' }}"
                    sequence:
                      - variables:
                          final_response: "{{ zen_delete_response }}"
                      - stop: null
                        response_variable: final_response
                  - conditions:
                      - condition: template
                        value_template: "{{ zen_delete_response.status == 'not_found' }}"
                    sequence:
                      - variables:
                          warn_msg: No existing event matched. Creating new event.
                  - conditions:
                      - condition: template
                        value_template: "{{ zen_delete_response.status == 'success' }}"
                    sequence:
                      - variables:
                          warn_msg: ""
              - variables:
                  create_data: >-
                    {% set is_all_day = not 'T' in start and not 'T' in end %} {%
                    set d = {
                      'entity_id': (calendar_entity_resolved if calendar_entity_exists else label_target_entities[0]),
                      'summary': summary | default("Untitled Event")
                    } %} {% if is_all_day %}
                      {% set d = dict(d,
                        start_date=start.split('T')[0],
                        end_date=end.split('T')[0]
                      ) %}
                    {% else %}
                      {% set d = dict(d,
                        start_date_time=start,
                        end_date_time=end
                      ) %}
                    {% endif %} {% if description %}
                      {% set d = dict(d, description=description) %}
                    {% endif %} {% if location %}
                      {% set d = dict(d, location=location) %}
                    {% endif %} {% if attendees %}
                      {% set attendee_list = attendees.split(',') | map('trim') | list %}
                      {% set d = dict(d, attendees=attendee_list) %}
                    {% endif %} {{ d }}
              - data: "{{ create_data }}"
                action: calendar.create_event
              - variables:
                  final_response: |-
                    {{
                      {
                        "status": "success",
                        "message": "Updated event via delete+create on calendar '" ~ (
                          (label_target_entities[0] if (label_target_entities | length > 0) else calendar_entity_resolved)
                        ) ~ "'. " ~ (warn_msg | default("")),
                        "event": create_data
                      } | tojson
                    }}
              - stop: Pass response variables back to LLM
                response_variable: final_response
              - set_conversation_response: "{{ final_response }}"
            alias: update calendar event
          - conditions:
              - condition: template
                value_template: |
                  {{ action_type == 'delete'
                     and not target_is_multi
                     and (calendar_entity_exists or label_target_entities | length == 1) }}
            sequence:
              - variables:
                  SUPPORTED_FEATURES:
                    calendar:
                      name: CalendarEntityFeature
                      enum:
                        CREATE_EVENT: 1
                        DELETE_EVENT: 2
                        UPDATE_EVENT: 4
                  calendar_features: >-
                    {{ state_attr(calendar_entity_resolved, 'supported_features') |
                    int(0) }}
                  supports_delete: >
                    {% set want = SUPPORTED_FEATURES.calendar.enum.DELETE_EVENT %}
                    {% set have = calendar_features | int | bitwise_and(want) %} {{
                    have == want }}
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ not supports_delete }}"
                    sequence:
                      - action: script.dojotools_zen_inspect
                        data:
                          entity_id:
                            - "{{ calendar_entity_resolved }}"
                        response_variable: inspect_response
                      - variables:
                          final_response: |-
                            {{
                              {
                                "status": "error",
                                "message": "Delete requires a calendar entity that supports delete.",
                                "inspect": inspect_response | default({})
                              } | tojson
                            }}
                      - stop: null
                        response_variable: final_response
                      - set_conversation_response: "{{ final_response }}"
                  - conditions:
                      - condition: template
                        value_template: "{{ event_id is not defined or not event_id }}"
                    sequence:
                      - action: script.dojotools_zen_inspect
                        data:
                          entity_id:
                            - "{{ calendar_entity_resolved }}"
                        response_variable: inspect_response
                      - variables:
                          final_response: |-
                            {{
                              {
                                "status": "error",
                                "message": "Delete/update requires 'event_id'. The calendar provider did not expose an event_id for this event. This is an expected provider limitation; operation safely blocked.",
                                "inspect": inspect_response | default({})
                              } | tojson
                            }}
                      - stop: null
                        response_variable: final_response
                      - set_conversation_response: "{{ final_response }}"
                  - conditions: []
                    sequence:
                      - action: ms365_calendar.remove_calendar_event
                        data:
                          event_id: "{{ event_id }}"
                        target:
                          entity_id: "{{ calendar_entity_resolved }}"
                      - variables:
                          final_response: |-
                            {{
                              {
                                "status": "delete triggered",
                                "message": "Deleted calendar event '" ~ event_id ~ "'. If no event was found, this was a no-op.",
                                "entity_id": calendar_entity_resolved,
                                "event_id": event_id
                              } | tojson
                            }}
                      - stop: null
                        response_variable: final_response
                      - set_conversation_response: "{{ final_response }}"
            alias: delete event from calendar
    fields:
      action_type:
        selector:
          select:
            options:
              - create
              - read
              - inspect
              - update
              - delete
              - help
        default: help
      calendar_name:
        selector:
          text:
        required: false
      summary:
        selector:
          text:
        required: false
      description:
        selector:
          text:
            multiline: true
        required: false
      start:
        selector:
          text:
        required: false
      end:
        selector:
          text:
        required: false
      location:
        selector:
          text:
        required: false
      attendees:
        selector:
          text:
            multiline: true
        required: false
      label_targets:
        selector:
          text:
            multiple: true
            multiline: true
        required: false
      event_id:
        selector:
          text:
        required: false
    icon: mdi:calendar
    mode: parallel
    max: 10
