script:
  zen_dojotools_manifest:
    alias: Zen DojoTools Manifest (RC1)
    description: >
      Zen DojoTools Manifest (3.9.0 RC1) Sandbox Safe! Runtime-only health, zero
      persistent health storage. Authoritative manifest  scanner for AI_Cabinet
      volumes. Extracts users, metadata, context, capacity, access flags, ACLs,
      drawers. Writes ONLY the compiled manifest to the Zen Default Household
      cabinet.
    icon: mdi:home-map-marker
    fields:
      show_hidden:
        selector:
          boolean:
        name: show hidden
        description: Include hidden/system volumes in results?
    sequence:
      - variables:
          zen_default_house_cab: |-
            {{ expand(label_entities('Zen Default Household Cabinet'))
              | selectattr('domain','eq','sensor')
              | map(attribute='entity_id')
              | list
              | first
              | default() }}
          manifest_key: zen_library_manifest
          read_hidden: "{{ show_hidden | default(false) }}"
          hide_labels:
            - hidden_volume
            - read_only_volume
            - system_volume
            - hidden_cabinet
            - read_only_cabinet
            - system_cabinet
          exempt_labels:
            - internal
            - hidden
            - system
          ignore_label_prefixes:
            - _
            - .
          always_hide_drawers:
            - AI_Cabinet_VolumeInfo
          max_chars: 131072
          warn_threshold: 0.8
          controller_schema: 1
          manifest: |-
            {% macro compute_health(info, pct_chars, writeable, readable) %}
              {%- set expected_guid = info.get('id') %}
              {%- set actual_guid   = info.get('id') %}
              {%- set guid_mismatch = (expected_guid != actual_guid) %}
              {%- set storage_warning = (pct_chars >= (warn_threshold * 100)) %}
    
              {%- set status = 'ready' %}
              {%- if guid_mismatch %}
                {%- set status = 'error' %}
              {%- elif storage_warning %}
                {%- set status = 'warning' %}
              {%- endif %}
    
              {
                "status": "{{ status }}",
                "guid_mismatch": {{ guid_mismatch | tojson }},
                "storage_warning": {{ storage_warning | tojson }},
                "writeable": {{ writeable | tojson }},
                "readable": {{ readable | tojson }}
              }
            {% endmacro %}
    
            {% macro build_drawer_index(vars) %}
              {% if vars is mapping
                    and vars.get('_label_index') is mapping
                    and vars['_label_index'].get('value') is defined %}
                {{ vars['_label_index']['value'] | tojson }}
              {% else %}
                {{ {} | tojson }}
              {% endif %}
            {% endmacro %}
    
            {% macro acls_by_category(info) %}
              {%- set raw_acls = info.get('acls', {}) %}
              {%- set ns = namespace(by_cat={}, nested=[]) %}
    
              {%- for category, entries in raw_acls.items() if entries is sequence %}
                
                {%- set ns.nested = [] -%}
    
                {%- set direct  = entries | selectattr('entity_guid','defined') | map(attribute='entity_guid') | list %}
                {%- set family  = entries | selectattr('family_guid','defined') | map(attribute='family_guid') | list %}
    
                {%- for entry in entries if entry is mapping %}
                  {%- for k,v in entry.items() if v is mapping %}
                    {%- if 'entity_guid' in v %}{%- set ns.nested = ns.nested + [v.entity_guid] -%}{%- endif %}
                    {%- if 'family_guid' in v %}{%- set ns.nested = ns.nested + [v.family_guid] -%}{%- endif %}
                    {%- if 'household_guid' in v %}{%- set ns.nested = ns.nested + [v.household_guid] -%}{%- endif %}
                  {%- endfor %}
                {%- endfor %}
    
                {%- set merged = (direct + family + ns.nested) | reject('none') | unique | list %}
    
                {%- if merged | length > 0 %}
                  {%- set ns.by_cat = ns.by_cat | combine({ category: merged }) %}
                {%- endif %}
              {%- endfor %}
    
              {{ ns.by_cat | tojson }}
            {% endmacro %}
    
            {%- set result = namespace(data={}) %}
    
            {%- for ent in states.sensor | map(attribute='entity_id') | list %}
              {%- set vars = state_attr(ent, 'variables') %}
    
              {%- if vars is mapping and (vars.get('AI_Cabinet_VolumeInfo') is not none) %}
                {%- set info = vars.AI_Cabinet_VolumeInfo.value %}
                {%- set st = states[ent] %}
                {%- set friendly = st.attributes.friendly_name | default(ent) %}
                {%- set lc = st.last_changed.isoformat() %}
                {%- set lu = st.last_updated.isoformat() %}
                {%- set volume_labels = labels(ent) | default([]) %}
    
                {%- set skip_hidden =
                  (not read_hidden)
                  and (hide_labels | select('in', volume_labels) | list | count > 0)
                  and (volume_labels | select('in', exempt_labels) | list | count == 0)
                %}
                {%- if skip_hidden %}
                  {%- continue %}
                {%- endif %}
    
                {%- set raw_drawers = vars.keys() | list %}
                {%- set ns = namespace(drawers=[]) %}
                
                {%- for d in raw_drawers %}
                  {%- if d not in always_hide_drawers
                        and not d.startswith('_')
                        and not d.startswith('.') %}
                    {%- set val = vars.get(d, {}) %}
                    {%- set val_value = val.get('value') if val is mapping else {} %}
                
                    {%- if val is mapping and val_value is mapping and val_value.get('mount_point', false) %}
                      {%- set ns.drawers = ns.drawers + [
                        d ~ ' [mount:' ~ (
                          val_value.get('target_entity_id')
                          if val_value.get('target_entity_id')
                          else val_value.get('target_volume_id')
                          if val_value.get('target_volume_id')
                          else '?'
                        ) ~ ']'
                      ] %}
                    {%- else %}
                      {%- set ns.drawers = ns.drawers + [d] %}
                    {%- endif %}
                  {%- endif %}
                {%- endfor %}
                
                {%- set drawers = ns.drawers | sort %}
    
                {%- set raw_json = vars | tojson %}
                {%- set char_count = raw_json | length %}
                {%- set pct_chars = (char_count / max_chars * 100) | round(1) %}
                {%- set storage_warning = pct_chars >= (warn_threshold * 100) %}
    
                {%- set flags = info.get('flags', {}) %}
                {%- set writeable = (not flags.get('read_only', false))
                                    and (info.get('schema_version', 0) | float <= controller_schema)
                                    and not storage_warning %}
                {%- set readable = (not storage_warning) %}
    
                {%- set drawer_index = build_drawer_index(vars) | trim | from_json %}
                {%- set acls_obj = acls_by_category(info) | from_json %}
    
                {%- set health_obj =
                  compute_health(info, pct_chars, writeable, readable) | from_json
                %}
    
                {%- set rec = {
                  'entity_id': ent,
                  'friendly_name': friendly,
                  'context': vars.get('_context', {}),
                  'metadata': {
                    'id': info.get('id'),
                    'schema_version': info.get('schema_version'),
                    'labels': volume_labels | sort,
                    'timestamps': { 'last_changed': lc, 'last_updated': lu }
                  },
                  'stats': { 'drawer_count': drawers | count },
                  'capacity': {
                    'chars_used': char_count,
                    'chars_max': max_chars,
                    'percent_used': pct_chars,
                    'warning': storage_warning
                  },
                  'access': {
                    'writeable': writeable,
                    'readable': readable
                  },
                  'drawers': drawers,
                  'drawer_index': drawer_index,
                  'acls_by_category': acls_obj,
                  'health': health_obj
                } %}
    
                {%- set result.data = result.data | combine({ ent: rec }) %}
              {%- endif %}
            {%- endfor %}
    
            {{ result.data }}
      - event: set_variable_legacy
        event_data:
          key: "{{ manifest_key }}"
          value: "{{ manifest }}"
          set_timestamp: true
          volume_entity: "{{ zen_default_house_cab }}"
      - alias: Return Manifest Data
        stop: Pass variable to response
        response_variable: manifest
      - set_conversation_response: "{{ manifest }}"
