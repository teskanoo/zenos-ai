###############################################################################
# ZEN CABINET HEALTH â€” Canon Cabinet Validator
# Version 1.0.7 (RC1)
# Aligned with Zen Label Health (missing / unassigned / unhealthy).
# Required slots: strict 1:1. Optional slots: 0..N allowed.
###############################################################################

template:
  - sensor:
      - name: Zen Cabinet Health
        unique_id: zen_cabinet_health
        device_class: enum
        availability: "true"

        #######################################################################
        # STATE
        #######################################################################
        state: >-
          {% set required = [
            'system','dojo','kata',
            'default_household','default_family',
            'default_user','default_ai_user'
          ] %}

          {% set optional = [
            'household','family','user','ai_user',
            'history','index'
          ] %}

          {% set slot_to_label = {
            'system':'Zen System Cabinet',
            'dojo':'Zen Dojo Cabinet',
            'kata':'Zen Kata Cabinet',
            'household':'Zen Household Cabinet',
            'default_household':'Zen Default Household Cabinet',
            'family':'Zen Family Cabinet',
            'default_family':'Zen Default Family Cabinet',
            'user':'Zen User Cabinet',
            'default_user':'Zen Default User Cabinet',
            'ai_user':'Zen AI User Cabinet',
            'default_ai_user':'Zen Default AI User Cabinet',
            'history':'Zen History Cabinet',
            'index':'Zen Index Cabinet'
          } %}

          {% set parent_slug = 'Zen Cabinet' | slugify %}
          {% set all_cabs = label_entities(parent_slug) | list %}
          {% set label_index = labels() %}

          {% set ns = namespace(
            missing_req = [],
            unassigned_req = [],
            invalid_req = [],
            unhealthy_req = [],
            unhealthy_opt = []
          ) %}

          {# REQUIRED SLOTS: strict 1:1, label + cabinet health enforced #}
          {% for slot in required %}
            {% set label_slug = slot_to_label[slot] | slugify %}
            {% set label_exists = label_slug in label_index %}
            {% set ents = intersect(all_cabs, label_entities(label_slug) or []) | list %}
            {% set bad = ents | selectattr('state','in',['unavailable','unknown']) | list %}

            {% if not label_exists %}
              {% set ns.missing_req = ns.missing_req + [slot] %}
            {% elif ents | count == 0 %}
              {% set ns.unassigned_req = ns.unassigned_req + [slot] %}
            {% elif ents | count > 1 %}
              {% set ns.invalid_req = ns.invalid_req + [slot] %}
            {% elif bad | count > 0 %}
              {% set ns.unhealthy_req = ns.unhealthy_req + [slot] %}
            {% endif %}
          {% endfor %}

          {# OPTIONAL SLOTS: 0..N allowed, only health tracked #}
          {% for slot in optional %}
            {% set label_slug = slot_to_label[slot] | slugify %}
            {% set ents = intersect(all_cabs, label_entities(label_slug) or []) | list %}
            {% if ents | count > 0 %}
              {% set bad = ents | selectattr('state','in',['unavailable','unknown']) | list %}
              {% if bad | count > 0 %}
                {% set ns.unhealthy_opt = ns.unhealthy_opt + [slot] %}
              {% endif %}
            {% endif %}
          {% endfor %}

          {# Priority (labels-aligned):
             missing required  -> critical
             invalid required  -> error
             unhealthy required-> error
             unassigned required -> warn
             unhealthy optional  -> warn
             else -> ok
          #}
          {% if ns.missing_req | count > 0 %}
            critical
          {% elif ns.invalid_req | count > 0 %}
            error
          {% elif ns.unhealthy_req | count > 0 %}
            error
          {% elif ns.unassigned_req | count > 0 %}
            warn
          {% elif ns.unhealthy_opt | count > 0 %}
            warn
          {% else %}
            ok
          {% endif %}

        #######################################################################
        # ATTRIBUTES
        #######################################################################
        attributes:

          #####################################################################
          # LABEL HEALTH PASS-THROUGH
          #####################################################################
          label_health: >-
            {% set e = 'sensor.zen_label_health' %}
            {% set exists = states[e] is not none %}
            {% set st = states(e) %}
            {% set valid = exists and st not in ['unknown','unavailable', none] %}

            {% if valid and st == 'ok' %}
              ok
            {% else %}
              {{
                {
                  'state': (st if valid else None),
                  'more_detail': (states[e].entity_id if valid else {})
                }
              }}
            {% endif %}

          #####################################################################
          # REQUIRED + OPTIONAL
          #####################################################################
          required_cabinets: >-
            {{ [
              'system','dojo','kata',
              'default_household','default_family',
              'default_user','default_ai_user'
            ] }}

          optional_cabinets: >-
            {{ [
              'household','family','user','ai_user',
              'history','index'
            ] }}

          #####################################################################
          # EXISTING CABINETS (BY SLOT)
          #####################################################################
          existing_cabinets: >-
            {% set slots = [
              'system','dojo','kata',
              'household','default_household',
              'family','default_family',
              'user','default_user',
              'ai_user','default_ai_user',
              'history','index'
            ] %}
            {% set slot_to_label = {
              'system':'Zen System Cabinet',
              'dojo':'Zen Dojo Cabinet',
              'kata':'Zen Kata Cabinet',
              'household':'Zen Household Cabinet',
              'default_household':'Zen Default Household Cabinet',
              'family':'Zen Family Cabinet',
              'default_family':'Zen Default Family Cabinet',
              'user':'Zen User Cabinet',
              'default_user':'Zen Default User Cabinet',
              'ai_user':'Zen AI User Cabinet',
              'default_ai_user':'Zen Default AI User Cabinet',
              'history':'Zen History Cabinet',
              'index':'Zen Index Cabinet'
            } %}
            {% set all_cabs = label_entities('Zen Cabinet' | slugify) | list %}
            {% set ns = namespace(found=[]) %}

            {% for slot in slots %}
              {% set label_slug = slot_to_label[slot] | slugify %}
              {% set ents = intersect(all_cabs, label_entities(label_slug) or []) | list %}
              {% if ents | count > 0 %}
                {% set ns.found = ns.found + [slot] %}
              {% endif %}
            {% endfor %}

            {{ ns.found | join(', ') if ns.found else 'none' }}

          #####################################################################
          # MISSING REQUIRED CABINETS (LABEL OR ASSIGNMENT)
          #####################################################################
          missing_cabinets: >-
            {% set required = [
              'system','dojo','kata',
              'default_household','default_family',
              'default_user','default_ai_user'
            ] %}
            {% set slot_to_label = {
              'system':'Zen System Cabinet',
              'dojo':'Zen Dojo Cabinet',
              'kata':'Zen Kata Cabinet',
              'default_household':'Zen Default Household Cabinet',
              'default_family':'Zen Default Family Cabinet',
              'default_user':'Zen Default User Cabinet',
              'default_ai_user':'Zen Default AI User Cabinet'
            } %}
            {% set parent_slug = 'Zen Cabinet' | slugify %}
            {% set all_cabs = label_entities(parent_slug) | list %}
            {% set label_index = labels() %}
            {% set ns = namespace(miss=[]) %}

            {% for slot in required %}
              {% set label_slug = slot_to_label[slot] | slugify %}
              {% set label_exists = label_slug in label_index %}
              {% set ents = intersect(all_cabs, label_entities(label_slug) or []) | list %}
              {% if not label_exists or ents | count == 0 %}
                {% set ns.miss = ns.miss + [slot] %}
              {% endif %}
            {% endfor %}

            {{ ns.miss | join(', ') if ns.miss else 'none' }}

          #####################################################################
          # INVALID MULTIPLES (REQUIRED ONLY)
          #####################################################################
          invalid_multiples: >-
            {% set required = [
              'system','dojo','kata',
              'default_household','default_family',
              'default_user','default_ai_user'
            ] %}
            {% set slot_to_label = {
              'system':'Zen System Cabinet',
              'dojo':'Zen Dojo Cabinet',
              'kata':'Zen Kata Cabinet',
              'default_household':'Zen Default Household Cabinet',
              'default_family':'Zen Default Family Cabinet',
              'default_user':'Zen Default User Cabinet',
              'default_ai_user':'Zen Default AI User Cabinet'
            } %}
            {% set parent_slug = 'Zen Cabinet' | slugify %}
            {% set all_cabs = label_entities(parent_slug) | list %}
            {% set ns = namespace(dupe=[]) %}

            {% for slot in required %}
              {% set label_slug = slot_to_label[slot] | slugify %}
              {% set ents = intersect(all_cabs, label_entities(label_slug) or []) | list %}
              {% if ents | count > 1 %}
                {% set ns.dupe = ns.dupe + [slot] %}
              {% endif %}
            {% endfor %}

            {{ ns.dupe | join(', ') if ns.dupe else 'none' }}

          #####################################################################
          # SLOT ENTITIES (FULL MAP)
          #####################################################################
          slot_entities: >-
            {% set slots = [
              'system','dojo','kata',
              'household','default_household',
              'family','default_family',
              'user','default_user',
              'ai_user','default_ai_user',
              'history','index'
            ] %}
            {% set slot_to_label = {
              'system':'Zen System Cabinet',
              'dojo':'Zen Dojo Cabinet',
              'kata':'Zen Kata Cabinet',
              'household':'Zen Household Cabinet',
              'default_household':'Zen Default Household Cabinet',
              'family':'Zen Family Cabinet',
              'default_family':'Zen Default Family Cabinet',
              'user':'Zen User Cabinet',
              'default_user':'Zen Default User Cabinet',
              'ai_user':'Zen AI User Cabinet',
              'default_ai_user':'Zen Default AI User Cabinet',
              'history':'Zen History Cabinet',
              'index':'Zen Index Cabinet'
            } %}
            {% set all_cabs = label_entities('Zen Cabinet' | slugify) | list %}
            {% set ns = namespace(m={}) %}

            {% for slot in slots %}
              {% set label_slug = slot_to_label[slot] | slugify %}
              {% set ents = intersect(all_cabs, label_entities(label_slug) or []) | list %}
              {% set ns.m = ns.m | combine({ slot: ents }) %}
            {% endfor %}

            {{ ns.m | tojson }}

          #####################################################################
          # RESOLVER SUGGESTIONS (BY SLOT)
          #####################################################################
          resolver_suggestions: >-
            {% set required = [
              'system','dojo','kata',
              'default_household','default_family',
              'default_user','default_ai_user'
            ] %}
            {% set optional = [
              'household','family','user','ai_user',
              'history','index'
            ] %}
            {% set slot_to_label = {
              'system':'Zen System Cabinet',
              'dojo':'Zen Dojo Cabinet',
              'kata':'Zen Kata Cabinet',
              'household':'Zen Household Cabinet',
              'default_household':'Zen Default Household Cabinet',
              'family':'Zen Family Cabinet',
              'default_family':'Zen Default Family Cabinet',
              'user':'Zen User Cabinet',
              'default_user':'Zen Default User Cabinet',
              'ai_user':'Zen AI User Cabinet',
              'default_ai_user':'Zen Default AI User Cabinet',
              'history':'Zen History Cabinet',
              'index':'Zen Index Cabinet'
            } %}
            {% set parent_slug = 'Zen Cabinet' | slugify %}
            {% set all_cabs = label_entities(parent_slug) | list %}
            {% set label_index = labels() %}
            {% set ns = namespace(s={}) %}

            {% for slot in required + optional %}
              {% set label_slug = slot_to_label[slot] | slugify %}
              {% set label_exists = label_slug in label_index %}
              {% set ents = intersect(all_cabs, label_entities(label_slug) or []) | list %}
              {% set bad = ents | selectattr('state','in',['unavailable','unknown']) | list %}

              {% if not label_exists and slot in required %}
                {% set ns.s = ns.s | combine({ slot: "Missing required label: " ~ label_slug }) %}
              {% elif not label_exists and slot in optional %}
                {% set ns.s = ns.s | combine({ slot: "Optional label missing (OK): " ~ label_slug }) %}
              {% elif slot in required and ents | count == 0 %}
                {% set ns.s = ns.s | combine({ slot: "Required label present but no cabinet has it" }) %}
              {% elif slot in required and ents | count > 1 %}
                {% set ns.s = ns.s | combine({ slot: "Multiple cabinets claim this slot: " ~ (ents | join(', ')) }) %}
              {% elif bad | count > 0 %}
                {% set bad_ids = bad | map(attribute='entity_id') | list %}
                {% set ns.s = ns.s | combine({ slot: "Unhealthy cabinet(s): " ~ (bad_ids | join(', ')) }) %}
              {% else %}
                {% set ns.s = ns.s | combine({ slot: "OK" }) %}
              {% endif %}
            {% endfor %}

            {{ ns.s | tojson }}

          timestamp: "{{ now().isoformat() }}"
