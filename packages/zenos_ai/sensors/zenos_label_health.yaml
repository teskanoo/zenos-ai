###############################################################################
# ZEN LABEL HEALTH â€” Canon Label Validator
# Version 1.1.0 (Slug-Canonical)
# Description:
#   Validates the presence and health of all Zen labels against a canonical
#   list. Uses Home Assistant slugify (underscores) and the labels() index
#   as ground truth.
###############################################################################

template:
  - sensor:
      # sensor.zen_label_health
      - name: Zen Label Health
        unique_id: zen_label_health
        default_entity_id: sensor.zen_label_health
        device_class: enum
        variables:

          required_labels:
          - 'Zen Cabinet'
          - 'Zen System Cabinet'
          - 'Zen Dojo Cabinet'
          - 'Zen Kata Cabinet'
          - 'Zen Default Household'
          - 'Zen Default Family'
          - 'Zen User Cabinet'
          - 'Zen Default User Cabinet'
          - 'Zen AI User Cabinet'
          - 'Zen Default AI User Cabinet'
          - 'Zen Squirrel'
          - 'Zen Fusion'
          - 'Zen History Cabinet'
          - 'Zen Index Cabinet'
          - 'Zen Health'
          - 'Zen Household'
          - 'Zen Family'
          - 'Zen User'
          - 'Zen AI User'

          required_ids: >
            {{-  required_labels | map('slugify') | list -}}

          label_index: >
            {{- labels() -}}

          existing_label_ids: >
            {{- required_ids | select( 'in',  label_index) | list -}}

          # ----------------------------- #
          # 1. Missing label entirely
          # ----------------------------- #
          missing_label_ids: >
            {{- required_ids | reject( 'in',  existing_label_ids) | list -}}

          # ALL entities that are using a required label
          required_label_entities: >-
            {{- required_ids | map('label_entities') | list | sum(start=[]) -}}

          # [The Labels of] ALL entities that are using a required label
          required_label_entities_labels: >-
            {{- required_label_entities | map('labels') | sum(start=[]) | unique | list -}}

          # The required labels that have been assigned to an entity
          assigned_label_ids: >-
            {{- required_ids | select( 'in', required_label_entities_labels )  -}}

          # ----------------------------- #
          # 2. Unassigned: exists, 0 entities #
          # The required labels that have been assigned to an entity
          # ----------------------------- #
          unassigned_label_ids: >-
            {{- required_ids | reject( 'in', assigned_label_ids ) | list  -}}

          # ALL entities that are using a required label but which have no state ('unknown'/'unavailable')
          required_label_entities_bad: >-
            {{- required_label_entities | reject('has_state') | list -}}

          # [The Labels of] ALL entities that are using a required label but which have no state ('unknown'/'unavailable')
          required_label_entities_bad_labels: >-
            {{- required_label_entities_bad | map('labels') | sum(start=[]) | unique | list -}}

          healthy_label_ids: >-
            {{- required_ids 
              | reject( 'in', missing_label_ids ) 
              | reject( 'in', unassigned_label_ids ) 
              | reject( 'in', required_label_entities_bad_labels ) 
              | list 
            -}}

          # ---------------------------------------- #
          # 3. Unhealthy: one or more ents unavailable
          # ---------------------------------------- #
          unhealthy_label_ids: >-
            {{- required_ids | reject( 'in', healthy_label_ids ) | list -}}

        #availability: "true"

        #######################################################################
        # STATE
        #######################################################################
        state: >-
          {# ----------------------------- #}
          {# PRIORITY: missing > unhealthy > unassigned > ok #}
          {# ----------------------------- #}
          {%- set rv = 'ok' -%}
          {%- if missing_label_ids | count > 0 -%}
            {%- set rv = 'critical' -%}
          {%- elif unhealthy_label_ids | count > 0 -%}
            {%- set rv = 'error' -%}
          {%- elif unassigned_label_ids | count > 0 -%}
            {%- set rv = 'warn' -%}
          {%- endif -%}
          {{- rv -}}

        #######################################################################
        # ATTRIBUTES
        #######################################################################
        attributes:

          required_labels: >
            {{- required_labels | join(', ') -}}

          existing_label_ids: >
            {{- existing_label_ids | join(', ') if existing_label_ids else 'none' -}}

          # --------------------------------------------------------
          # 1. Missing label entirely
          # --------------------------------------------------------
          missing_label_ids: >-
            {{- missing_label_ids | join(', ') if missing_label_ids else 'none' -}}

          #######################################################################
          # BROKEN / UNASSIGNED / UNHEALTHY LABEL IDS
          #######################################################################

          # --------------------------------------------------------
          # # 2. Unassigned: exists, 0 entities #
          # Labels that...
          # a) Do not exist in the user's configuration (therefore unassigned - these were not included in v1.1.0)
          # b) Exist, but have not been assigned to an entity
          # --------------------------------------------------------
          # @todo: Remove: unassigned_label_ids_deprecated - Retained for output comparison
          # --------------------------------------------------------
          unassigned_label_ids_deprecated: >-
            {% set ns = namespace(unassigned=[]) %}

            {% for lid in required_ids %}
              {% if lid in label_index %}
                {% set ents = label_entities(lid) or [] %}
                {% if ents | count == 0 %}
                  {% set ns.unassigned = ns.unassigned + [lid] %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {{ ns.unassigned | join(', ') if ns.unassigned else 'none' }}

          unassigned_label_ids: >-
            {{ unassigned_label_ids | join(', ') if unassigned_label_ids else 'none' }}

          # --------------------------------------------------------
          # 3. Unhealthy: one or more ents unavailable
          # Labels that...
          # a) Do not exist in the user's configuration (therefore unassigned - these were not included in v1.1.0)
          # b) Exist, but have not been assigned to an entity (therefore unassigned - these were not included in v1.1.0)
          # c) Exist, AND have been assigned to an entity that has no value
          # --------------------------------------------------------
          # @todo: Remove: unhealthy_label_ids_deprecated - Retained for output comparison
          # --------------------------------------------------------
          unhealthy_label_ids_deprecated: >-
            {% set ns = namespace(unhealthy=[]) %}

            {% for lid in required_ids %}
              {% if lid in label_index %}
                {% set ents = label_entities(lid) or [] %}
                {% if ents | count > 0 %}
                  {% set bad = ents | selectattr('state','in',['unknown','unavailable']) | list %}
                  {% if bad | count > 0 %}
                    {% set ns.unhealthy = ns.unhealthy + [lid] %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {{ ns.unhealthy | join(', ') if ns.unhealthy else 'none' }}

          unhealthy_label_ids: >-
            {{ unhealthy_label_ids | join(', ') if unhealthy_label_ids else 'none' }}

          # --------------------------------------------------------
          # @todo: Remove: healthy_label_ids_deprecated - Retained for output comparison
          # --------------------------------------------------------
          healthy_label_ids_deprecated: >-
            {% set ns = namespace(ok=[]) %}
            {% for lid in required_ids %}
              {% if lid in label_index %}
                {% set ents = label_entities(lid) or [] %}
                {% if ents | count > 0 %}
                  {% set bad = ents | selectattr('state','in',['unavailable','unknown']) | list %}
                  {% if bad | count == 0 %}
                    {% set ns.ok = ns.ok + [lid] %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ ns.ok | join(', ') if ns.ok else 'none' }}

          healthy_label_ids: >-
            {{ healthy_label_ids | join(', ') if healthy_label_ids else 'none' }}

          timestamp: "{{ now().isoformat() }}"
