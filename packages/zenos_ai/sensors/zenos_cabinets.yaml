###############################################################################
#  ZENOS-AI â€” RING-0 CABINET PACKAGE (FULL EXPANDED VERSION)
#  File: zenos_cabinets.yaml
#
#  14 canonical Ring-0 Cabinets for ZenOS-AI.
#  - Fully depersonalized
#  - zenos_ namespace
#  - Deterministic unique_ids
###############################################################################

template:

  ###########################################################################
  # 1. SYSTEM CABINETS (6)
  ###########################################################################

  - trigger:
      - platform: event
        event_type: set_variable_zenos_system_cabinet
      - platform: event
        event_type: remove_variable_zenos_system_cabinet
      - platform: event
        event_type: clear_variables_zenos_system_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS System Cabinet"
        unique_id: zenos_system_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  - trigger:
      - platform: event
        event_type: set_variable_zenos_system_history_cabinet
      - platform: event
        event_type: remove_variable_zenos_system_history_cabinet
      - platform: event
        event_type: clear_variables_zenos_system_history_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS System History Cabinet"
        unique_id: zenos_system_history_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  - trigger:
      - platform: event
        event_type: set_variable_zenos_zen_dojo_cabinet
      - platform: event
        event_type: remove_variable_zenos_zen_dojo_cabinet
      - platform: event
        event_type: clear_variables_zenos_zen_dojo_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Dojo Cabinet"
        unique_id: zenos_zen_dojo_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  - trigger:
      - platform: event
        event_type: set_variable_zenos_zen_kata_cabinet
      - platform: event
        event_type: remove_variable_zenos_zen_kata_cabinet
      - platform: event
        event_type: clear_variables_zenos_zen_kata_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Kata Cabinet"
        unique_id: zenos_zen_kata_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  - trigger:
      - platform: event
        event_type: set_variable_zenos_zen_history_cabinet
      - platform: event
        event_type: remove_variable_zenos_zen_history_cabinet
      - platform: event
        event_type: clear_variables_zenos_zen_history_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS History Cabinet"
        unique_id: zenos_zen_history_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  - trigger:
      - platform: event
        event_type: set_variable_zenos_zen_scratchpad_cabinet
      - platform: event
        event_type: remove_variable_zenos_zen_scratchpad_cabinet
      - platform: event
        event_type: clear_variables_zenos_zen_scratchpad_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Scratchpad Cabinet"
        unique_id: zenos_zen_scratchpad_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  ###########################################################################
  # 2. DEFAULT HOUSEHOLD (2)
  ###########################################################################

  - trigger:
      - platform: event
        event_type: set_variable_zenos_default_household_cabinet
      - platform: event
        event_type: remove_variable_zenos_default_household_cabinet
      - platform: event
        event_type: clear_variables_zenos_default_household_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Default Household Cabinet"
        unique_id: zenos_default_household_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  - trigger:
      - platform: event
        event_type: set_variable_zenos_default_household_history_cabinet
      - platform: event
        event_type: remove_variable_zenos_default_household_history_cabinet
      - platform: event
        event_type: clear_variables_zenos_default_household_history_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Default Household History Cabinet"
        unique_id: zenos_default_household_history_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  ###########################################################################
  # 3. DEFAULT FAMILY (2)
  ###########################################################################

  - trigger:
      - platform: event
        event_type: set_variable_zenos_default_family_cabinet
      - platform: event
        event_type: remove_variable_zenos_default_family_cabinet
      - platform: event
        event_type: clear_variables_zenos_default_family_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Default Family Cabinet"
        unique_id: zenos_default_family_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  - trigger:
      - platform: event
        event_type: set_variable_zenos_default_family_history_cabinet
      - platform: event
        event_type: remove_variable_zenos_default_family_history_cabinet
      - platform: event
        event_type: clear_variables_zenos_default_family_history_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Default Family History Cabinet"
        unique_id: zenos_default_family_history_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  ###########################################################################
  # 4. DEFAULT USER (2)
  ###########################################################################

  - trigger:
      - platform: event
        event_type: set_variable_zenos_default_user_cabinet
      - platform: event
        event_type: remove_variable_zenos_default_user_cabinet
      - platform: event
        event_type: clear_variables_zenos_default_user_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Default User Cabinet"
        unique_id: zenos_default_user_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  - trigger:
      - platform: event
        event_type: set_variable_zenos_default_user_history_cabinet
      - platform: event
        event_type: remove_variable_zenos_default_user_history_cabinet
      - platform: event
        event_type: clear_variables_zenos_default_user_history_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Default User History Cabinet"
        unique_id: zenos_default_user_history_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  ###########################################################################
  # 5. DEFAULT AI USER (2)
  ###########################################################################

  - trigger:
      - platform: event
        event_type: set_variable_zenos_default_ai_user_cabinet
      - platform: event
        event_type: remove_variable_zenos_default_ai_user_cabinet
      - platform: event
        event_type: clear_variables_zenos_default_ai_user_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Default AI User Cabinet"
        unique_id: zenos_default_ai_user_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}

  - trigger:
      - platform: event
        event_type: set_variable_zenos_default_ai_user_history_cabinet
      - platform: event
        event_type: remove_variable_zenos_default_ai_user_history_cabinet
      - platform: event
        event_type: clear_variables_zenos_default_ai_user_history_cabinet
    action:
      - if: "{{ this.attributes.get('log_events', true) }}"
        then:
          - service: logbook.log
            data:
              name: "{{ trigger.event.event_type }}"
              message: >
                {{ trigger.event.data.key | default('-') }}
                {% if trigger.event.event_type.startswith('set_variable') -%}
                  : {{ trigger.event.data.value | default('not defined!') }}
                {%- endif %}
    sensor:
      - name: "ZenOS Default AI User History Cabinet"
        unique_id: zenos_default_ai_user_history_cabinet
        icon: mdi:file-cabinet
        state: Variables
        attributes:
          default_timestamp: true
          log_events: false
          variables: >
            {% set current = this.attributes.get('variables', {}) %}
            {% set evt = trigger.event.event_type %}
            {% set key = trigger.event.data.key %}
            {% set val = trigger.event.data.value %}
            {% set use_ts = trigger.event.data.get('set_timestamp', this.attributes.get('default_timestamp', false)) %}
            {% if evt.startswith('set_variable') and key is defined and val is defined %}
              {% set value = val.isoformat() if val is datetime else val %}
              {% if use_ts %}
                {% set new = { key: { 'value': value, 'timestamp': now().isoformat() } } %}
              {% else %}
                {% set new = { key: value } %}
              {% endif %}
              {{ dict(current, **new) }}
            {% elif evt.startswith('remove_variable') and key is defined %}
              {{ dict(current.items() | rejectattr('0', 'eq', key)) }}
            {% elif evt.startswith('clear_variables') %}
              {{ {} }}
            {% else %}
              {{ current }}
            {% endif %}
