###############################################################################
# ZenOS-AI — System Health Package
# All cabinets resolved STRICTLY by label:
#   label_entities('Zen Dojo Cabinet')
#   label_entities('Zen Kata Cabinet')
#   label_entities('Zen System Cabinet')
#
# Each resolved drawer is filtered to sensor.* domain and `| first`.
#
# Sensors:
#   - sensor.zen_monastery_health
#   - sensor.zen_summarizer_health
#   - sensor.zen_supersummary_health
###############################################################################

template:

  ###########################################################################
  # Cabinet Resolvers (Jinja helpers)
  # Resolves the FIRST sensor.* entity under each label.
  ###########################################################################
  - trigger:
      - platform: homeassistant
        event: start
      - platform: time_pattern
        minutes: "/5"
      - platform: event
        event_type: zen_event
        event_data:
          event:
            component: "monastery"
            kind: "refresh_health"
    sensor:
      - name: Zen Dojo Cabinet Resolved
        unique_id: zen_dojo_cabinet_resolved
        state: >-
          {% set sensors = states.sensor | map(attribute='entity_id') | list %}
          {% set labeled = label_entities('Zen Dojo Cabinet') | default([], true) %}
          {% set candidates = sensors | select('in', labeled) | list %}
          {{ candidates | first | default('unavailable') }}
        availability: >-
          {{
            (
              states.sensor | map(attribute='entity_id') | list
            )
            | select('in', label_entities('Zen Dojo Cabinet'))
            | list
            | count > 0
          }}

      - name: Zen Kata Cabinet Resolved
        unique_id: zen_kata_cabinet_resolved
        state: >-
          {% set sensors = states.sensor | map(attribute='entity_id') | list %}
          {% set labeled = label_entities('Zen Kata Cabinet') | default([], true) %}
          {% set candidates = sensors | select('in', labeled) | list %}
          {{ candidates | first | default('unavailable') }}
        availability: >-
          {{
            (
              states.sensor | map(attribute='entity_id') | list
            )
            | select('in', label_entities('Zen Kata Cabinet'))
            | list
            | count > 0
          }}
    
      - name: Zen System Cabinet Resolved
        unique_id: zen_system_cabinet_resolved
        state: >-
          {% set sensors = states.sensor | map(attribute='entity_id') | list %}
          {% set labeled = label_entities('Zen System Cabinet') | default([], true) %}
          {% set candidates = sensors | select('in', labeled) | list %}
          {{ candidates | first | default('unavailable') }}
        availability: >-
          {{
            (
              states.sensor | map(attribute='entity_id') | list
            )
            | select('in', label_entities('Zen System Cabinet'))
            | list
            | count > 0
          }}


  ###########################################################################
  # Shorthand variables used across all health sensors
  ###########################################################################
  - sensor:
      - name: Zen Summary Cabinets
        unique_id: zen_summary_cabinets
        state: "ok"
        attributes:
          dojo: "{{ states('sensor.zen_dojo_cabinet_resolved') }}"
          kata: "{{ states('sensor.zen_kata_cabinet_resolved') }}"
          system: "{{ states('sensor.zen_system_cabinet_resolved') }}"

  ###########################################################################
  # 1️⃣ ZEN MONASTERY HEALTH — global cognition rollup
  ###########################################################################
  - sensor:
      - name: Zen Monastery Health
        unique_id: zen_monastery_health
        device_class: enum
        availability: >-
          {{
            states('sensor.zen_dojo_cabinet_resolved') not in ['unknown','unavailable','none']
            and
            states('sensor.zen_kata_cabinet_resolved') not in ['unknown','unavailable','none']
            and
            states('sensor.zen_system_cabinet_resolved') not in ['unknown','unavailable','none']
          }}
        state: >-
          {#- -------- Resolve cabinets by label -------- #}
          {%- set dojo_cab = states('sensor.zen_dojo_cabinet_resolved') %}
          {%- set kata_cab = states('sensor.zen_kata_cabinet_resolved') %}

          {%- if dojo_cab in ['unknown','unavailable','none'] %}
            critical
          {%- elif kata_cab in ['unknown','unavailable','none'] %}
            critical
          {%- else %}
            {%- set kata = state_attr(kata_cab,'variables') %}
            {%- set dojo = state_attr(dojo_cab,'variables') %}
            {%- set summary = kata.get('zen_summary',{}) if kata else {} %}
            {%- set ts = summary.get('timestamp') %}
            {%- set recent = ts and (now() - as_datetime(ts) < timedelta(minutes=15)) %}
            {%- set stale = ts and (now() - as_datetime(ts) >= timedelta(minutes=15)) %}
            {%- set crit_stale = ts and (now() - as_datetime(ts) >= timedelta(minutes=30)) %}
            {%- set schema_ok =
              kata
              and kata.get('zen_template',{})
                      .get('value',{})
                      .get('structure',{}) is mapping %}

            {%- set active =
              expand(label_entities('Kung Fu System Switch'))
                | selectattr('state','eq','on')
                | map(attribute='entity_id')
                | list %}

            {%- set monk_err =
              states('sensor.last_super_summary_monk_status')
              in ['error','timeout','none','null'] %}

            {#- ------------------------ CRITICAL ------------------------ #}
            {%- if not schema_ok %}
              critical
            {%- elif monk_err and crit_stale %}
              critical
            {%- elif active|count > 0 and not summary %}
              critical

            {#- ------------------------- ERROR -------------------------- #}
            {%- elif monk_err %}
              error
            {%- elif crit_stale %}
              error
            {%- elif stale %}
              error

            {#- ------------------------ WARNING ------------------------- #}
            {%- elif not recent %}
              warning
            {%- elif active|count == 0 %}
              warning

            {#- --------------------------- OK --------------------------- #}
            {%- else %}
              ok
            {%- endif %}
          {%- endif %}
        attributes:
          dojo_cabinet: "{{ states('sensor.zen_dojo_cabinet_resolved') }}"
          kata_cabinet: "{{ states('sensor.zen_kata_cabinet_resolved') }}"
          system_cabinet: "{{ states('sensor.zen_system_cabinet_resolved') }}"

          system_ok: >-
            {{ states('sensor.zen_system_cabinet_resolved')
               not in ['unknown','unavailable','none'] }}
               
          dojo_ok: >-
            {{ states('sensor.zen_dojo_cabinet_resolved')
               not in ['unknown','unavailable','none'] }}
               
          kata_ok: >-
            {{ states('sensor.zen_kata_cabinet_resolved')
               not in ['unknown','unavailable','none'] }}
               
          schema_ok: >-
            {{
              (
                state_attr(states('sensor.zen_kata_cabinet_resolved'),'variables')
                  .get('zen_template',{})
                  .get('value',{})
                  .get('structure',{})
              ) is mapping
            }}

          ninja_summary_status: >-
            {{ states('sensor.zen_summarizer_health') }}
            
          supersummary_status: >-
            {{ states('sensor.zen_supersummary_health') }}

          active_components: >-
            {{
              expand(label_entities('Kung Fu System Switch'))
                | selectattr('state','eq','on')
                | map(attribute='entity_id')
                | list
            }}

          last_timestamp: >-
            {{
              (
                state_attr(states('sensor.zen_kata_cabinet_resolved'),'variables')
                  .get('zen_summary',{})
                  .get('timestamp')
              ) | default('none')
            }}

  ###########################################################################
  # 2️⃣ NINJA SUMMARIZER HEALTH
  ###########################################################################
  - sensor:
      - name: Zen Summarizer Health
        unique_id: zen_summarizer_health
        default_entity_id: sensor.zen_summarizer_health
        device_class: enum
        availability: >-
          {{
            states('sensor.zen_kata_cabinet_resolved') not in ['unknown','unavailable','none']
          }}
        state: >-
          {%- set kata_cab = states('sensor.zen_kata_cabinet_resolved') %}
          {%- if kata_cab in ['unknown','unavailable','none'] %}
            critical
          {%- else %}
            {%- set kata = state_attr(kata_cab,'variables') %}          
            {%- set drawer = kata.get('zen_scheduler',{}) %}
            {%- set ts = drawer.get('timestamp') %}
            {%- set stale = ts and (now() - as_datetime(ts) >= timedelta(minutes=20)) %}
            {%- set recent = ts and not stale %}
            {%- if not drawer %}
              error
            {%- elif stale %}
              warning
            {%- else %}
              ok
            {%- endif %}
          {%- endif %}
        attributes:
          kata_cabinet: "{{ states('sensor.zen_kata_cabinet_resolved') }}"
          last_timestamp: >-
            {{
              (
                state_attr(states('sensor.zen_kata_cabinet_resolved'),'variables')
                  .get('zen_scheduler',{})
                  .get('timestamp')
              ) | default('none')
            }}

  ###########################################################################
  # 3️⃣ SUPER SUMMARY (High Priestess)
  ###########################################################################
  - sensor:
      - name: Zen SuperSummary Health
        unique_id: zen_supersummary_health
        device_class: enum
        availability: >-
          {{
            states('sensor.zen_kata_cabinet_resolved') not in ['unknown','unavailable','none']
          }}
        state: >-
          {%- set kata_cab = states('sensor.zen_kata_cabinet_resolved') %}
          {%- if kata_cab in ['unknown','unavailable','none'] %}
            critical
          {%- else %}
            {%- set kata = state_attr(kata_cab,'variables') %}
            {%- set summary = kata.get('zen_summary',{}) %}
            {%- set monk = states('sensor.last_super_summary_monk_status') %}
            {%- set ts = summary.get('timestamp') %}
            {%- set stale = ts and (now() - as_datetime(ts) >= timedelta(minutes=15)) %}
            {%- set crit_stale = ts and (now() - as_datetime(ts) >= timedelta(minutes=30)) %}
            {%- if monk in ['error','timeout','none','null'] %}
              error
            {%- elif crit_stale %}
              error
            {%- elif stale %}
              warning
            {%- else %}
              ok
            {%- endif %}
          {%- endif %}
        attributes:
          kata_cabinet: "{{ states('sensor.zen_kata_cabinet_resolved') }}"
          monk_status: "{{ states('sensor.last_super_summary_monk_status') }}"
          last_timestamp: >-
            {{
              (
                state_attr(states('sensor.zen_kata_cabinet_resolved'),'variables')
                  .get('zen_summary',{})
                  .get('timestamp')
              ) | default('none')
            }}
