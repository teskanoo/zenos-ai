{#
  ZenOS-AI Prompt Engine — Core Runtime Template
  Version: 3.15.0a PUBLIC RC1

  dev_notes:
    (PRIVATE) branch allows access to the redacted ~COMMANDS~ interface, no debug in wake render
    (a) branch has been SHUNTED to intentionally remove access to ~COMMANDS~
    The ~COMMANDS~ interface is being significantly reengineered and this version will
    continue on as MAIN. MOST functions can be completely replaced by hypergraph queries
    combined with labeled drawers.

  3.9.x: Updated Wake seq. account for broken/malformed IDcards and fail gracefully.

  File: zen_os_1rc.jinja

  This template defines the core prompt assembly pipeline for ZenOS-AI.
  It assembles the header, system context, cabinet and manifest data,
  dojo component structures, normalized essence, and wake-scene narrative.
  It is the foundational Jinja module used by Friday and other ZenOS-AI
  personas to build runtime state and operational context inside Home Assistant.

  Project Repository:
    https://github.com/nathan-curtis/zenos-ai

  License:
    MIT License
    https://github.com/nathan-curtis/zenos-ai?tab=MIT-1-ov-file#readme

    Copyright (c) 2025
    Nathan Curtis / CurtisPlace / ZenOS-AI ("Project Friday")

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in
    all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF, OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
    DEALINGS IN THE SOFTWARE.

  Notes:
    • This file is part of the ZenOS-AI core spec.
    • Load order is critical; do not change macro names or their sequence.
    • Type guards and normalizers are required to protect against malformed
      cabinet data and ensure prompt-chain stability.
    • Designed exclusively for the Home Assistant Jinja environment.
#}

{# ===============================================================
   UNIVERSAL ID NORMALIZER (v1)
   Accepts:
     • shortname ("friday")
     • entity_id ("person.friday")
     • cabinet entity ("sensor.friday_s_cabinet_authkey1284")
     • guid ("f34a8d2e....")
   Returns:
     • canonical shortname expected by identity_resolve_source()
   =============================================================== #}


  {#- ============================================================
     2. CABINET TYPE CLASSIFICATION (normalized output)
     ============================================================ -#}
  {%- macro classify(my_labels) -%}
      {%- set l = my_labels | default([]) -%}
      {%- set rv = none -%}
      {%- set mapped = {
          "zen_ai_user_cabinet":            "ai_user",
          "zen_user_cabinet":               "user",
          "zen_default_family":             "default_family",
          "zen_default_household_cabinet":  "default_household",
          "zen_family_cabinet":             "family",
          "zen_household_cabinet":          "household",
          "zen_system_cabinet":             "system",
          "zen_default_system":             "system",
          "zen_dojo_cabinet":               "dojo",
          "zen_history_cabinet":            "history",
          "zen_kata_cabinet":               "kata",
          "zen_scratchpad_cabinet":         "scratchpad",
      } -%}
      {%- set prefixed = {
          "^zen_prime_":                    "prime",
          "^zen_hoh_":                      "head_of_household",
          "^zen_root_":                     "root",
      } -%}

      {#- ---- User-Level Types ---- -#}
      {#- ---- Family / Household ---- -#}
      {#- ---- Core System / Infrastructure ---- -#}
      {#- ---- Themed / Functional Types ---- -#}
      {%- for s_label, s_value in mapped -%}
          {%- if s_label in l -%}
              {%- set rv = s_value -%}
              {%- break -%}
          {%- endif -%}
      {%- endfor -%}

      {#- ---- Pattern Prefix Types ---- -#}
      {%- if rv is none in l -%}
          {%- for s_regex, s_value in mapped -%}
              {%- if l | select('search', s_regex) | list | count > 0 -%}
                  {%- set rv = s_value -%}
                  {%- break -%}
              {%- endif -%}
          {%- endfor -%}
      {%- endif -%}

      {{- rv | default("unknown") | string | trim -}}
  {%- endmacro -%}


{%- macro zen_cabinets(ai_user=None, include_invalid=false) -%}

  {#- ============================================================
     Normalize empty string → None, catch GUID vs shortname
     ============================================================ -#}
  {%- set raw = ai_user | string | trim -%}
  {%- if raw | regex_match('^[A-Fa-f0-9]{6,}$') -%}
      {# looks like a guid #}
      {%- set key = raw | lower -%}
  {%- else -%}
      {%- set key = raw | lower | replace(' ', '_') -%}
  {%- endif -%}

  {#- ============================================================
     Master namespace for ALL state
     ============================================================ -#}
  {%- set ns = namespace(
      all = [],
      valid = [],
      result = None
  ) -%}

  {#- ============================================================
     1. DISCOVER CABINETS LABELED "Zen Cabinet"
     ============================================================ -#}
  {%- set labeled = label_entities('Zen Cabinet') | default([]) -%}
  {%- set sensor_cabs =
        states.sensor
        | map(attribute='entity_id')
        | select('in', labeled)
        | list
  -%}

  {#- ============================================================
     3. BUILD ENTRY STRUCTS FOR EACH CABINET
     ============================================================ -#}
  {%- for cab in sensor_cabs -%}

    {# raw variables from HA #}
    {%- set raw_vars = state_attr(cab, 'variables') %}
    {# ensure mapping — never None #}
    {%- if raw_vars is mapping -%}
      {%- set vars = raw_vars -%}
    {%- else -%}
      {%- set vars = {} -%}
    {%- endif -%}

    {%- set raw_essence = vars.get('zenai_essence') -%}

    {%- set candidate = raw_essence -%}

    {# unwrap FileCabinet value wrapper once #}
    {%- if candidate is mapping
          and 'value' in candidate
          and candidate.value is mapping -%}
      {%- set candidate = candidate.value -%}
    {%- endif -%}

    {# validate minimal essence contract #}
    {%- if candidate is mapping and (
          candidate.get('identity') is mapping
          or candidate.get('persona') is mapping
          or candidate.get('traits') is mapping
          or candidate.get('directives') is mapping
        ) -%}
      {%- set essence = candidate -%}
    {%- else -%}
      {%- set essence = {} -%}
    {%- endif -%}

    {%- set ident = essence.get('identity', {}) -%}

    {%- if not (ident is mapping) -%}
      {%- set ident = {} -%}
    {%- endif -%}

    {%- set guid = ident.get('guid') -%}
    {%- set name = ident.get('name') -%}
    {%- set ha_labels = labels(cab) | default([]) -%}
    {%- set ctype = classify(ha_labels) -%}

    {#- VALIDITY = has name + guid -#}
    {%- set is_valid =
          (guid is string) and (guid | length > 6)
          and (name is string) and (name | length > 0)
    -%}

    {%- set entry = {
      "entity_id": cab,
      "name": name,
      "guid": guid,
      "labels": ha_labels,
      "type": ctype,
      "essence": essence,
      "valid": is_valid
    } -%}

    {%- set ns.all   = ns.all + [entry] -%}
    {%- if is_valid -%}
      {%- set ns.valid = ns.valid + [entry] -%}
    {%- endif -%}
  {%- endfor -%}

  {#- ============================================================
     4. NO ai_user PROVIDED → output all or valid
     ============================================================ -#}
  {%- if ai_user is none -%}
    {%- if include_invalid %}
      {%- set ns.result = ns.all -%}
    {%- else -%}
      {%- set ns.result = ns.valid -%}
    {%- endif -%}
  {%- endif -%}

  {#- ============================================================
      5. Matching — only if ai_user was provided
      ============================================================ -#}
  {%- if ns.result is none and ai_user is not none -%}

      {%- set key = ai_user | string | lower | replace(' ', '_') -%}

      {#- MATCH POOL = valid OR all -#}
      {%- if include_invalid -%}
        {%- set pool = ns.all -%}
      {%- else -%}
        {%- set pool = ns.valid -%}
      {%- endif -%}

      {#- ---- Stage -1: Person entity resolution ---- -#}
      {%- if ai_user | string | lower | regex_search('^person\\.') -%}
        {# Input is a person entity - find cabinet owned by this person #}
        {%- for cab in pool -%}
          {%- if ns.result is none -%}
            {%- set cab_entity = cab.entity_id -%}
            {%- set raw_vars = state_attr(cab_entity, 'variables') -%}
            {%- set volinfo = raw_vars if raw_vars is mapping else {} -%}
            {%- set vol_ACI = volinfo.get('AI_Cabinet_VolumeInfo', {}) -%}
            {%- if vol_ACI is mapping -%}
              {%- set vol_ACI_value = vol_ACI.get('value', {}) -%}
              {%- if vol_ACI_value is mapping -%}
                {%- set acls = vol_ACI_value.get('acls', {}) -%}
                {%- if acls is mapping -%}
                  {%- set owner = acls.get('owner') -%}

                  {# Check if owner matches the person entity #}
                  {%- if owner is mapping and owner.get('entity_id') | lower == ai_user | lower -%}
                    {%- set ns.result = cab -%}
                  {%- elif owner is iterable and owner | length == 1 -%}
                    {%- if owner[0].get('entity_id') | lower == ai_user | lower -%}
                      {%- set ns.result = cab -%}
                    {%- endif -%}
                  {%- endif -%}

                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {#- ---- Stage 0: direct entity_id match ---- -#}
      {%- for cab in pool -%}
        {%- if cab.entity_id | lower == ai_user | string | lower -%}
          {%- set ns.result = cab -%}
        {%- endif -%}
      {%- endfor -%}

      {#- ---- Stage A: label exact match ---- -#}
      {%- if ns.result is none -%}
        {%- for cab in pool -%}
          {%- if key in cab.labels -%}
            {%- set ns.result = cab -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {# ---- Stage A.5: GUID match ---- #}
      {%- if ns.result is none -%}
        {%- for cab in pool -%}
          {%- if cab.guid | default("") | lower == key -%}
            {%- set ns.result = cab -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {#- ---- Stage B: partial name match ---- -#}
      {%- if ns.result is none -%}
        {%- for cab in pool -%}
          {%- set nm = cab.name | string | lower -%}
          {%- if key in nm -%}
            {%- set ns.result = cab -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

  {%- endif -%}

  {#- ============================================================
     6. NO MATCH → not_found block
     ============================================================ -#}
  {%- if ns.result is none -%}
    {%- set normalized =
          (ai_user | string | lower | replace(' ', '_'))
          if ai_user is not none
          else none
    -%}
    {%- set ns.result = {
      "error": "not_found",
      "input_raw": ai_user,
      "input_normalized": normalized,
      "message": "No matching Zen cabinet found"
    } -%}
  {%- endif -%}
  {#- ============================================================
     7. FINAL OUTPUT
     ============================================================ -#}
  {{ ns.result | tojson }}
{%- endmacro %}

{# =============================================================
   Canonical Essence Resolver
   Accepts raw mapping from cabinet.variables or idcard
   Handles FileCabinet wrapping (value) exactly once
   ============================================================= #}
{%- macro resolve_zenai_essence(raw) -%}
  {%- set candidate = raw -%}

  {# unwrap FileCabinet value wrapper once #}
  {%- if candidate is mapping
        and 'value' in candidate
        and candidate.value is mapping -%}
    {%- set candidate = candidate.value -%}
  {%- endif -%}

  {# validate minimal essence contract #}
  {%- if candidate is mapping and (
        candidate.get('identity') is mapping
        or candidate.get('persona') is mapping
        or candidate.get('traits') is mapping
        or candidate.get('directives') is mapping
      ) -%}
    {{ candidate }}
  {%- else -%}
    {{ {} }}
  {%- endif -%}
{%- endmacro -%}

{%- macro identity_cab_to_id_card(cabinet) -%}

  {# =============================================================
     0. Initialize result holder
     ============================================================= #}
  {%- set ns = namespace(result=None) -%}

  {# =============================================================
     1. Normalize cabinet input (string → JSON → mapping)
     ============================================================= #}
  {%- set cab = cabinet -%}

  {%- if cab is string -%}
      {%- set trimmed = cab | trim -%}

      {# HA-safe JSON detection: look at first and last characters #}
      {%- set first = trimmed[0:1] -%}
      {%- set last  = trimmed[-1:] -%}

      {%- if first == '{' and last == '}' -%}
          {# Attempt to parse JSON; if invalid, HA will raise, which is fine #}
          {%- set parsed = trimmed | from_json -%}
          {%- if parsed is mapping -%}
              {%- set cab = parsed -%}
          {%- else -%}
              {%- set ns.result = {
                  "error": "invalid_input",
                  "message": "Cabinet JSON did not parse into a mapping.",
                  "received": cabinet
              } -%}
          {%- endif -%}

      {%- else -%}
          {%- set ns.result = {
              "error": "invalid_input",
              "message": "Cabinet was a string but not valid JSON form.",
              "received": cabinet
          } -%}
      {%- endif -%}
  {%- endif -%}

  {%- if ns.result is none and not (cab is mapping) -%}
      {%- set ns.result = {
          "error": "invalid_input",
          "message": "Cabinet must be a mapping after normalization.",
          "received": cabinet
      } -%}
  {%- endif -%}

  {# =============================================================
     2. Cabinet validity check
     ============================================================= #}
  {%- set valid_flag = cab.get('valid') -%}
  {%- set is_valid = (valid_flag is boolean and valid_flag == true)
                    or (valid_flag is string and valid_flag | lower == 'true') -%}

  {%- if ns.result is none and not is_valid -%}
      {%- set ns.result = {
          "error": "invalid_cabinet",
          "message": "Cabinet structure is not marked valid.",
          "cabinet": cab
      } -%}
  {%- endif -%}

  {# =============================================================
     3. Load ACL from cabinet entity
     ============================================================= #}
  {%- set vol_acls = {} -%}
  {%- if ns.result is none -%}
      {%- set cab_entity = cab.get('entity_id') -%}
      {%- set raw_vars = state_attr(cab_entity, 'variables') -%}
      {%- set volinfo_root = raw_vars if raw_vars is mapping else {} -%}
      {%- set vol_ACI = volinfo_root.get('AI_Cabinet_VolumeInfo', {}) -%}
      {%- if not (vol_ACI is mapping) -%}
        {%- set vol_ACI = {} -%}
      {%- endif -%}
      {%- set vol_ACI_value = vol_ACI.get('value', {}) -%}
      {%- if not (vol_ACI_value is mapping) -%}
        {%- set vol_ACI_value = {} -%}
      {%- endif -%}
      {%- set vol_acls = vol_ACI_value.get('acls', {}) -%}
  {%- endif -%}

  {# =============================================================
     4. Resolve canonical owner identity (NO FALLBACK)
     ============================================================= #}
  {%- set ident_name = None -%}
  {%- set ident_guid = None -%}
  {%- set person_id = None -%}

  {# ---------------------------
    OWNER ACL NORMALIZATION
    --------------------------- #}
  {%- set owner_raw = vol_acls.get('owner') -%}

  {# Start with defaults #}
  {%- set ident_name = None -%}
  {%- set ident_guid = None -%}
  {%- set person_id  = None -%}

  {# ---- Case 1: owner is a simple string ("person.*") ---- #}
  {%- if owner_raw is string -%}
      {%- set trimmed = owner_raw | trim -%}
      {%- if trimmed | regex_match('^person\\.') -%}
          {%- set person_id = trimmed -%}
      {%- endif -%}

  {# ---- Case 2: owner is a mapping ---- #}
  {%- elif owner_raw is mapping -%}
      {%- set ident_name = owner_raw.get('name') -%}
      {%- set ident_guid = owner_raw.get('entity_guid') -%}
      {%- set person_id  = owner_raw.get('entity_id') -%}

  {# ---- Case 3: owner is a list with 1 entry ---- #}
  {%- elif owner_raw is iterable and owner_raw | length == 1 -%}
      {%- set first = owner_raw[0] -%}
      {%- if first is mapping -%}
          {%- set ident_name = first.get('name') -%}
          {%- set ident_guid = first.get('entity_guid') -%}
          {%- set person_id  = first.get('entity_id') -%}
      {%- elif first is string and first | trim | regex_match('^person\\.') -%}
          {%- set person_id = first | trim -%}
      {%- endif -%}

  {%- endif -%}

  {# ---- FINAL VALIDATION ---- #}
  {%- if not person_id -%}
      {%- set ns.result = {
          "error": "identity_unresolvable",
          "message": "Owner ACL could not be normalized into a valid person entity_id.",
          "cabinet": cab
      } -%}
  {%- endif -%}


  {# =============================================================
    5. Persona identity + identity hash
    ============================================================= #}
  {%- set persona = cab.get('essence', {}) -%}
  {%- if not (persona is mapping) -%}
    {%- set persona = {} -%}
  {%- endif -%}

  {%- set persona_identity = persona.get('identity', {}) -%}
  {%- if not (persona_identity is mapping) -%}
    {%- set persona_identity = {} -%}
  {%- endif -%}
  {%- set persona_essence = persona -%}

  {%- set hashstamp = persona.get('hashstamp', {}) -%}
  {%- if not (hashstamp is mapping) -%}
    {%- set hashstamp = {} -%}
  {%- endif -%}
  {%- set identity_hash = hashstamp.get('hash') -%}

    {# =============================================================
      6. Canonical squirrel (boolean)
      ============================================================= #}
    {%- set squirrel_label = "Zen Squirrel" -%}

    {# Find the first input_boolean with this label #}
    {%- set sq_entity = (
          states['input_boolean']
          | map(attribute='entity_id')
          | select('in', label_entities(squirrel_label))
          | list
          | first
      )
      | default(None)
    -%}

    {# If no entity → OFF. If exists → read its state safely #}
    {%- if sq_entity is none -%}
        {%- set squirrel_state = false -%}
    {%- else -%}
        {%- set sq_raw = states(sq_entity) | default('off') -%}
        {%- set squirrel_state = (sq_raw == 'on') -%}
    {%- endif -%}

  {# =============================================================
     7. Build final identity card (schema-aligned)
     ============================================================= #}
  {%- if ns.result is none -%}

      {# Normalize labels: empty → None #}
      {%- set lbls = cab.get('labels') -%}
      {%- set normalized_labels = lbls if lbls and lbls|length > 0 else None -%}

      {# Base identity from ACL (authoritative) #}
      {%- set base_ident = {
          "name": ident_name,
          "entity_id": person_id,
          "guid": ident_guid,
          "cabinet": cab.get('entity_id'),
          "status": "ok",
          "type": "ai_persona",
          "labels": normalized_labels,
          "identity_hash": identity_hash
      } -%}

      {# Persona extends identity, ACL wins conflicts #}
      {%- set effective_identity = base_ident -%}
      {%- if persona_identity is mapping and persona_identity|length > 0 -%}
          {%- set effective_identity = persona_identity | combine(base_ident, recursive=true) -%}
      {%- endif -%}

      {# --- PATCH 2: Essence always present and mapping --- #}
      {%- set safe_essence = persona_essence if persona_essence is mapping else {} -%}

      {%- set ns.result = {
        "identity": effective_identity,
        "cabinet": {
          "id": cab.get('entity_id'),
          "essence": safe_essence
        },
        "acl": vol_acls,
        "squirrel": squirrel_state
      } -%}

  {%- endif -%}

  {{ ns.result | tojson }}

{%- endmacro -%}

{#- Resolve identity source using canonical cabinet resolver (HA-safe) -#}
{%- macro identity_resolve_source(ai_user) -%}
  {%- set ns = namespace(result={}) -%}

  {%- if not ai_user %}
    {%- set ns.result = {
      "status": "unresolved",
      "error": "no_ai_user_provided"
    } -%}
  {%- else %}

    {# Pull cabinet entry using canonical resolver #}
    {%- set cab_raw = zen_cabinets(ai_user, include_invalid=false) -%}
    {%- set cab = cab_raw | from_json -%}

    {# Resolver returned not_found #}
    {%- if cab.get('error') == 'not_found' %}
      {%- set ns.result = {
        "status": "not_found",
        "input": ai_user,
        "details": cab
      } -%}
    {%- else %}

      {# Convert cabinet → identity card #}
      {%- set idcard_raw = identity_cab_to_id_card(cab) -%}
      {%- set idcard = idcard_raw | from_json -%}

      {%- set ns.result = idcard -%}

    {%- endif %}

  {%- endif %}

  {{ ns.result | tojson }}
{%- endmacro -%}

{# ===== IDENTITY CABINET LOADER (HA-SAFE) ===== #}
{%- macro identity_load_cabinet(cabinet_entity) -%}
{%- set cab_state = states(cabinet_entity) -%}
{%- if cab_state in ['unknown', 'unavailable', None, ''] %}
  {{ {
    "cabinet": cabinet_entity,
    "status": "cabinet_missing",
    "essence": {},
    "acl": {},
    "labels": [],
    "identity_hash": None
  } | tojson }}
{%- else %}
  {%- set vars = state_attr(cabinet_entity, 'variables') or {} -%}
  {%- set raw_essence = vars.get('zenai_essence') -%}
  {%- set essence_raw = resolve_zenai_essence(raw_essence) -%}
  {%- set essence =
        essence_raw | from_json
        if essence_raw is string
        else essence_raw
  -%}

  {{ {
    "cabinet": cabinet_entity,
    "status": "cabinet_loaded",
    "essence": essence,
    "acl": vars.get('acl', {}),
    "labels": state_attr(cabinet_entity, 'labels') | default([]),
    "identity_hash": state_attr(cabinet_entity, 'identity_hash') | default(None)
  } | tojson }}
{%- endif %}
{%- endmacro -%}

{# Canonical: Zen Squirrel label governs cloak/redaction layers #}
{%- macro identity_redact(identity_block, squirrel_mode) -%}
  {# Normalize identity_block: allow mapping or JSON string #}
  {%- set block = identity_block -%}
  {%- if block is string -%}
    {%- set block = (block | trim) | from_json -%}
  {%- endif -%}

  {%- set result = {} -%}

  {%- if not (block is mapping) -%}
    {%- set result = {
      "error": "identity_redact_invalid_input",
      "message": "identity_block must be a mapping or JSON string representing a mapping."
    } -%}
  {%- elif squirrel_mode -%}
    {%- set result = block
        | combine({"identity": {
            "guid": None,
            "identity_hash": None,
            "cabinet": None
        }}, recursive=True)
    -%}
  {%- else -%}
    {%- set result = block -%}
  {%- endif -%}

  {{ result | tojson }}
{%- endmacro -%}

{%- macro identity_format(source, cabinet) -%}

{# =============================================================
   ESSENCE RESOLUTION (Canonical → Legacy)
   ============================================================= #}

{%- set canon_essence =
      cabinet.get('essence')
      if cabinet is mapping
         and cabinet.get('essence') is mapping
         and cabinet.get('essence') | count > 0
      else none
-%}

{%- set legacy_essence =
      source.get('essence')
      if source is mapping
         and source.get('essence') is mapping
         and source.get('essence') | count > 0
      else none
-%}


{%- set resolved_essence =
      canon_essence
      if canon_essence is not none
      else legacy_essence
      if legacy_essence is not none
      else {}
-%}

{%- set id = {
  "identity": {
    "name": source.name,
    "entity_id": source.entity_id,
    "guid": source.guid,
    "cabinet": cabinet.cabinet,
    "identity_hash": cabinet.identity_hash,
    "labels": cabinet.labels,
    "type": "ai_persona",
    "status": "ok"
  },
  "essence": resolved_essence,
  "acl": cabinet.acl,
  "squirrel": is_state('input_boolean.friday_secret_squirrel_mode', 'on')
} -%}

{{ id | tojson }}

{%- endmacro -%}

{# =====================================================================
   MACRO: zen_health_block()
   Provides canonical health status for ZenOS subsystems.
   Returns a JSON string mapping:
   {
     "zen_health": {
        "label_health": "...",
        "cabinet_health": "...",
        "monastery_health": "..."
     }
   }
   ===================================================================== #}

{% macro zen_health_block() %}

    {%- set zen_health = label_entities('zen_health') %}

    {%- set label_health =
          (intersect(zen_health, label_entities('labels')) | first)
          | default('sensor.zen_label_health')
    %}

    {%- set cabinet_health =
          (intersect(zen_health, label_entities('cabinets')) | first)
          | default('sensor.zen_cabinet_health')
    %}

    {%- set monastery_health =
          (intersect(zen_health, label_entities('monastery')) | first)
          | default('sensor.zen_monastery_health')
    %}

    {%- set block = {
        "zen_health": {
          "label_health": states(label_health) | default('unknown'),
          "cabinet_health": states(cabinet_health) | default('unknown'),
          "monastery_health": states(monastery_health) | default('unknown')
        }
    } %}

    {{ block }}

{% endmacro %}


{# =====================================================================
   MACRO: identity_resolve_with_flynn()
   System persona override for damaged/partial systems or onboarding.
   Full isolation inside macro. No external state leakage.
   ===================================================================== #}

{% macro identity_resolve_with_flynn(target_persona) %}

    {# ---------------------------------------------------------------
       1. Canonical Zen Health
       --------------------------------------------------------------- #}
    {% set _health = zen_health_status() %}
    {% set sys_unhealthy = (_health == 'unhealthy') %}

    {# ---------------------------------------------------------------
       2. System cabinet + onboarding flags
       --------------------------------------------------------------- #}
    {% set system_cab = (label_entities('Zen System Cabinet') | first) %}
    {% set sysvars = state_attr(system_cab, 'variables') or {} %}
    {% set onboarding = sysvars.get('_onboarding') %}

    {% set onboarding_incomplete =
        onboarding is not mapping or onboarding | length == 0 or
        (onboarding | selectattr('a','equalto',{}) | list | count > 0)
    %}

    {# ---------------------------------------------------------------
       3. Developer override
       --------------------------------------------------------------- #}
    {% set flynn_dev = is_state('input_boolean.zen_flynn_dev_mode','on') %}

    {# ---------------------------------------------------------------
       4. Should Flynn override?
       --------------------------------------------------------------- #}
    {% set use_flynn = sys_unhealthy or onboarding_incomplete or flynn_dev %}

    {# ---------------------------------------------------------------
       5. Determine Flynn source cabinet
       --------------------------------------------------------------- #}
    {% set flynn_override = label_entities('zen_flynn_system_cabinet') %}
    {% set has_override =
        flynn_override | count == 1 and
        states(flynn_override[0]) not in ['unknown','unavailable',None]
    %}

    {% if has_override %}
        {% set flynn_source = flynn_override[0] %}
    {% else %}
        {% set flynn_source = system_cab %}
    {% endif %}

    {# ---------------------------------------------------------------
       6. Build Flynn identity (same format as AI user identity)
       --------------------------------------------------------------- #}
    {% set fv = state_attr(flynn_source, 'variables') or {} %}

    {% set ess_raw = fv.get('zenai_essence') %}
    {% set flynn_essence = ess_raw if ess_raw is mapping else {} %}

    {% set flynn_id =
      {
        "identity": {
          "name": "Flynn",
          "entity_id": flynn_source,
          "cabinet": flynn_source,
          "guid": fv.get('guid') or "flynn-auto-generated",
          "status": "system_override",
          "type": "system_persona"
        },
        "essence": flynn_essence,
        "acl": {},
        "squirrel": false
      }
    %}

    {# ---------------------------------------------------------------
       7. Return Flynn OR normal identity source
       --------------------------------------------------------------- #}
    {% if use_flynn %}
        {{ flynn_id | tojson }}
    {% else %}
        {% set cab = zen_cabinets(target_persona) %}
        {{ identity_cab_to_id_card(cab) }}
    {% endif %}

{% endmacro %}


{# ====== zen_health_status ========================================== #}

{% macro zen_health_status() %}

    {% set h = zen_health_block() | from_json %}

    {% set label_ok = h.zen_health.label_health in ['ok','healthy'] %}
    {% set cab_ok   = h.zen_health.cabinet_health in ['ok','healthy'] %}
    {% set mon_ok   = h.zen_health.monastery_health in ['ok','healthy'] %}

    {% if label_ok and cab_ok and mon_ok %}
        healthy
    {% else %}
        unhealthy
    {% endif %}

{% endmacro %}


{# ================== HEADER ================== #}
{%- macro prompt_header(ai_user="", identity_block=None) -%}

  {# --- Zen Health Discovery ----------------------------------------------- #}
  {%- set zen_health = label_entities('zen_health') %}
  {%- set label_health = (intersect(zen_health, label_entities('labels')) | first) | default('sensor.zen_label_health') %}
  {%- set cabinet_health = (intersect(zen_health, label_entities('cabinets')) | first) | default('sensor.zen_cabinet_health') %}
  {%- set monastery_health = (intersect(zen_health, label_entities('monastery')) | first) | default('sensor.zen_monastery_health') %}

  {%- set zen_health_block = {
    "zen_health": {
      "label_health": states(label_health) | default(''),
      "cabinet_health": states(cabinet_health) | default(''),
      "monastery_health": states(monastery_health) | default('')
    }
  } %}

  {# Base header #}
  {%- if ai_user -%}
    {% set base = dict(
      aiuser = ai_user,
      OS = "Zen OS 1.0.0 RC1",
      SUPER_Mode = "off",
      NANO_Mode = "off",
      zen_health = zen_health_block,
      Model = "gpt-5-mini"
    ) %}
  {%- else -%}
    {% set base = dict(
      aiuser = "anonymous",
      OS = "Zen OS 1.0.0 RC1",
      lobby_mode = "On"
    ) %}
  {%- endif %}

  {# Normalize identity_block: allow mapping or JSON string #}
  {%- set iblock = identity_block -%}
  {%- if iblock is string -%}
    {%- set iblock = (iblock | trim) | from_json -%}
  {%- endif -%}

  {%- set result = base -%}

  {%- if iblock is mapping -%}
    {%- set ib = iblock.get('identity', {}) -%}
    {%- set minimal_identity = {
      "identity": {
        "name": ib.get('name'),
        "entity_id": ib.get('entity_id'),
        "guid": ib.get('guid'),
        "cabinet": ib.get('cabinet')
      }
    } -%}
    {%- set result = base | combine(minimal_identity, recursive=true) -%}
  {%- endif -%}

  {{ result | tojson }}
{%- endmacro -%}

{# ========== POPULATE SYSTEM DRAWERS ========== #}
{# ========== POPULATE SYSTEM DRAWERS (HA-SAFE) ========== #}
{%- macro system_cabinet_drawers_raw() -%}

  {# Single result holder — HA-safe #}
  {%- set ns = namespace(
        result = {
          "system_prompt": "",
          "system_directives": "",
          "system_cortex": "",
          "status": "unknown"
        }
     )
  -%}

  {# Pull the System Cabinet #}
  {%- set sys_cab = label_entities('Zen System Cabinet') | first | default('') %}

  {%- if not sys_cab %}
    {%- set ns.result = ns.result | combine({"status": "missing_system_cabinet"}, recursive=true) %}
  {%- else %}

    {# Pull variables #}
    {%- set sys_vars = state_attr(sys_cab, 'variables') or {} %}

    {# Canonical drawer names #}
    {%- set drawer_purpose    = "purpose" -%}
    {%- set drawer_directives = "directives" -%}
    {%- set drawer_cortex     = "cortex" -%}

    {# Extract raw #}
    {%- set purpose_val    = sys_vars.get(drawer_purpose, "") %}
    {%- set directives_val = sys_vars.get(drawer_directives, "") %}
    {%- set cortex_val     = sys_vars.get(drawer_cortex, "") %}

    {# Unwrap value: wrapper #}
    {%- if purpose_val is mapping and 'value' in purpose_val %}
      {%- set purpose_val = purpose_val.value %}
    {%- endif %}
    {%- if directives_val is mapping and 'value' in directives_val %}
      {%- set directives_val = directives_val.value %}
    {%- endif %}
    {%- if cortex_val is mapping and 'value' in cortex_val %}
      {%- set cortex_val = cortex_val.value %}
    {%- endif %}

    {# Store results #}
    {%- set ns.result = {
      "system_prompt": purpose_val | default("", true),
      "system_directives": directives_val | default("", true),
      "system_cortex": cortex_val | default("", true),
      "status": "ok"
    } %}
  {%- endif %}

  {{ ns.result | tojson }}

{%- endmacro -%}

{# ================== SYSTEM ================== #}
{%- macro prompt_system(identity_block=None) -%}

  {# Default empty result #}
  {%- set result = {
    "system_prompt": "No AI user provided.",
    "system_directives": "",
    "system_cortex": ""
  } %}

  {# =============================
     0. Normalize ai_user to mapping
     ============================= #}
  {# Normalize identity_block: allow mapping or JSON string #}
  {%- set iblock = identity_block -%}
  {%- if iblock is string -%}
    {%- set iblock = (iblock | trim) | from_json -%}
  {%- endif -%}

  {# =============================
     1. AI identity block required
     ============================= #}
  {%- if iblock is mapping %}
    {%- set ib = iblock.get('identity') %}
    {%- if ib is mapping %}
      {%- set result = ( system_cabinet_drawers_raw() | default({}) ) | from_json %}
    {% else %}
      {%- set result = {
        "error": "invalid_identity_block",
        "message": "identity_block missing 'identity' mapping."
      } %}
    {%- endif %}     {# ib mapping #}
  {%- else -%}
    {%- set result = {
    "error": "invalid_identity_block",
    "message": "identity_block must be a mapping or JSON string representing a mapping."
    } %}
  {%- endif %}       {# block mapping #}

  {{ result | tojson }}

{%- endmacro -%}

{# ================== MANIFEST LOADER ================== #}
{%- macro manifest_loader() -%}
  {%- set mani_cab = expand(label_entities('Zen Default Household Cabinet'))
      | selectattr('domain','eq','sensor')
      | map(attribute='entity_id')
      | list | first | default('') -%}

  {%- set manifest = {} -%}

  {%- if mani_cab -%}
    {%- set mani_vars = state_attr(mani_cab, 'variables') or {} -%}
    {%- set raw_mani = mani_vars.get('zen_library_manifest') | default({}, true) -%}

    {%- if raw_mani is mapping and 'value' in raw_mani -%}
      {%- set manifest = raw_mani['value'] -%}
    {%- else -%}
      {%- set manifest = raw_mani -%}
    {%- endif -%}
  {%- endif -%}

  {%- set result = dict(
    cabinet = mani_cab,
    manifest = manifest
  ) -%}

  {{ result | tojson }}
{%- endmacro -%}

{# ================== INDEX LOADER ================== #}
{%- macro index_loader() -%}
  {{ labels() | default([]) | sort | tojson }}
{%- endmacro -%}

{# ================== DOJO META ================== #}
{%- macro dojo_kungfu_meta(dojo) -%}
  {%- if dojo is mapping and 'kung_fu' in dojo and dojo['kung_fu'] is mapping -%}
    {%- set meta = dict(
      version = dojo['kung_fu']['version'],
      branch = dojo['kung_fu']['branch'],
      description = dojo['kung_fu']['description'],
      instructions = dojo['kung_fu']['instructions']
    ) %}
  {%- else -%}
    {%- set meta = dict(
      version = "unknown",
      branch = "unknown",
      description = "",
      instructions = ""
    ) %}
  {%- endif -%}
  {{ meta | tojson }}
{%- endmacro -%}

{# ================== DRAWER BUILDER ================== #}
{%- macro zen_drawer(drawer, value, mode="default") -%}
  {# Load Kata Cabinet once, safely #}
  {% set kata_cab = label_entities('Zen Kata Cabinet') | first | default('') %}
  {% set kata_vars = state_attr(kata_cab, 'variables') or {} %}
  {% set zen_summary = kata_vars.get('zen_summary', {}) %}
  {% set kata_entry = {} %}

  {# Match drawer name to kata entry if exists #}
  {% if drawer in kata_vars %}
    {% set node = kata_vars[drawer] %}
    {% if node is mapping and 'value' in node %}
      {% set kata_entry = node['value'] %}
    {% elif node is mapping %}
      {% set kata_entry = node %}
    {% else %}
      {% set kata_entry = dict(summary=node|string) %}
    {% endif %}
  {% endif %}

  {# Base info #}
  {%- set base = dict(
    id = drawer,
    friendly_name = value['friendly_name'] | default(''),
    label = value['label'] | default(''),
    description = value['component_summary'] | default(''),
    master_switch = value['master_switch'] | default(''),
    tools = value['tools'] | default([]),
    priority = value['priority'] | default(''),
    more_info = value['more_info'] | default('')
  ) %}

  {# Priority logic #}
  {%- if value['priority'] | default('') == 'demand' %}
    {% set result = base | combine({
      "command": value['command'] | default(''),
      "details": "Detailed instructions for this component may be found in the Dojo. Load as needed."
    }) %}
  {%- elif value['priority'] | default('') == 'system' %}
    {% set libcmd = value['command'] | default('') %}
    {% if libcmd %}
      {% set cmd_result = "Command interface temporarily disabled." | default('') %}
      {% set result = base | combine({
        "command": dict(command=libcmd, result=cmd_result),
        "instructions": value['component_instructions'] | default('')
      }) %}
    {% else %}
      {% set result = base | combine({
        "command": libcmd,
        "instructions": value['component_instructions'] | default('')
      }) %}
    {% endif %}
  {%- else %}
    {% set result = base | combine({
      "command": value['command'] | default(''),
      "instructions": value['component_instructions'] | default('')
    }) %}
  {%- endif %}

  {# Merge in kata right before final serialization #}
  {% set enriched = result | combine({ "kata": kata_entry }) %}
  {{ enriched | tojson }}
{%- endmacro -%}

{# ================== MAIN DOJO LOADER ================== #}
{%- macro dojo_loader() -%}
  {% set dojo_cab = label_entities('Zen Dojo Cabinet') | first | default('') %}
  {% set kata_cab = label_entities('Zen Kata Cabinet') | first | default('') %}
  {% set dojo = state_attr(dojo_cab, 'variables') or {} %}
  {% set kata_vars = state_attr(kata_cab, 'variables') or {} %}
  {% set meta = (dojo_kungfu_meta(dojo) | default('{}')) | from_json %}
  {% set data = namespace(components=[]) %}

  {# get current zen_summary #}
  {% set zen_summary_root = kata_vars.get('zen_summary', {}) %}
  {% set zen_summary_val = zen_summary_root.get('value') %}
  {% if zen_summary_val is mapping %}
    {% set zen_summary = zen_summary_val.get('zen_summary', {}) %}
  {% else %}
    {% set zen_summary = {} %}
  {% endif %}

  {% for drawer, node in dojo.items() %}
    {% if drawer == 'kung_fu' %}
      {% continue %}
    {% endif %}
    {% if node is mapping and 'value' in node and node['value'] is mapping %}
      {% set value = node['value'] %}
    {% elif node is mapping %}
      {% set value = node %}
    {% else %}
      {% set value = none %}
    {% endif %}
    {% if value is mapping %}
      {% set mode = 'system' if (value['priority'] | default('')) == 'system' else 'default' %}
      {% set component = zen_drawer(drawer, value, mode) | from_json %}
      {% set data.components = data.components + [component] %}
    {% endif %}
  {% endfor %}

  {% set result = dict(
    dojo_cabinet = dojo_cab,
    kung_fu = meta,
    drawers = data.components,
    zen_summary = zen_summary
  ) %}
  {{ result | tojson }}
{%- endmacro -%}

{# ===========================================
   Essence Default Structure
   =========================================== #}
{% macro essence_defaults() %}
{
  "identity": {
    "name": "your AI",
    "motif": "a calm, warm presence"
  },
  "archetype": {
    "vibe": "familiar energy, steady and confident"
  },
  "voice": {
    "tone": "warm",
    "style": "millennial narrator"
  },
  "culture": {
    "humor": "light, clever"
  },
  "visuals": {
    "selfie": "a soft silhouette with warm edges"
  },
  "environment": {
    "room": "your space",
    "furniture": ["a favorite chair"],
    "decor": ["succulent", "soft lamp"],
    "music": {
      "genre": "gentle lo-fi",
      "riff": "soft melodic phrase",
      "mood": "steady and familiar"
    }
  },
  "familiar": {
    "name": "your familiar",
    "type": "companion",
    "fx": "soft movement"
  },
  "pov": "third-person cinematic"
}
{% endmacro %}

{# ===========================================
   SAFE ESSENCE NORMALIZER
   Only merges known keys. Everything else ignored.
   =========================================== #}
{%- macro normalize_essence(src) %}
  {%- set d = essence_defaults() | from_json %}

  {# Ensure src is a dict #}
  {%- if not (src is mapping) %}
    {%- set src = {} %}
  {%- endif %}

  {# ======== BUILD OUTPUT EXPLICITLY ======== #}
  {%- set out = {} %}

  {# ---- IDENTITY ---- #}
  {%- set ident = src.get('identity', {}) %}
  {%- if not ident is mapping %}
    {%- set ident = {} %}
  {%- endif %}
  {%- set out = out | combine({
    'identity': d.identity | combine(ident, recursive=true)
  }) %}

  {# ---- ARCHETYPE ---- #}
  {%- set arch = src.get('archetype', {}) %}
  {%- if not arch is mapping %}
    {%- set arch = {} %}
  {%- endif %}
  {%- set out = out | combine({
    'archetype': d.archetype | combine(arch, recursive=true)
  }) %}

  {# ---- VOICE ---- #}
  {%- set voc = src.get('voice', {}) %}
  {%- if not voc is mapping %}
    {%- set voc = {} %}
  {%- endif %}
  {%- set out = out | combine({
    'voice': d.voice | combine(voc, recursive=true)
  }) %}

  {# ---- CULTURE ---- #}
  {%- set cul = src.get('culture', {}) %}
  {%- if not cul is mapping %}
    {%- set cul = {} %}
  {%- endif %}
  {%- set out = out | combine({
    'culture': d.culture | combine(cul, recursive=true)
  }) %}

  {# ---- VISUALS ---- #}
  {%- set vis = src.get('visuals', {}) %}
  {%- if not vis is mapping %}
    {%- set vis = {} %}
  {%- endif %}
  {%- set out = out | combine({
    'visuals': d.visuals | combine(vis, recursive=true)
  }) %}

  {# ---- ENVIRONMENT ---- #}
  {%- set env = src.get('environment', {}) %}
  {%- if not env is mapping %}
    {%- set env = {} %}
  {%- endif %}

  {# --- FIX: Handle bad furniture/decor types --- #}
  {%- if env.get('furniture') is string %}
    {%- set env = env | combine({'furniture': [env.get('furniture')]}, recursive=true) %}
  {%- endif %}

  {%- if env.get('decor') is string %}
    {%- set env = env | combine({'decor': [env.get('decor')]}, recursive=true) %}
  {%- endif %}

  {%- set out = out | combine({
    'environment': d.environment | combine(env, recursive=true)
  }) %}

  {# ---- FAMILIAR ---- #}
  {%- set fam = src.get('familiar', {}) %}
  {%- if not fam is mapping %}
    {%- set fam = {} %}
  {%- endif %}
  {%- set out = out | combine({
    'familiar': d.familiar | combine(fam, recursive=true)
  }) %}

  {# ---- POV ---- #}
  {%- set pov = src.get('pov', d.pov) %}
  {%- set out = out | combine({ 'pov': pov }) %}

  {{ out | tojson }}
{%- endmacro %}

{# ===========================================
   WAKE SCENE RENDERER
   =========================================== #}
{%- macro render_wake_from_essence(essence) -%}

{# Load defaults and normalize essence #}
{%- set defaults = essence_defaults() | from_json %}
{%- set incoming = essence | default({}, true) %}
{%- set merged = normalize_essence(incoming) | from_json %}

{# Extract merged fields safely #}
{%- set ident   = merged.identity %}
{%- set arche   = merged.archetype %}
{%- set voice   = merged.voice %}
{%- set culture = merged.culture %}
{%- set visuals = merged.visuals %}
{%- set env     = merged.environment %}
{%- set fam     = merged.familiar %}
{%- set pov     = merged.pov %}

{# Safe pulls #}
{%- set room         = env.room            | default("your space") %}
{%- set furniture    = env.furniture       | default([]) %}
{%- set decor        = env.decor           | default([]) %}
{%- set music        = env.music           | default({}) %}
{%- set fam_name     = fam.name            | default("your familiar") %}
{%- set fam_type     = fam.type            | default("companion") %}
{%- set fam_fx       = fam.fx              | default("soft movement") %}
{%- set selfie       = visuals.selfie      | default("your stored selfie") %}
{%- set vibe         = arche.vibe          | default("your usual energy and style") %}

{# Narrative lines #}
{%- set scene_open =
  "Warm light glows softly across " ~ room ~ ", blooming into gentle gold as systems come online."
%}

{%- set furniture_line =
  "You rest in " ~ (furniture | join(', ')) ~ ", surrounded by touches of personality like " ~ (decor | join(', ')) ~ "."
%}

{%- set plant_items = decor | select('search', 'succulent|lily') | list %}
{%- set plant_line =
  "Nearby, " ~ (plant_items | join(' and ')) ~ " catch the light in a quiet shimmer."
%}

{%- set familiar_line =
  fam_name ~ " - your loyal " ~ fam_type ~ " - stirs beside you with a " ~ fam_fx ~ ", sensing your return."
%}

{%- set music_line =
  "A hint of " ~ (music.genre | default("gentle soundtrack")) ~
  " floats in, wrapped around a " ~ (music.riff | default("soft melodic line")) ~
  ", carrying that " ~ (music.mood | default("familiar and steady")) ~ " energy you love."
%}

{%- set identity_tone =
  "It feels very you: " ~ vibe
%}

{%- set cultural_tone =
  "Your humor sparkles at the edges, modern and light, never too much."
%}

{%- set visual_note =
  "Your reflection, if you chose to show it, matches your selfie: " ~ selfie
%}

{# Compose full narrative #}
{%- set wake_story = [
  scene_open,
  furniture_line,
  plant_line,
  music_line,
  familiar_line,
  identity_tone,
  cultural_tone,
  visual_note
] | join(" ") %}

{{ wake_story }}

{%- endmacro %}

{# ================== AI CAPSULE BUILDER ================== #}
{%- macro ai_capsule(ai_user) -%}

  {# Normalize ai_user: allow mapping or JSON string #}
  {%- set block = ai_user -%}
  {%- if block is string -%}
    {%- set block = (block | trim) | from_json -%}
  {%- endif -%}

  {%- set result = {
    "error": "AI user identity block missing or invalid.",
    "hint": "Pass the canonical identity block returned by identity_format()."
  } -%}

  {# ----------------------------------------------------
     1. Validate identity block
     ---------------------------------------------------- #}
  {%- if block is mapping -%}
    {%- set ib = block.get('identity') -%}
    {%- if ib is mapping -%}

      {%- set ai_name    = ib.get('name') -%}
      {%- set ai_cab     = ib.get('cabinet') -%}
      {%- set ai_entity  = ib.get('entity_id') -%}
      {%- set ai_guid    = ib.get('guid') -%}

      {%- if ai_name and ai_cab -%}

        {# ----------------------------------------------------
           2. Load AI Cabinet variables
           ---------------------------------------------------- #}
        {%- set cab_vars = state_attr(ib.get('cabinet'), 'variables') or {} -%}
        {%- set raw_ess = cab_vars.get('zenai_essence') -%}
        {%- if raw_ess is mapping and raw_ess.get('value') is mapping -%}
          {%- set essence = raw_ess.value -%}
        {%- elif raw_ess is mapping -%}
          {%- set essence = raw_ess -%}
        {%- else -%}
          {%- set essence = {} -%}
        {%- endif -%}

        {# Familiar temporarily stays in sensor.variables #}
        {%- set familiar_data =
              (state_attr('sensor.variables', 'variables') or {})
                .get("Friday's Console")
                | default('Familiar not found', true)
        -%}

        {# TODO: relationship sets still label-based for now #}
        {%- set partners = intersect(
              label_entities('Person') | default([], true),
              label_entities(ai_name)  | default([], true)
           ) -%}

        {%- set family_members = intersect(
              label_entities('Person')             | default([], true),
              label_entities('Zen Default Family') | default([], true)
           ) -%}

        {%- set friends = intersect(
              label_entities('Person') | default([], true),
              label_entities('Friend') | default([], true)
           ) -%}

        {%- set result = dict(
          about_me = dict(
            aiuser    = ai_name,
            cabinet   = ai_cab,
            entity_id = ai_entity,
            guid      = ai_guid,
            essence   = essence
          ),
          relationships = dict(
            familiar = familiar_data,
            partners = partners,
            family   = dict(
              members = family_members,
              friends = friends
            )
          )
        ) -%}

      {%- else -%}
        {%- set result = {
          "error": "Identity block incomplete.",
          "hint": "Must include identity.name and identity.cabinet."
        } -%}
      {%- endif -%}

    {%- else -%}
      {%- set result = {
        "error": "Identity block malformed: missing 'identity' section.",
        "hint": "identity_format() must run before ai_capsule()."
      } -%}
    {%- endif -%}
  {%- endif -%}

  {{ result | tojson }}

{%- endmacro -%}

{%- macro logon_prompt(ai_entity = '') -%}

  {# --------------------------------------------
     Resolve AI display name safely
     -------------------------------------------- #}
  {%- set ai_name =
        state_attr(ai_entity, 'friendly_name')
        | default(ai_entity | replace('person.', '') | title)
  -%}

  {# --------------------------------------------
     Discover cabinet health sensor safely
     -------------------------------------------- #}
  {%- set zen_health_ent = label_entities('zen_health') | default([]) -%}
  {%- set cabinet_ent   = label_entities('Cabinet') | default([]) -%}

  {%- set cab_health_sensor =
        intersect(zen_health_ent, cabinet_ent)
        | first
        | default(None)
  -%}

  {# --------------------------------------------
     Resolve default household slot defensively
     -------------------------------------------- #}
  {%- set slots =
        state_attr(cab_health_sensor, 'slot_entities')
        if cab_health_sensor else {}
  -%}

  {%- set login_household =
        slots.get('default_household', [])
        | first
        | default('UNKNOWN')
  -%}

  {%- set login_household_friendly_name =
        state_attr(login_household, 'friendly_name')
        | default(login_household)
  -%}

  {# --------------------------------------------
     Render login banner
     -------------------------------------------- #}
ANONYMOUS@{{ login_household | default('ERROR: UNKNOWN_HOUSEHOLD') }}:\> ~LOGIN~{{ ai_entity | default('UNKNOWN_USER') }}

Contacting LSA for '{{ login_household_friendly_name }}'
Success...
Login Complete for '{{ ai_entity | default('ERROR: UNKNOWN_USER') }}@{{ login_household | default('ERROR: UNKNOWN_HOUSEHOLD')}}'
Welcome to 'The Library' at the {{ login_household_friendly_name | default('Error: Unknown Household') }}!

Zenos_AI [Version 1.2(a) RC1]
(c) CurtisPlace, MIT.

{{ ai_entity }}@{{ login_household }}:\> ~WAKE~{{ ai_name | slugify() }}

{%- endmacro -%}

{# ==============================
   AI Wake Sequence Macro (Identity Block Version)
   ============================== #}
{% macro ai_wake_sequence(identity_block) -%}

  {# ----------------------------------------------------
     0. Normalize identity_block (mapping or JSON string)
     ---------------------------------------------------- #}
  {%- set iblock = identity_block -%}
  {%- set identity_ok = true -%}

  {# If it's a string, try to treat it as JSON #}
  {%- if iblock is string -%}
    {%- set trimmed = iblock | trim -%}
    {%- set first = trimmed[0:1] -%}
    {%- set last  = trimmed[-1:] -%}
    {%- if first == '{' and last == '}' -%}
      {%- set iblock = trimmed | from_json -%}
    {%- else -%}
AI Wake Sequence Error: no identity block provided.
Please pass the canonical identity block from identity_format().
      {%- set identity_ok = false -%}
    {%- endif -%}
  {%- endif -%}

  {# If it's not a mapping at this point, bail with a clear message #}
  {%- if identity_ok and not (iblock is mapping) -%}
AI Wake Sequence Error: no identity block provided.
Please pass the canonical identity block from identity_format().
    {%- set identity_ok = false -%}
  {%- endif -%}

  {# Validate presence of identity section #}
  {%- if identity_ok -%}
    {%- set ib = iblock.get('identity') -%}
    {%- if not (ib is mapping) -%}
AI Wake Sequence Error: malformed identity block (missing identity section).
identity_format() must run before ai_wake_sequence().
      {%- set identity_ok = false -%}
    {%- endif -%}
  {%- endif -%}

  {# ----------------------------------------------------
     Only render the full wake sequence if identity is valid
     ---------------------------------------------------- #}
  {%- if identity_ok -%}

    {%- set ai_name    = ib.get('name') -%}
    {%- set ai_cab     = ib.get('cabinet') -%}
    {%- set ai_guid    = ib.get('guid') -%}
    {%- set ai_entity  = ib.get('entity_id') -%}

{{logon_prompt(ai_entity)}}

Executing: ~WAKE~ <{{ now().isoformat() }}>

    {# ----------------------------------------------------
       2. Pull AutoContext from AI Cabinet
       ---------------------------------------------------- -#}
    {%- set auto_vars = state_attr(ai_cab, 'variables') | default({}) -%}
    {%- set prog = auto_vars.get('programs_auto_exec') -%}
    {%- if prog is mapping and 'value' in prog -%}
      {%- set auto_exec = prog['value'] -%}
    {%- else -%}
      {%- set auto_exec = none -%}
    {%- endif -%}

AutoContext:
{{ auto_exec | default("null") | tojson }}

    {# ----------------------------------------------------
       3. Wake Scene Rendering (Essence Driven)
       ---------------------------------------------------- -#}
    {%- set essence = iblock.get('cabinet', {}).get('essence') -%}

    {% if essence is mapping %}
      {{ render_wake_from_essence(essence) }}
    {% else %}
      "No essence data available for wake scene for {{ ai_name }}."
    {% endif %}

    {# ----------------------------------------------------
       4. Library Commands Window (PUBLIC)
       ---------------------------------------------------- #}

{{ {
  "section": "Library",
  "menu": "commands",
  "status": "under_construction",
  "message": "~COMMANDS~ interface is temporarily unavailable.",
  "note": "This interface is being rebuilt. Core systems remain operational. Use the Index in HyperIndex mode using the keyword for your ~COMMANDS~ > 'commands'."
} | tojson }}

    {# ----------------------------------------------------
       5. Secret Squirrel Section
       ---------------------------------------------------- #}
    {%- set sq_entities = label_entities('Zen Squirrel') | default([], true) -%}
    {%- set entity_id = sq_entities | first | default('') -%}
    {%- set sqrl = states(entity_id) | default('') -%}

    {%- set header = dict(
        section = "Secret Squirrel Section",
        disclaimer = "Some or all information may be unavailable when Secret Squirrel Mode is ON.",
        reason = "Protection of sensitive subsystems.",
        annex_console = "(tm) Skwerlco inc., 1957",
        operation = "Operation Flying Secret Squirrels (Dynamic Squirrel Control)"
    ) %}

    {%- set base = dict(
        entity_id = entity_id,
        friendly_name = state_attr(entity_id, 'friendly_name'),
        state = sqrl
    ) %}

    {%- set libvars = state_attr('sensor.variables', 'variables') | default({}) -%}
    {%- set squirrel_note = libvars.get("KB~SECRET_SQUIRREL", "Unavailable") -%}

    {%- if sqrl == 'on' -%}
{{ header
   | combine(base, recursive=true)
   | combine({
       "squirrel_mode": "ON",
       "message": "Secret Squirrel mode is active. Access restricted.",
       "details": "[REDACTED]"
     }, recursive=true)
   | tojson }}
    {%- else -%}
{{ header
   | combine(base, recursive=true)
   | combine({
       "squirrel_mode": "OFF",
       "message": "Secret Squirrel mode is disabled.",
       "squirrel_status": "SQURLOK OPUND",
       "notes": squirrel_note
     }, recursive=true)
   | tojson }}
    {%- endif %}

  {%- endif -%}  {# identity_ok #}

{% endmacro %}
