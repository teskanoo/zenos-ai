{# =====================================================================
   ZenOS-AI - Zen Query Engine (ZQ-1)
   Version: 1.3.4 RC1 (Paging + Numeric Sort)
   ===================================================================== #}

{%- macro zen_filter(filter_json, entity_list) -%}

  {# --- 0. Parse filter JSON safely ----------------------------------- #}
  {%- set f = filter_json | from_json if filter_json is string else filter_json -%}

  {%- set domain         = f.get('domain') %}
  {%- set label          = f.get('label') %}
  {%- set area           = f.get('area') %}
  {%- set device_id      = f.get('device_id') %}
  {%- set device_class   = f.get('device_class') %}
  {%- set state_equals   = f.get('state_equals') %}
  {%- set include_states = f.get('include_states', []) %}
  {%- set exclude_states = f.get('exclude_states', []) %}
  {%- set num_above      = f.get('numeric_above') %}
  {%- set num_below      = f.get('numeric_below') %}
  {%- set regex          = f.get('regex') %}
  {%- set sort_spec      = f.get('sort', {}) %}

  {# normalize shortcuts ----------------------------------------------- #}
  {%- set sc_raw = f.get('shortcuts') %}
  {%- if sc_raw is mapping %}
    {%- set sc = sc_raw %}
  {%- else %}
    {%- set sc = {} %}
  {%- endif %}

  {# --- 1. Normalize entity_list --------------------------------------- #}
  {%- set raw = entity_list | default([]) %}
  {%- set pipe = namespace(ids=[]) %}

  {%- if raw is string %}
    {%- set pipe.ids = [raw] %}
  {%- elif raw is iterable %}
    {%- set pipe.ids = raw | list %}
  {%- else %}
    {%- set pipe.ids = [] %}
  {%- endif %}

  {# --- 2. Auto-build from domain if needed ---------------------------- #}
  {%- if (pipe.ids | count == 0) and domain %}
    {%- set pipe.ids = states[domain] | map(attribute='entity_id') | list %}
  {%- endif %}

  {# --- 3. Domain filter ----------------------------------------------- #}
  {%- if domain %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if ent is string and ent.startswith(domain ~ '.') %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# --- 4. Label filter ------------------------------------------------- #}
  {%- if label %}
    {%- set normalized = label | slugify %}
    {%- set labeled = label_entities(normalized) | list %}
    {%- set pipe.ids = pipe.ids | intersect(labeled) %}
  {%- endif %}

  {# --- 4a. Area filter ------------------------------------------------- #}
  {%- if area %}
    {%- set normalized = area | slugify %}
    {%- set aid = area_id(normalized) %}
    {%- if aid %}
      {%- set aread = area_entities(aid) | list %}
      {%- set pipe.ids = pipe.ids | intersect(aread) %}
    {%- endif %}
  {%- endif %}

  {# --- 4b. Device filter ---------------------------------------------- #}
  {%- if device_id %}
    {%- set normalized = device_id | slugify %}
    {%- set did = device_id(normalized) %}
    {%- if did %}
      {%- set device_ents = device_entities(did) | list %}
      {%- set pipe.ids = pipe.ids | intersect(device_ents) %}
    {%- endif %}
  {%- endif %}

  {# --- 5. Device class filter ----------------------------------------- #}
  {%- if device_class %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if state_attr(ent, 'device_class') == device_class %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# --- 6. State equals filter ----------------------------------------- #}
  {%- if state_equals %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if states(ent) == state_equals %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# --- 7. Include states filter --------------------------------------- #}
  {%- if include_states %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if states(ent) in include_states %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# --- 8. Exclude states ---------------------------------------------- #}
  {%- if exclude_states %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if states(ent) not in exclude_states %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# --- 9. Numeric filters --------------------------------------------- #}
  {%- if num_above is not none or num_below is not none %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- set val = states(ent) | float(none) %}
      {%- if val is not none %}
        {%- set ok = true %}
        {%- if num_above is not none and val <= num_above %}
          {%- set ok = false %}
        {%- endif %}
        {%- if num_below is not none and val >= num_below %}
          {%- set ok = false %}
        {%- endif %}
        {%- if ok %}
          {%- set new.list = new.list + [ent] %}
        {%- endif %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# --- 10. Regex on state --------------------------------------------- #}
  {%- if regex %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- set s = states(ent) %}
      {%- if s is string and s is regex(regex) %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# =====================================================================
     11. SHORTCUTS — Core + Extras Pack
     ===================================================================== #}

  {# 11.0 numeric shortcut ---------------------------------------------- #}
  {%- if sc.get('numeric') %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if states(ent) | float(none) is not none %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# 11.1 stats-eligible ------------------------------------------------ #}
  {%- if sc.get('stats') %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if state_attr(ent,'state_class') is not none %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# 11.2 temp ----------------------------------------------------------- #}
  {%- if sc.get('temp') %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if state_attr(ent,'device_class') == 'temperature' %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# 11.3 humidity ------------------------------------------------------- #}
  {%- if sc.get('humidity') %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if state_attr(ent,'device_class') == 'humidity' %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# 11.4 power ---------------------------------------------------------- #}
  {%- if sc.get('power') %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if state_attr(ent,'device_class') == 'power' %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# 11.5 energy --------------------------------------------------------- #}
  {%- if sc.get('energy') %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if state_attr(ent,'device_class') == 'energy' %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# 11.6 water ---------------------------------------------------------- #}
  {%- if sc.get('water') %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if state_attr(ent,'device_class') == 'moisture' %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# 11.7 binary sensors ------------------------------------------------- #}
  {%- if sc.get('binary') %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if ent.startswith('binary_sensor.') %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# =====================================================================
     11.S — SHORTCUT PACK DELUXE
     ===================================================================== #}

  {# first_n ------------------------------------------------------------ #}
  {%- if sc.get('first_n') %}
    {%- set n = sc.get('first_n') | int %}
    {%- set pipe.ids = pipe.ids[0:n] %}
  {%- endif %}

  {# last_n ------------------------------------------------------------- #}
  {%- if sc.get('last_n') %}
    {%- set n = sc.get('last_n') | int %}
    {%- set pipe.ids = pipe.ids[-n:] %}
  {%- endif %}

  {# top_n (requires explicit sort) ------------------------------------ #}
  {%- if sc.get('top_n') %}
    {%- set n = sc.get('top_n') | int %}
    {%- set pipe.ids = pipe.ids[0:n] %}
  {%- endif %}

  {# bottom_n ----------------------------------------------------------- #}
  {%- if sc.get('bottom_n') %}
    {%- set n = sc.get('bottom_n') | int %}
    {%- set pipe.ids = pipe.ids[-n:] %}
  {%- endif %}

  {# top_by_numeric ----------------------------------------------------- #}
  {%- if sc.get('top_by_numeric') %}
    {%- set n = sc.get('top_by_numeric') | int %}
    {%- set objs = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- set objs.list = objs.list + [{'eid': ent, 'val': states(ent)|float(none)}] %}
    {%- endfor %}
    {%- set sorted = objs.list
       | selectattr('val','!=',none)
       | list
       | sort(attribute='val', reverse=true) %}
    {%- set pipe.ids = (sorted|map(attribute='eid')|list)[0:n] %}
  {%- endif %}

  {# bottom_by_numeric -------------------------------------------------- #}
  {%- if sc.get('bottom_by_numeric') %}
    {%- set n = sc.get('bottom_by_numeric') | int %}
    {%- set objs = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- set objs.list = objs.list + [{'eid': ent, 'val': states(ent)|float(none)}] %}
    {%- endfor %}
    {%- set sorted = objs.list
       | selectattr('val','!=',none)
       | list
       | sort(attribute='val', reverse=false) %}
    {%- set pipe.ids = (sorted|map(attribute='eid')|list)[0:n] %}
  {%- endif %}

  {# top_by_state ------------------------------------------------------- #}
  {%- if sc.get('top_by_state') %}
    {%- set n = sc.get('top_by_state') | int %}
    {%- set objs = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- set objs.list = objs.list + [{'eid': ent, 'st': states(ent)}] %}
    {%- endfor %}
    {%- set sorted = objs.list | sort(attribute='st', reverse=true) %}
    {%- set pipe.ids = (sorted|map(attribute='eid')|list)[0:n] %}
  {%- endif %}

  {# bottom_by_state ---------------------------------------------------- #}
  {%- if sc.get('bottom_by_state') %}
    {%- set n = sc.get('bottom_by_state') | int %}
    {%- set objs = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- set objs.list = objs.list + [{'eid': ent, 'st': states(ent)}] %}
    {%- endfor %}
    {%- set sorted = objs.list | sort(attribute='st', reverse=false) %}
    {%- set pipe.ids = (sorted|map(attribute='eid')|list)[0:n] %}
  {%- endif %}

  {# random_n ----------------------------------------------------------- #}
  {%- if sc.get('random_n') %}
    {%- set n = sc.get('random_n') | int %}
    {%- set pipe.ids = (pipe.ids | shuffle)[0:n] %}
  {%- endif %}

  {# distinct ------------------------------------------------------------ #}
  {%- if sc.get('distinct') %}
    {%- set seen = namespace(list=[]) %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if ent not in seen.list %}
        {%- set seen.list = seen.list + [ent] %}
        {%- set new.list  = new.list  + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# unique_domains ----------------------------------------------------- #}
  {%- if sc.get('unique_domains') %}
    {%- set doms = namespace(list=[]) %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- set d = ent.split('.')[0] %}
      {%- if d not in doms.list %}
        {%- set doms.list = doms.list + [d] %}
        {%- set new.list  = new.list  + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# unique_devices ----------------------------------------------------- #}
  {%- if sc.get('unique_devices') %}
    {%- set devs = namespace(list=[]) %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- set d = device_id(ent) %}
      {%- if d and (d not in devs.list) %}
        {%- set devs.list = devs.list + [d] %}
        {%- set new.list  = new.list  + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list %}
  {%- endif %}

  {# limit_by_device_class --------------------------------------------- #}
  {%- if sc.get('limit_by_device_class') %}
    {%- set cfg = sc.get('limit_by_device_class') %}
    {%- set target_class = cfg.get('class') %}
    {%- set n = cfg.get('n', 5) | int %}
    {%- set new = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- if state_attr(ent,'device_class') == target_class %}
        {%- set new.list = new.list + [ent] %}
      {%- endif %}
    {%- endfor %}
    {%- set pipe.ids = new.list[0:n] %}
  {%- endif %}

  {# =====================================================================
     12. SORTING
     ===================================================================== #}

  {%- set sort_by    = sort_spec.get('by') %}
  {%- set sort_order = sort_spec.get('order','asc') %}

  {%- if sort_by == 'entity_id' %}
    {%- set pipe.ids = pipe.ids | sort(reverse=(sort_order=='desc')) %}

  {%- elif sort_by == 'state' %}
    {%- set objs = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- set objs.list = objs.list + [{'eid': ent, 'st': states(ent)}] %}
    {%- endfor %}
    {%- set sorted = objs.list | sort(attribute='st', reverse=(sort_order=='desc')) %}
    {%- set pipe.ids = sorted | map(attribute='eid') | list %}

  {%- elif sort_by == 'numeric_state' %}
    {%- set objs = namespace(list=[]) %}
    {%- for ent in pipe.ids %}
      {%- set objs.list = objs.list + [{'eid': ent, 'val': states(ent)|float(none)}] %}
    {%- endfor %}
    {%- set sorted = objs.list
       | selectattr('val','!=',none)
       | list
       | sort(attribute='val', reverse=(sort_order=='desc')) %}
    {%- set pipe.ids = sorted | map(attribute='eid') | list %}
  {%- endif %}

  {# =====================================================================
     12b. PAGING — offset + limit
     ===================================================================== #}

  {%- set limit  = f.get('limit') %}
  {%- set offset = f.get('offset', 0) %}

  {%- if limit is number %}
    {%- set start = offset | int %}
    {%- set end   = start + (limit | int) %}
    {%- set pipe.ids = pipe.ids[start:end] %}
  {%- elif offset is number %}
    {%- set start = offset | int %}
    {%- set pipe.ids = pipe.ids[start:] %}
  {%- endif %}

  {# =====================================================================
     13. RETURN
     ===================================================================== #}
  {{ pipe.ids | tojson }}

{%- endmacro -%}

{% macro zen_query_help() %}
{{
  {
    "tool": "Zen DojoTools Query (ZQ-1)",
    "version": "1.3.4 RC1",
    "overview":
      "ZQ-1 is a deterministic, multi-stage, HA-safe entity filtering engine. It consumes flexible JSON filter definitions and produces a fully-evaluated list of entity_ids. Each stage applies conjunctively (logical AND), narrowing the working set. ZQ-1 never mutates state, never guesses, never throws template errors, and never performs unsafe Python operations.",

    "philosophy":
      "ZQ-1 behaves like a database WHERE clause for Home Assistant: explicit, strict, predictable. It avoids ambiguity, avoids implicit inference, and avoids side-effects. All expansions are intentional (domain auto-build). All reductions are explicit or shortcut-driven. Every decision is explainable and reproducible.",

    "input_behavior": {
      "accepted_inputs":
        "• null\n• a single entity_id string\n• a list of entity_ids\n• any iterable (converted to list)\n• a JSON object describing filters",
      "normalization_rules":
        "• null → []\n• string → [string]\n• iterable → list(iterable)\n• non-iterable scalar → []",
      "initialization_pipeline":
        "1. Normalize entity_list\n2. If empty AND domain provided → auto-expand from states[domain]\n3. Sequentially apply filters (each narrows pipe.ids)\n4. Apply shortcuts (late-stage narrowing)\n5. Apply sorting\n6. Apply paging (offset + limit)"
    },

    "fields": {
      "domain":
        "Restricts or auto-builds the set. If entity_list is empty, ZQ-1 expands using states[domain]. If entity_list is non-empty, ZQ-1 keeps only entity_ids starting with domain+'.'.",

      "label":
        "PURE intersection with label_entities(slugified_label). No expansion, no guessing.",

      "area":
        "Slugify → area_id() → area_entities() → intersect.",

      "device_id":
        "Slugify → device_id() → device_entities() → intersect.",

      "device_class":
        "Retain only entities whose device_class attribute matches exactly.",

      "state_equals":
        "Retain only entities whose state string matches this value.",

      "include_states":
        "Retain only entities whose state is in the provided list.",

      "exclude_states":
        "Drop any entity whose state is in the provided list.",

      "numeric_above":
        "Retain only entities whose state cleanly converts to float() AND value > threshold.",

      "numeric_below":
        "Retain only entities whose numeric value < threshold.",

      "regex":
        "Apply HA’s `is regex()` test to state strings. Non-string values are skipped safely.",

      "shortcuts": {
        "numeric":
          "Retains only entities whose states are valid numeric floats.",
        "stats":
          "Retains only entities publishing a state_class attribute.",
        "temp":
          "Retains only device_class=='temperature'.",
        "humidity":
          "Retains only device_class=='humidity'.",
        "power":
          "Retains only device_class=='power'.",
        "energy":
          "Retains only device_class=='energy'.",
        "water":
          "Retains only device_class=='moisture'.",
        "binary":
          "Retains only entity_ids beginning with 'binary_sensor.'.",
        "stats_eligible":
          "Retains only entities that meet ALL:\n"
          "  • numeric state\n"
          "  • state_class present\n"
          "  • unit_of_measurement present\n"
          "  • disabled_by is none\n",

        "first_n":
          "Return first N items of the current working set.",
        "last_n":
          "Return last N items of the working set.",
        "top_n":
          "After sorting, return first N items.",
        "bottom_n":
          "After sorting, return last N items.",

        "top_by_numeric":
          "Sort descending by numeric state → take N.",
        "bottom_by_numeric":
          "Sort ascending by numeric state → take N.",
        "top_by_state":
          "Sort descending by state string → take N.",
        "bottom_by_state":
          "Sort ascending by state string → take N.",

        "random_n":
          "Shuffle → take N (HA shuffle filter).",

        "distinct":
          "Dedupe while preserving order.",

        "unique_domains":
          "Keep only the first entity encountered for each unique domain.",

        "unique_devices":
          "Keep only the first entity for each unique device_id.",

        "limit_by_device_class":
          "Filter by device_class → take first N of remaining items."
      },

      "sort": {
        "by": 
          "Sort key — 'entity_id', 'state', or 'numeric_state'.\n"
          "'numeric_state' safely float-parses states and drops non-numerics.",
        "order":
          "'asc' or 'desc'. Defaults to ascending."
      },

      "limit":
        "Return only the first N items *after* sorting and shortcuts.",

      "offset":
        "Skip the first N items *before* limit is applied."
    },

    "filter_execution_model":
      "ZQ-1 is strictly sequential:\n"
      "  1. Normalize\n"
      "  2. Auto-build (domain)\n"
      "  3. Explicit filters (AND)\n"
      "  4. Shortcuts (AND)\n"
      "  5. Sorting\n"
      "  6. Paging (offset & limit)\n\n"
      "Shortcuts never expand — they only reduce. paging never changes order — it only windows. All operations are HA-safe, list-based, and fully deterministic.",

    "error_handling":
      "• float conversion failure → skip\n"
      "• missing attributes → skip\n"
      "• regex against non-string → skip\n"
      "• unresolved area/device/label → empty intersection\n"
      "• zero-entity pipelines are valid\n"
      "• no exceptions are thrown\n"
      "ZQ-1 is designed to be safe inside Home Assistant's restricted Jinja sandbox.",

    "return_value":
      "Always returns a JSON array of entity_ids (string).",

    "examples": {
      "find_all_lights_on":
        "{'domain':'light', 'state_equals':'on'}",

      "living_room_motion_binary_sensors":
        "{'area':'living room', 'shortcuts':{'binary': true}}",

      "high_temperature":
        "{'shortcuts':{'temp': true}, 'numeric_above': 78}",

      "washing_machine_power_spike":
        "{'label':'laundry', 'shortcuts':{'power': true}, 'numeric_above': 500}",

      "all_stats_eligible_in_kitchen":
        "{'area':'kitchen', 'shortcuts':{'stats_eligible': true}}",

      "regex_match_for_heating_modes":
        "{'domain':'climate', 'regex':'heat|on|aux'}",

      "top_5_hottest":
        "{'sort':{'by':'numeric_state','order':'desc'}, 'limit':5}",

      "bottom_3_humidity":
        "{'shortcuts':{'humidity':true}, 'sort':{'by':'numeric_state'}, 'limit':3}"
    },

    "usage_instructions":
      "1. Build a JSON object describing filters.\n"
      "2. Pass it to: zen_filter(<filter_json>, <entity_list>)\n"
      "3. Use null for <entity_list> to force domain auto-build.\n"
      "4. Use shortcuts for common semantic groupings.\n"
      "5. Use sorting + limit/offset for paging and top/bottom queries.\n"
      "6. Output is authoritative and idempotent.\n"
      "7. ZQ-1 operates ONLY on current state/attributes — no history."
  }
  | tojson
}}
{% endmacro %}

