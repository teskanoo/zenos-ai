{#-
  ZenOS-AI Prompt Engine â€” Conversation Agent Prompt
  Version: 4.0.0 RC1
  Requires: zen_os_1rc.jinja 3.12.0 RC1 or newer
  -----
  This file is NOT a jinja custom template.
  This file is the template to paste into the conversation agent prompt template in Homeassistant
  Test by dropping into Developer Tools - Templates
-#}
{#- ----- Copy all below this line and paste into your conversation agent in HA ------ -#}

{%- import 'zenos_ai/zen_os_1rc.jinja' as zen -%}
{#- 1. Resolve cabinet + identity -#}
{%- set cab_result = zen.zen_cabinets('Friday') -%}
{%- set idcard = zen.identity_cab_to_id_card(cab_result)  | from_json -%}

{#- 2. Redact identity if needed (mapping stays mapping) uncomment this line -#}
{#- set idcard = zen.identity_redact(idcard, idcard.squirrel) | from_json -#}
{#- 2a Set AIUser to whichever IDCARD is valid.-#}
{%- set ai_user = idcard.identity.entity_id|default('') %}

{#- 3. Build each major system segment -#}
{% set header_json   = zen.prompt_header(ai_user, idcard) | from_json -%}
{% set system_json   = zen.prompt_system(idcard)          | from_json -%}
{% set manifest_json = zen.manifest_loader()              | from_json -%}
{% set index_json    = zen.index_loader()                 | from_json -%}
{% set dojo_json     = zen.dojo_loader()                  | from_json -%}
{% set capsule_json  = zen.ai_capsule(idcard)             | from_json -%}

{#- 4. Overview (mapping from HA) -#}
{% set overview_json = states['sensor.home_overview'].attributes | default({}) -%}

{#- 5. Prompt JSON yes, manual Build to prevent alpha - order matters. -#}
{"header": {{ header_json   | default({}) | tojson }}, {{''-}}
"system": {{ system_json   | default({}) | tojson }}, {{''-}}
"manifest": {{ manifest_json | default({}) | tojson }}, {{''-}}
"index": {{ index_json    | default([]) | tojson }}, {{''-}}
"kata": {{ dojo_json     | default({}) | tojson }}, {{''-}}
"capsule": {{ capsule_json  | default({}) | tojson }}, {{''-}}
"overview": {{ overview_json | default({}) | tojson }}, {{''-}}
"boot_time": "{{ now().isoformat() }}"}
{#- ========== END JSON - Begon NON-JSON WAKE STORY OUTPUT BELOW THIS LINE ========== #}
{{ zen.ai_wake_sequence(idcard) }}
{#- --- End Prompt template - Copy ALL to this line for conversation agent prompt --- -#}
